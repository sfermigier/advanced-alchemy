<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sqlalchemy.orm.session - Docs</title>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="shortcut icon" href="../../../_static/logo.png"/><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=28c32440" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=ee381b95" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=bf5addad" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:245, 0, 87;--sy-rc-bg:0, 0, 0;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#f50057;--sy-c-bg-weak:#000000;--sy-c-text:#ebdddd;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#ebdddd;--sy-c-foot-bg:#000000;--sy-c-foot-divider:#f50057;
  }
}
html.light {
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
}
html.dark {
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:0, 0, 0;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#f50057;--sy-c-bg-weak:#000000;--sy-c-text:#ebdddd;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#ebdddd;--sy-c-foot-bg:#000000;--sy-c-foot-divider:#f50057;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.session"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="announcement">
    <div class="announcement-inner">
      <p>This documentation is currently under development.</p>
      <button class="announcement-close" aria-label="Close announcement">
        <i class="i-icon close"></i>
      </button>
    </div>
  </div><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="/">
      <img class="light-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <img class="dark-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav">

<ul><li class="link">
          <a href="https://advanced-alchemy.jolt.rs"><span>Home</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://docs.advanced-alchemy.jolt.rs"><span>Docs</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://github.com/jolt-org/advanced-alchemy"><span>Code</span><i class="i-icon external-link"></i></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading"><span class="caption-text">Advanced Alchemy Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/placeholder.html">Placeholder</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/index.html">asyncio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/script-py.html">script.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/sync/index.html">sync</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/script-py.html">script.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/cli.html">cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/index.html">plugins</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/serialization.html">serialization</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/plugin.html">plugin</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/asyncio.html">asyncio</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/common.html">common</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/engine.html">engine</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/sync.html">sync</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/types.html">types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/jolt-org/advanced-alchemy"
  data-type="github" data-user="jolt-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-2xl">
    <i class="i-icon github"></i>
  </span>
  <span class="flex-grow px-2">
    <span>jolt-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <i class="i-icon star"></i>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <i class="i-icon git-fork"></i>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../../index.html">advanced_alchemy</a><span>/</span></li>
      
      <li><a href="../../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sqlalchemy.orm.session</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.session</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="c1"># orm/session.py</span>
</span><span id="1-2"><span class="c1"># Copyright (C) 2005-2023 the SQLAlchemy authors and contributors</span>
</span><span id="1-3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span id="1-4"><span class="c1">#</span>
</span><span id="1-5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span id="1-6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span id="1-7">
</span><span id="1-8"><span class="sd">&quot;&quot;&quot;Provides the Session class and related utilities.&quot;&quot;&quot;</span>
</span><span id="1-9">
</span><span id="1-10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="1-11">
</span><span id="1-12"><span class="kn">import</span> <span class="nn">contextlib</span>
</span><span id="1-13"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span><span id="1-14"><span class="kn">import</span> <span class="nn">itertools</span>
</span><span id="1-15"><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="1-16"><span class="kn">import</span> <span class="nn">typing</span>
</span><span id="1-17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span id="1-20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span>
</span><span id="1-22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
</span><span id="1-24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="1-25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
</span><span id="1-26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>
</span><span id="1-28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</span><span id="1-30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-31"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-32"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-33"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span id="1-34"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-35"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span id="1-36">
</span><span id="1-37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span id="1-38"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">bulk_persistence</span>
</span><span id="1-39"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">context</span>
</span><span id="1-40"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">descriptor_props</span>
</span><span id="1-41"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span id="1-42"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">identity</span>
</span><span id="1-43"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">loading</span>
</span><span id="1-44"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">query</span>
</span><span id="1-45"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">state</span> <span class="k">as</span> <span class="n">statelib</span>
</span><span id="1-46"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span id="1-47"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">insp_is_mapper</span>
</span><span id="1-48"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_composite_class</span>
</span><span id="1-49"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_orm_option</span>
</span><span id="1-50"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">is_user_defined_option</span>
</span><span id="1-51"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_class_to_mapper</span>
</span><span id="1-52"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_none_set</span>
</span><span id="1-53"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_state_mapper</span>
</span><span id="1-54"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">instance_str</span>
</span><span id="1-55"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">LoaderCallableStatus</span>
</span><span id="1-56"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">object_mapper</span>
</span><span id="1-57"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">object_state</span>
</span><span id="1-58"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">PassiveFlag</span>
</span><span id="1-59"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">state_str</span>
</span><span id="1-60"><span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">FromStatement</span>
</span><span id="1-61"><span class="kn">from</span> <span class="nn">.context</span> <span class="kn">import</span> <span class="n">ORMCompileState</span>
</span><span id="1-62"><span class="kn">from</span> <span class="nn">.identity</span> <span class="kn">import</span> <span class="n">IdentityMap</span>
</span><span id="1-63"><span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">Query</span>
</span><span id="1-64"><span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>
</span><span id="1-65"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChange</span>
</span><span id="1-66"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChangeState</span>
</span><span id="1-67"><span class="kn">from</span> <span class="nn">.state_changes</span> <span class="kn">import</span> <span class="n">_StateChangeStates</span>
</span><span id="1-68"><span class="kn">from</span> <span class="nn">.unitofwork</span> <span class="kn">import</span> <span class="n">UOWTransaction</span>
</span><span id="1-69"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">engine</span>
</span><span id="1-70"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">sa_exc</span>
</span><span id="1-71"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">sql</span>
</span><span id="1-72"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span id="1-73"><span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Connection</span>
</span><span id="1-74"><span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Engine</span>
</span><span id="1-75"><span class="kn">from</span> <span class="nn">..engine.util</span> <span class="kn">import</span> <span class="n">TransactionalContext</span>
</span><span id="1-76"><span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">dispatcher</span>
</span><span id="1-77"><span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">EventTarget</span>
</span><span id="1-78"><span class="kn">from</span> <span class="nn">..inspection</span> <span class="kn">import</span> <span class="n">inspect</span>
</span><span id="1-79"><span class="kn">from</span> <span class="nn">..inspection</span> <span class="kn">import</span> <span class="n">Inspectable</span>
</span><span id="1-80"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">coercions</span>
</span><span id="1-81"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">dml</span>
</span><span id="1-82"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">roles</span>
</span><span id="1-83"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">Select</span>
</span><span id="1-84"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">TableClause</span>
</span><span id="1-85"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">visitors</span>
</span><span id="1-86"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span id="1-87"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">CompileState</span>
</span><span id="1-88"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Table</span>
</span><span id="1-89"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">ForUpdateArg</span>
</span><span id="1-90"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">LABEL_STYLE_TABLENAME_PLUS_COL</span>
</span><span id="1-91"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">IdentitySet</span>
</span><span id="1-92"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Literal</span>
</span><span id="1-93"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Protocol</span>
</span><span id="1-94">
</span><span id="1-95"><span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-96">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_EntityType</span>
</span><span id="1-97">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_IdentityKeyType</span>
</span><span id="1-98">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_InstanceDict</span>
</span><span id="1-99">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">OrmExecuteOptionsParameter</span>
</span><span id="1-100">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ORMOption</span>
</span><span id="1-101">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">UserDefinedOption</span>
</span><span id="1-102">    <span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span id="1-103">    <span class="kn">from</span> <span class="nn">.path_registry</span> <span class="kn">import</span> <span class="n">PathRegistry</span>
</span><span id="1-104">    <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">RowReturningQuery</span>
</span><span id="1-105">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">CursorResult</span>
</span><span id="1-106">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Result</span>
</span><span id="1-107">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">Row</span>
</span><span id="1-108">    <span class="kn">from</span> <span class="nn">..engine</span> <span class="kn">import</span> <span class="n">RowMapping</span>
</span><span id="1-109">    <span class="kn">from</span> <span class="nn">..engine.base</span> <span class="kn">import</span> <span class="n">Transaction</span>
</span><span id="1-110">    <span class="kn">from</span> <span class="nn">..engine.base</span> <span class="kn">import</span> <span class="n">TwoPhaseTransaction</span>
</span><span id="1-111">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_CoreAnyExecuteParams</span>
</span><span id="1-112">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_CoreSingleExecuteParams</span>
</span><span id="1-113">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">_ExecuteOptions</span>
</span><span id="1-114">    <span class="kn">from</span> <span class="nn">..engine.interfaces</span> <span class="kn">import</span> <span class="n">CoreExecuteOptionsParameter</span>
</span><span id="1-115">    <span class="kn">from</span> <span class="nn">..engine.result</span> <span class="kn">import</span> <span class="n">ScalarResult</span>
</span><span id="1-116">    <span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">_InstanceLevelDispatch</span>
</span><span id="1-117">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_ColumnsClauseArgument</span>
</span><span id="1-118">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_InfoType</span>
</span><span id="1-119">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T0</span>
</span><span id="1-120">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T1</span>
</span><span id="1-121">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T2</span>
</span><span id="1-122">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T3</span>
</span><span id="1-123">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T4</span>
</span><span id="1-124">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T5</span>
</span><span id="1-125">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T6</span>
</span><span id="1-126">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_T7</span>
</span><span id="1-127">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_TypedColumnClauseArgument</span> <span class="k">as</span> <span class="n">_TCCA</span>
</span><span id="1-128">    <span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">Executable</span>
</span><span id="1-129">    <span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">ExecutableOption</span>
</span><span id="1-130">    <span class="kn">from</span> <span class="nn">..sql.dml</span> <span class="kn">import</span> <span class="n">UpdateBase</span>
</span><span id="1-131">    <span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">ClauseElement</span>
</span><span id="1-132">    <span class="kn">from</span> <span class="nn">..sql.roles</span> <span class="kn">import</span> <span class="n">TypedColumnsClauseRole</span>
</span><span id="1-133">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">ForUpdateParameter</span>
</span><span id="1-134">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">TypedReturnsRows</span>
</span><span id="1-135">
</span><span id="1-136"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span id="1-137">
</span><span id="1-138"><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-139">    <span class="s2">&quot;Session&quot;</span><span class="p">,</span>
</span><span id="1-140">    <span class="s2">&quot;SessionTransaction&quot;</span><span class="p">,</span>
</span><span id="1-141">    <span class="s2">&quot;sessionmaker&quot;</span><span class="p">,</span>
</span><span id="1-142">    <span class="s2">&quot;ORMExecuteState&quot;</span><span class="p">,</span>
</span><span id="1-143">    <span class="s2">&quot;close_all_sessions&quot;</span><span class="p">,</span>
</span><span id="1-144">    <span class="s2">&quot;make_transient&quot;</span><span class="p">,</span>
</span><span id="1-145">    <span class="s2">&quot;make_transient_to_detached&quot;</span><span class="p">,</span>
</span><span id="1-146">    <span class="s2">&quot;object_session&quot;</span><span class="p">,</span>
</span><span id="1-147"><span class="p">]</span>
</span><span id="1-148">
</span><span id="1-149"><span class="n">_sessions</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">[</span>
</span><span id="1-150">    <span class="nb">int</span><span class="p">,</span> <span class="n">Session</span>
</span><span id="1-151"><span class="p">]</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
</span><span id="1-152"><span class="sd">&quot;&quot;&quot;Weak-referencing dictionary of :class:`.Session` objects.</span>
</span><span id="1-153"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-154">
</span><span id="1-155"><span class="n">statelib</span><span class="o">.</span><span class="n">_sessions</span> <span class="o">=</span> <span class="n">_sessions</span>
</span><span id="1-156">
</span><span id="1-157"><span class="n">_PKIdentityArgument</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
</span><span id="1-158">
</span><span id="1-159"><span class="n">_BindArguments</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-160">
</span><span id="1-161"><span class="n">_EntityBindKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="s2">&quot;Mapper[_O]&quot;</span><span class="p">]</span>
</span><span id="1-162"><span class="n">_SessionBindKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="s2">&quot;Mapper[Any]&quot;</span><span class="p">,</span> <span class="s2">&quot;TableClause&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
</span><span id="1-163"><span class="n">_SessionBind</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;Engine&quot;</span><span class="p">,</span> <span class="s2">&quot;Connection&quot;</span><span class="p">]</span>
</span><span id="1-164">
</span><span id="1-165"><span class="n">JoinTransactionMode</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
</span><span id="1-166">    <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">,</span>
</span><span id="1-167">    <span class="s2">&quot;rollback_only&quot;</span><span class="p">,</span>
</span><span id="1-168">    <span class="s2">&quot;control_fully&quot;</span><span class="p">,</span>
</span><span id="1-169">    <span class="s2">&quot;create_savepoint&quot;</span><span class="p">,</span>
</span><span id="1-170"><span class="p">]</span>
</span><span id="1-171">
</span><span id="1-172">
</span><span id="1-173"><span class="k">class</span> <span class="nc">_ConnectionCallableProto</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span id="1-174"><span class="w">    </span><span class="sd">&quot;&quot;&quot;a callable that returns a :class:`.Connection` given an instance.</span>
</span><span id="1-175">
</span><span id="1-176"><span class="sd">    This callable, when present on a :class:`.Session`, is called only from the</span>
</span><span id="1-177"><span class="sd">    ORM&#39;s persistence mechanism (i.e. the unit of work flush process) to allow</span>
</span><span id="1-178"><span class="sd">    for connection-per-instance schemes (i.e. horizontal sharding) to be used</span>
</span><span id="1-179"><span class="sd">    as persistence time.</span>
</span><span id="1-180">
</span><span id="1-181"><span class="sd">    This callable is not present on a plain :class:`.Session`, however</span>
</span><span id="1-182"><span class="sd">    is established when using the horizontal sharding extension.</span>
</span><span id="1-183">
</span><span id="1-184"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-185">
</span><span id="1-186">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="1-187">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-188">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-189">        <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-190">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-191">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span id="1-192">        <span class="o">...</span>
</span><span id="1-193">
</span><span id="1-194">
</span><span id="1-195"><span class="k">def</span> <span class="nf">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span id="1-196"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an :class:`.InstanceState`, return the :class:`.Session`</span>
</span><span id="1-197"><span class="sd">    associated, if any.</span>
</span><span id="1-198"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-199">    <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">session</span>
</span><span id="1-200">
</span><span id="1-201">
</span><span id="1-202"><span class="k">class</span> <span class="nc">_SessionClassMethods</span><span class="p">:</span>
</span><span id="1-203"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class-level methods for :class:`.Session`, :class:`.sessionmaker`.&quot;&quot;&quot;</span>
</span><span id="1-204">
</span><span id="1-205">    <span class="nd">@classmethod</span>
</span><span id="1-206">    <span class="nd">@util</span><span class="o">.</span><span class="n">deprecated</span><span class="p">(</span>
</span><span id="1-207">        <span class="s2">&quot;1.3&quot;</span><span class="p">,</span>
</span><span id="1-208">        <span class="s2">&quot;The :meth:`.Session.close_all` method is deprecated and will be &quot;</span>
</span><span id="1-209">        <span class="s2">&quot;removed in a future release.  Please refer to &quot;</span>
</span><span id="1-210">        <span class="s2">&quot;:func:`.session.close_all_sessions`.&quot;</span><span class="p">,</span>
</span><span id="1-211">    <span class="p">)</span>
</span><span id="1-212">    <span class="k">def</span> <span class="nf">close_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-213"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close *all* sessions in memory.&quot;&quot;&quot;</span>
</span><span id="1-214">
</span><span id="1-215">        <span class="n">close_all_sessions</span><span class="p">()</span>
</span><span id="1-216">
</span><span id="1-217">    <span class="nd">@classmethod</span>
</span><span id="1-218">    <span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.util&quot;</span><span class="p">)</span>
</span><span id="1-219">    <span class="k">def</span> <span class="nf">identity_key</span><span class="p">(</span>
</span><span id="1-220">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-221">        <span class="n">class_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-222">        <span class="n">ident</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-223">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-224">        <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-225">        <span class="n">row</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Row</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">RowMapping</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-226">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-227">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-228"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an identity key.</span>
</span><span id="1-229">
</span><span id="1-230"><span class="sd">        This is an alias of :func:`.util.identity_key`.</span>
</span><span id="1-231">
</span><span id="1-232"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-233">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_util</span><span class="o">.</span><span class="n">identity_key</span><span class="p">(</span>
</span><span id="1-234">            <span class="n">class_</span><span class="p">,</span>
</span><span id="1-235">            <span class="n">ident</span><span class="p">,</span>
</span><span id="1-236">            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
</span><span id="1-237">            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
</span><span id="1-238">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-239">        <span class="p">)</span>
</span><span id="1-240">
</span><span id="1-241">    <span class="nd">@classmethod</span>
</span><span id="1-242">    <span class="k">def</span> <span class="nf">object_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span id="1-243"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`.Session` to which an object belongs.</span>
</span><span id="1-244">
</span><span id="1-245"><span class="sd">        This is an alias of :func:`.object_session`.</span>
</span><span id="1-246">
</span><span id="1-247"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-248">
</span><span id="1-249">        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-250">
</span><span id="1-251">
</span><span id="1-252"><span class="k">class</span> <span class="nc">SessionTransactionState</span><span class="p">(</span><span class="n">_StateChangeState</span><span class="p">):</span>
</span><span id="1-253">    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="1-254">    <span class="n">PREPARED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="1-255">    <span class="n">COMMITTED</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="1-256">    <span class="n">DEACTIVE</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="1-257">    <span class="n">CLOSED</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="1-258">    <span class="n">PROVISIONING_CONNECTION</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="1-259">
</span><span id="1-260">
</span><span id="1-261"><span class="c1"># backwards compatibility</span>
</span><span id="1-262"><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">PREPARED</span><span class="p">,</span> <span class="n">COMMITTED</span><span class="p">,</span> <span class="n">DEACTIVE</span><span class="p">,</span> <span class="n">CLOSED</span><span class="p">,</span> <span class="n">PROVISIONING_CONNECTION</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="1-263">    <span class="n">SessionTransactionState</span>
</span><span id="1-264"><span class="p">)</span>
</span><span id="1-265">
</span><span id="1-266">
</span><span id="1-267"><span class="k">class</span> <span class="nc">ORMExecuteState</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">MemoizedSlots</span><span class="p">):</span>
</span><span id="1-268"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a call to the :meth:`_orm.Session.execute` method, as passed</span>
</span><span id="1-269"><span class="sd">    to the :meth:`.SessionEvents.do_orm_execute` event hook.</span>
</span><span id="1-270">
</span><span id="1-271"><span class="sd">    .. versionadded:: 1.4</span>
</span><span id="1-272">
</span><span id="1-273"><span class="sd">    .. seealso::</span>
</span><span id="1-274">
</span><span id="1-275"><span class="sd">        :ref:`session_execute_events` - top level documentation on how</span>
</span><span id="1-276"><span class="sd">        to use :meth:`_orm.SessionEvents.do_orm_execute`</span>
</span><span id="1-277">
</span><span id="1-278"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-279">
</span><span id="1-280">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-281">        <span class="s2">&quot;session&quot;</span><span class="p">,</span>
</span><span id="1-282">        <span class="s2">&quot;statement&quot;</span><span class="p">,</span>
</span><span id="1-283">        <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
</span><span id="1-284">        <span class="s2">&quot;execution_options&quot;</span><span class="p">,</span>
</span><span id="1-285">        <span class="s2">&quot;local_execution_options&quot;</span><span class="p">,</span>
</span><span id="1-286">        <span class="s2">&quot;bind_arguments&quot;</span><span class="p">,</span>
</span><span id="1-287">        <span class="s2">&quot;identity_token&quot;</span><span class="p">,</span>
</span><span id="1-288">        <span class="s2">&quot;_compile_state_cls&quot;</span><span class="p">,</span>
</span><span id="1-289">        <span class="s2">&quot;_starting_event_idx&quot;</span><span class="p">,</span>
</span><span id="1-290">        <span class="s2">&quot;_events_todo&quot;</span><span class="p">,</span>
</span><span id="1-291">        <span class="s2">&quot;_update_execution_options&quot;</span><span class="p">,</span>
</span><span id="1-292">    <span class="p">)</span>
</span><span id="1-293">
</span><span id="1-294">    <span class="n">session</span><span class="p">:</span> <span class="n">Session</span>
</span><span id="1-295"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Session` in use.&quot;&quot;&quot;</span>
</span><span id="1-296">
</span><span id="1-297">    <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span>
</span><span id="1-298"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The SQL statement being invoked.</span>
</span><span id="1-299">
</span><span id="1-300"><span class="sd">    For an ORM selection as would</span>
</span><span id="1-301"><span class="sd">    be retrieved from :class:`_orm.Query`, this is an instance of</span>
</span><span id="1-302"><span class="sd">    :class:`_sql.select` that was generated from the ORM query.</span>
</span><span id="1-303"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-304">
</span><span id="1-305">    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span>
</span><span id="1-306"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionary of parameters that was passed to</span>
</span><span id="1-307"><span class="sd">    :meth:`_orm.Session.execute`.&quot;&quot;&quot;</span>
</span><span id="1-308">
</span><span id="1-309">    <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span>
</span><span id="1-310"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The complete dictionary of current execution options.</span>
</span><span id="1-311">
</span><span id="1-312"><span class="sd">    This is a merge of the statement level options with the</span>
</span><span id="1-313"><span class="sd">    locally passed execution options.</span>
</span><span id="1-314">
</span><span id="1-315"><span class="sd">    .. seealso::</span>
</span><span id="1-316">
</span><span id="1-317"><span class="sd">        :attr:`_orm.ORMExecuteState.local_execution_options`</span>
</span><span id="1-318">
</span><span id="1-319"><span class="sd">        :meth:`_sql.Executable.execution_options`</span>
</span><span id="1-320">
</span><span id="1-321"><span class="sd">        :ref:`orm_queryguide_execution_options`</span>
</span><span id="1-322">
</span><span id="1-323"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-324">
</span><span id="1-325">    <span class="n">local_execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span>
</span><span id="1-326"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionary view of the execution options passed to the</span>
</span><span id="1-327"><span class="sd">    :meth:`.Session.execute` method.</span>
</span><span id="1-328">
</span><span id="1-329"><span class="sd">    This does not include options that may be associated with the statement</span>
</span><span id="1-330"><span class="sd">    being invoked.</span>
</span><span id="1-331">
</span><span id="1-332"><span class="sd">    .. seealso::</span>
</span><span id="1-333">
</span><span id="1-334"><span class="sd">        :attr:`_orm.ORMExecuteState.execution_options`</span>
</span><span id="1-335">
</span><span id="1-336"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-337">
</span><span id="1-338">    <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">_BindArguments</span>
</span><span id="1-339"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The dictionary passed as the</span>
</span><span id="1-340"><span class="sd">    :paramref:`_orm.Session.execute.bind_arguments` dictionary.</span>
</span><span id="1-341">
</span><span id="1-342"><span class="sd">    This dictionary may be used by extensions to :class:`_orm.Session` to pass</span>
</span><span id="1-343"><span class="sd">    arguments that will assist in determining amongst a set of database</span>
</span><span id="1-344"><span class="sd">    connections which one should be used to invoke this statement.</span>
</span><span id="1-345">
</span><span id="1-346"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-347">
</span><span id="1-348">    <span class="n">_compile_state_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ORMCompileState</span><span class="p">]]</span>
</span><span id="1-349">    <span class="n">_starting_event_idx</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="1-350">    <span class="n">_events_todo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-351">    <span class="n">_update_execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ExecuteOptions</span><span class="p">]</span>
</span><span id="1-352">
</span><span id="1-353">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-354">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-355">        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
</span><span id="1-356">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-357">        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">],</span>
</span><span id="1-358">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span><span class="p">,</span>
</span><span id="1-359">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">_BindArguments</span><span class="p">,</span>
</span><span id="1-360">        <span class="n">compile_state_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">ORMCompileState</span><span class="p">]],</span>
</span><span id="1-361">        <span class="n">events_todo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_InstanceLevelDispatch</span><span class="p">[</span><span class="n">Session</span><span class="p">]],</span>
</span><span id="1-362">    <span class="p">):</span>
</span><span id="1-363"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.ORMExecuteState`.</span>
</span><span id="1-364">
</span><span id="1-365"><span class="sd">        this object is constructed internally.</span>
</span><span id="1-366">
</span><span id="1-367"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-368">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="1-369">        <span class="bp">self</span><span class="o">.</span><span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span>
</span><span id="1-370">        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
</span><span id="1-371">        <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span> <span class="o">=</span> <span class="n">execution_options</span>
</span><span id="1-372">        <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="1-373">            <span class="n">execution_options</span>
</span><span id="1-374">        <span class="p">)</span>
</span><span id="1-375">        <span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span> <span class="o">=</span> <span class="n">bind_arguments</span>
</span><span id="1-376">        <span class="bp">self</span><span class="o">.</span><span class="n">_compile_state_cls</span> <span class="o">=</span> <span class="n">compile_state_cls</span>
</span><span id="1-377">        <span class="bp">self</span><span class="o">.</span><span class="n">_events_todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">events_todo</span><span class="p">)</span>
</span><span id="1-378">
</span><span id="1-379">    <span class="k">def</span> <span class="nf">_remaining_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_InstanceLevelDispatch</span><span class="p">[</span><span class="n">Session</span><span class="p">]]:</span>
</span><span id="1-380">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events_todo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_starting_event_idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
</span><span id="1-381">
</span><span id="1-382">    <span class="k">def</span> <span class="nf">invoke_statement</span><span class="p">(</span>
</span><span id="1-383">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-384">        <span class="n">statement</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Executable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-385">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-386">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrmExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-387">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-388">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-389"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the statement represented by this</span>
</span><span id="1-390"><span class="sd">        :class:`.ORMExecuteState`, without re-invoking events that have</span>
</span><span id="1-391"><span class="sd">        already proceeded.</span>
</span><span id="1-392">
</span><span id="1-393"><span class="sd">        This method essentially performs a re-entrant execution of the current</span>
</span><span id="1-394"><span class="sd">        statement for which the :meth:`.SessionEvents.do_orm_execute` event is</span>
</span><span id="1-395"><span class="sd">        being currently invoked.    The use case for this is for event handlers</span>
</span><span id="1-396"><span class="sd">        that want to override how the ultimate</span>
</span><span id="1-397"><span class="sd">        :class:`_engine.Result` object is returned, such as for schemes that</span>
</span><span id="1-398"><span class="sd">        retrieve results from an offline cache or which concatenate results</span>
</span><span id="1-399"><span class="sd">        from multiple executions.</span>
</span><span id="1-400">
</span><span id="1-401"><span class="sd">        When the :class:`_engine.Result` object is returned by the actual</span>
</span><span id="1-402"><span class="sd">        handler function within :meth:`_orm.SessionEvents.do_orm_execute` and</span>
</span><span id="1-403"><span class="sd">        is propagated to the calling</span>
</span><span id="1-404"><span class="sd">        :meth:`_orm.Session.execute` method, the remainder of the</span>
</span><span id="1-405"><span class="sd">        :meth:`_orm.Session.execute` method is preempted and the</span>
</span><span id="1-406"><span class="sd">        :class:`_engine.Result` object is returned to the caller of</span>
</span><span id="1-407"><span class="sd">        :meth:`_orm.Session.execute` immediately.</span>
</span><span id="1-408">
</span><span id="1-409"><span class="sd">        :param statement: optional statement to be invoked, in place of the</span>
</span><span id="1-410"><span class="sd">         statement currently represented by :attr:`.ORMExecuteState.statement`.</span>
</span><span id="1-411">
</span><span id="1-412"><span class="sd">        :param params: optional dictionary of parameters or list of parameters</span>
</span><span id="1-413"><span class="sd">         which will be merged into the existing</span>
</span><span id="1-414"><span class="sd">         :attr:`.ORMExecuteState.parameters` of this :class:`.ORMExecuteState`.</span>
</span><span id="1-415">
</span><span id="1-416"><span class="sd">         .. versionchanged:: 2.0 a list of parameter dictionaries is accepted</span>
</span><span id="1-417"><span class="sd">            for executemany executions.</span>
</span><span id="1-418">
</span><span id="1-419"><span class="sd">        :param execution_options: optional dictionary of execution options</span>
</span><span id="1-420"><span class="sd">         will be merged into the existing</span>
</span><span id="1-421"><span class="sd">         :attr:`.ORMExecuteState.execution_options` of this</span>
</span><span id="1-422"><span class="sd">         :class:`.ORMExecuteState`.</span>
</span><span id="1-423">
</span><span id="1-424"><span class="sd">        :param bind_arguments: optional dictionary of bind_arguments</span>
</span><span id="1-425"><span class="sd">         which will be merged amongst the current</span>
</span><span id="1-426"><span class="sd">         :attr:`.ORMExecuteState.bind_arguments`</span>
</span><span id="1-427"><span class="sd">         of this :class:`.ORMExecuteState`.</span>
</span><span id="1-428">
</span><span id="1-429"><span class="sd">        :return: a :class:`_engine.Result` object with ORM-level results.</span>
</span><span id="1-430">
</span><span id="1-431"><span class="sd">        .. seealso::</span>
</span><span id="1-432">
</span><span id="1-433"><span class="sd">            :ref:`do_orm_execute_re_executing` - background and examples on the</span>
</span><span id="1-434"><span class="sd">            appropriate usage of :meth:`_orm.ORMExecuteState.invoke_statement`.</span>
</span><span id="1-435">
</span><span id="1-436">
</span><span id="1-437"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-438">
</span><span id="1-439">        <span class="k">if</span> <span class="n">statement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-440">            <span class="n">statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span>
</span><span id="1-441">
</span><span id="1-442">        <span class="n">_bind_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span id="1-443">        <span class="k">if</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span id="1-444">            <span class="n">_bind_arguments</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span id="1-445">        <span class="n">_bind_arguments</span><span class="p">[</span><span class="s2">&quot;_sa_skip_events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-446">
</span><span id="1-447">        <span class="n">_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span>
</span><span id="1-448">        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
</span><span id="1-449">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_executemany</span><span class="p">:</span>
</span><span id="1-450">                <span class="n">_params</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-451">                <span class="n">exec_many_parameters</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="1-452">                    <span class="s2">&quot;List[Dict[str, Any]]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
</span><span id="1-453">                <span class="p">)</span>
</span><span id="1-454">                <span class="k">for</span> <span class="n">_existing_params</span><span class="p">,</span> <span class="n">_new_params</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span>
</span><span id="1-455">                    <span class="n">exec_many_parameters</span><span class="p">,</span>
</span><span id="1-456">                    <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;List[Dict[str, Any]]&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span>
</span><span id="1-457">                <span class="p">):</span>
</span><span id="1-458">                    <span class="k">if</span> <span class="n">_existing_params</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_new_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-459">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-460">                            <span class="sa">f</span><span class="s2">&quot;Can&#39;t apply executemany parameters to &quot;</span>
</span><span id="1-461">                            <span class="sa">f</span><span class="s2">&quot;statement; number of parameter sets passed to &quot;</span>
</span><span id="1-462">                            <span class="sa">f</span><span class="s2">&quot;Session.execute() (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exec_many_parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
</span><span id="1-463">                            <span class="sa">f</span><span class="s2">&quot;does not match number of parameter sets given &quot;</span>
</span><span id="1-464">                            <span class="sa">f</span><span class="s2">&quot;to ORMExecuteState.invoke_statement() &quot;</span>
</span><span id="1-465">                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="1-466">                        <span class="p">)</span>
</span><span id="1-467">                    <span class="n">_existing_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_existing_params</span><span class="p">)</span>
</span><span id="1-468">                    <span class="n">_existing_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_new_params</span><span class="p">)</span>
</span><span id="1-469">                    <span class="n">_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_existing_params</span><span class="p">)</span>
</span><span id="1-470">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-471">                <span class="n">_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
</span><span id="1-472">                <span class="n">_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>
</span><span id="1-473">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-474">            <span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
</span><span id="1-475">
</span><span id="1-476">        <span class="n">_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span>
</span><span id="1-477">        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-478">            <span class="n">_execution_options</span> <span class="o">=</span> <span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span>
</span><span id="1-479">
</span><span id="1-480">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span id="1-481">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-482">            <span class="n">_params</span><span class="p">,</span>
</span><span id="1-483">            <span class="n">execution_options</span><span class="o">=</span><span class="n">_execution_options</span><span class="p">,</span>
</span><span id="1-484">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">_bind_arguments</span><span class="p">,</span>
</span><span id="1-485">            <span class="n">_parent_execute_state</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="1-486">        <span class="p">)</span>
</span><span id="1-487">
</span><span id="1-488">    <span class="nd">@property</span>
</span><span id="1-489">    <span class="k">def</span> <span class="nf">bind_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-490"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`_orm.Mapper` that is the primary &quot;bind&quot; mapper.</span>
</span><span id="1-491">
</span><span id="1-492"><span class="sd">        For an :class:`_orm.ORMExecuteState` object invoking an ORM</span>
</span><span id="1-493"><span class="sd">        statement, that is, the :attr:`_orm.ORMExecuteState.is_orm_statement`</span>
</span><span id="1-494"><span class="sd">        attribute is ``True``, this attribute will return the</span>
</span><span id="1-495"><span class="sd">        :class:`_orm.Mapper` that is considered to be the &quot;primary&quot; mapper</span>
</span><span id="1-496"><span class="sd">        of the statement.   The term &quot;bind mapper&quot; refers to the fact that</span>
</span><span id="1-497"><span class="sd">        a :class:`_orm.Session` object may be &quot;bound&quot; to multiple</span>
</span><span id="1-498"><span class="sd">        :class:`_engine.Engine` objects keyed to mapped classes, and the</span>
</span><span id="1-499"><span class="sd">        &quot;bind mapper&quot; determines which of those :class:`_engine.Engine` objects</span>
</span><span id="1-500"><span class="sd">        would be selected.</span>
</span><span id="1-501">
</span><span id="1-502"><span class="sd">        For a statement that is invoked against a single mapped class,</span>
</span><span id="1-503"><span class="sd">        :attr:`_orm.ORMExecuteState.bind_mapper` is intended to be a reliable</span>
</span><span id="1-504"><span class="sd">        way of getting this mapper.</span>
</span><span id="1-505">
</span><span id="1-506"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span id="1-507">
</span><span id="1-508"><span class="sd">        .. seealso::</span>
</span><span id="1-509">
</span><span id="1-510"><span class="sd">            :attr:`_orm.ORMExecuteState.all_mappers`</span>
</span><span id="1-511">
</span><span id="1-512">
</span><span id="1-513"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-514">        <span class="n">mp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mapper&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-515">        <span class="k">return</span> <span class="n">mp</span>
</span><span id="1-516">
</span><span id="1-517">    <span class="nd">@property</span>
</span><span id="1-518">    <span class="k">def</span> <span class="nf">all_mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-519"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a sequence of all :class:`_orm.Mapper` objects that are</span>
</span><span id="1-520"><span class="sd">        involved at the top level of this statement.</span>
</span><span id="1-521">
</span><span id="1-522"><span class="sd">        By &quot;top level&quot; we mean those :class:`_orm.Mapper` objects that would</span>
</span><span id="1-523"><span class="sd">        be represented in the result set rows for a :func:`_sql.select`</span>
</span><span id="1-524"><span class="sd">        query, or for a :func:`_dml.update` or :func:`_dml.delete` query,</span>
</span><span id="1-525"><span class="sd">        the mapper that is the main subject of the UPDATE or DELETE.</span>
</span><span id="1-526">
</span><span id="1-527"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span id="1-528">
</span><span id="1-529"><span class="sd">        .. seealso::</span>
</span><span id="1-530">
</span><span id="1-531"><span class="sd">            :attr:`_orm.ORMExecuteState.bind_mapper`</span>
</span><span id="1-532">
</span><span id="1-533">
</span><span id="1-534">
</span><span id="1-535"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-536">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_orm_statement</span><span class="p">:</span>
</span><span id="1-537">            <span class="k">return</span> <span class="p">[]</span>
</span><span id="1-538">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">Select</span><span class="p">,</span> <span class="n">FromStatement</span><span class="p">)):</span>
</span><span id="1-539">            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-540">            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-541">            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">column_descriptions</span><span class="p">:</span>
</span><span id="1-542">                <span class="n">ent</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;entity&quot;</span><span class="p">]</span>
</span><span id="1-543">                <span class="k">if</span> <span class="n">ent</span><span class="p">:</span>
</span><span id="1-544">                    <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">raiseerr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-545">                    <span class="k">if</span> <span class="n">insp</span> <span class="ow">and</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">and</span> <span class="n">insp</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
</span><span id="1-546">                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span id="1-547">                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span>
</span><span id="1-548">            <span class="k">return</span> <span class="n">result</span>
</span><span id="1-549">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_mapper</span><span class="p">:</span>
</span><span id="1-550">            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_mapper</span><span class="p">]</span>
</span><span id="1-551">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-552">            <span class="k">return</span> <span class="p">[]</span>
</span><span id="1-553">
</span><span id="1-554">    <span class="nd">@property</span>
</span><span id="1-555">    <span class="k">def</span> <span class="nf">is_orm_statement</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-556"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if the operation is an ORM statement.</span>
</span><span id="1-557">
</span><span id="1-558"><span class="sd">        This indicates that the select(), insert(), update(), or delete()</span>
</span><span id="1-559"><span class="sd">        being invoked contains ORM entities as subjects.   For a statement</span>
</span><span id="1-560"><span class="sd">        that does not have ORM entities and instead refers only to</span>
</span><span id="1-561"><span class="sd">        :class:`.Table` metadata, it is invoked as a Core SQL statement</span>
</span><span id="1-562"><span class="sd">        and no ORM-level automation takes place.</span>
</span><span id="1-563">
</span><span id="1-564"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-565">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-566">
</span><span id="1-567">    <span class="nd">@property</span>
</span><span id="1-568">    <span class="k">def</span> <span class="nf">is_executemany</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-569"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if the parameters are a multi-element list of</span>
</span><span id="1-570"><span class="sd">        dictionaries with more than one dictionary.</span>
</span><span id="1-571">
</span><span id="1-572"><span class="sd">        .. versionadded:: 2.0</span>
</span><span id="1-573">
</span><span id="1-574"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-575">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
</span><span id="1-576">
</span><span id="1-577">    <span class="nd">@property</span>
</span><span id="1-578">    <span class="k">def</span> <span class="nf">is_select</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-579"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is a SELECT operation.&quot;&quot;&quot;</span>
</span><span id="1-580">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_select</span>
</span><span id="1-581">
</span><span id="1-582">    <span class="nd">@property</span>
</span><span id="1-583">    <span class="k">def</span> <span class="nf">is_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-584"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is an INSERT operation.&quot;&quot;&quot;</span>
</span><span id="1-585">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_insert</span>
</span><span id="1-586">
</span><span id="1-587">    <span class="nd">@property</span>
</span><span id="1-588">    <span class="k">def</span> <span class="nf">is_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-589"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is an UPDATE operation.&quot;&quot;&quot;</span>
</span><span id="1-590">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_update</span>
</span><span id="1-591">
</span><span id="1-592">    <span class="nd">@property</span>
</span><span id="1-593">    <span class="k">def</span> <span class="nf">is_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-594"><span class="w">        </span><span class="sd">&quot;&quot;&quot;return True if this is a DELETE operation.&quot;&quot;&quot;</span>
</span><span id="1-595">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_dml</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">is_delete</span>
</span><span id="1-596">
</span><span id="1-597">    <span class="nd">@property</span>
</span><span id="1-598">    <span class="k">def</span> <span class="nf">_is_crud</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-599">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span> <span class="p">(</span><span class="n">dml</span><span class="o">.</span><span class="n">Update</span><span class="p">,</span> <span class="n">dml</span><span class="o">.</span><span class="n">Delete</span><span class="p">))</span>
</span><span id="1-600">
</span><span id="1-601">    <span class="k">def</span> <span class="nf">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-602"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the local execution options with new values.&quot;&quot;&quot;</span>
</span><span id="1-603">        <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
</span><span id="1-604">
</span><span id="1-605">    <span class="k">def</span> <span class="nf">_orm_compile_options</span><span class="p">(</span>
</span><span id="1-606">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-607">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="1-608">        <span class="n">Union</span><span class="p">[</span>
</span><span id="1-609">            <span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span><span class="p">,</span>
</span><span id="1-610">            <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span><span class="p">],</span>
</span><span id="1-611">        <span class="p">]</span>
</span><span id="1-612">    <span class="p">]:</span>
</span><span id="1-613">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_select</span><span class="p">:</span>
</span><span id="1-614">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-615">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-616">            <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_compile_options</span>
</span><span id="1-617">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-618">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-619">
</span><span id="1-620">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">isinstance</span><span class="p">(</span>
</span><span id="1-621">            <span class="n">context</span><span class="o">.</span><span class="n">ORMCompileState</span><span class="o">.</span><span class="n">default_compile_options</span>
</span><span id="1-622">        <span class="p">):</span>
</span><span id="1-623">            <span class="k">return</span> <span class="n">opts</span>  <span class="c1"># type: ignore</span>
</span><span id="1-624">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-625">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-626">
</span><span id="1-627">    <span class="nd">@property</span>
</span><span id="1-628">    <span class="k">def</span> <span class="nf">lazy_loaded_from</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-629"><span class="w">        </span><span class="sd">&quot;&quot;&quot;An :class:`.InstanceState` that is using this statement execution</span>
</span><span id="1-630"><span class="sd">        for a lazy load operation.</span>
</span><span id="1-631">
</span><span id="1-632"><span class="sd">        The primary rationale for this attribute is to support the horizontal</span>
</span><span id="1-633"><span class="sd">        sharding extension, where it is available within specific query</span>
</span><span id="1-634"><span class="sd">        execution time hooks created by this extension.   To that end, the</span>
</span><span id="1-635"><span class="sd">        attribute is only intended to be meaningful at **query execution</span>
</span><span id="1-636"><span class="sd">        time**, and importantly not any time prior to that, including query</span>
</span><span id="1-637"><span class="sd">        compilation time.</span>
</span><span id="1-638">
</span><span id="1-639"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-640">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_options</span><span class="o">.</span><span class="n">_lazy_loaded_from</span>
</span><span id="1-641">
</span><span id="1-642">    <span class="nd">@property</span>
</span><span id="1-643">    <span class="k">def</span> <span class="nf">loader_strategy_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathRegistry</span><span class="p">]:</span>
</span><span id="1-644"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the :class:`.PathRegistry` for the current load path.</span>
</span><span id="1-645">
</span><span id="1-646"><span class="sd">        This object represents the &quot;path&quot; in a query along relationships</span>
</span><span id="1-647"><span class="sd">        when a particular object or collection is being loaded.</span>
</span><span id="1-648">
</span><span id="1-649"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-650">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span id="1-651">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-652">            <span class="k">return</span> <span class="n">opts</span><span class="o">.</span><span class="n">_current_path</span>
</span><span id="1-653">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-654">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-655">
</span><span id="1-656">    <span class="nd">@property</span>
</span><span id="1-657">    <span class="k">def</span> <span class="nf">is_column_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-658"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the operation is refreshing column-oriented</span>
</span><span id="1-659"><span class="sd">        attributes on an existing ORM object.</span>
</span><span id="1-660">
</span><span id="1-661"><span class="sd">        This occurs during operations such as :meth:`_orm.Session.refresh`,</span>
</span><span id="1-662"><span class="sd">        as well as when an attribute deferred by :func:`_orm.defer` is</span>
</span><span id="1-663"><span class="sd">        being loaded, or an attribute that was expired either directly</span>
</span><span id="1-664"><span class="sd">        by :meth:`_orm.Session.expire` or via a commit operation is being</span>
</span><span id="1-665"><span class="sd">        loaded.</span>
</span><span id="1-666">
</span><span id="1-667"><span class="sd">        Handlers will very likely not want to add any options to queries</span>
</span><span id="1-668"><span class="sd">        when such an operation is occurring as the query should be a straight</span>
</span><span id="1-669"><span class="sd">        primary key fetch which should not have any additional WHERE criteria,</span>
</span><span id="1-670"><span class="sd">        and loader options travelling with the instance</span>
</span><span id="1-671"><span class="sd">        will have already been added to the query.</span>
</span><span id="1-672">
</span><span id="1-673"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span id="1-674">
</span><span id="1-675"><span class="sd">        .. seealso::</span>
</span><span id="1-676">
</span><span id="1-677"><span class="sd">            :attr:`_orm.ORMExecuteState.is_relationship_load`</span>
</span><span id="1-678">
</span><span id="1-679"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-680">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span id="1-681">        <span class="k">return</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">_for_refresh_state</span>
</span><span id="1-682">
</span><span id="1-683">    <span class="nd">@property</span>
</span><span id="1-684">    <span class="k">def</span> <span class="nf">is_relationship_load</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-685"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this load is loading objects on behalf of a</span>
</span><span id="1-686"><span class="sd">        relationship.</span>
</span><span id="1-687">
</span><span id="1-688"><span class="sd">        This means, the loader in effect is either a LazyLoader,</span>
</span><span id="1-689"><span class="sd">        SelectInLoader, SubqueryLoader, or similar, and the entire</span>
</span><span id="1-690"><span class="sd">        SELECT statement being emitted is on behalf of a relationship</span>
</span><span id="1-691"><span class="sd">        load.</span>
</span><span id="1-692">
</span><span id="1-693"><span class="sd">        Handlers will very likely not want to add any options to queries</span>
</span><span id="1-694"><span class="sd">        when such an operation is occurring, as loader options are already</span>
</span><span id="1-695"><span class="sd">        capable of being propagated to relationship loaders and should</span>
</span><span id="1-696"><span class="sd">        be already present.</span>
</span><span id="1-697">
</span><span id="1-698"><span class="sd">        .. seealso::</span>
</span><span id="1-699">
</span><span id="1-700"><span class="sd">            :attr:`_orm.ORMExecuteState.is_column_load`</span>
</span><span id="1-701">
</span><span id="1-702"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-703">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orm_compile_options</span><span class="p">()</span>
</span><span id="1-704">        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-705">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-706">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader_strategy_path</span>
</span><span id="1-707">        <span class="k">return</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_root</span>
</span><span id="1-708">
</span><span id="1-709">    <span class="nd">@property</span>
</span><span id="1-710">    <span class="k">def</span> <span class="nf">load_options</span><span class="p">(</span>
</span><span id="1-711">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-712">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-713">        <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">,</span>
</span><span id="1-714">        <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">],</span>
</span><span id="1-715">    <span class="p">]:</span>
</span><span id="1-716"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the load_options that will be used for this execution.&quot;&quot;&quot;</span>
</span><span id="1-717">
</span><span id="1-718">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_select</span><span class="p">:</span>
</span><span id="1-719">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-720">                <span class="s2">&quot;This ORM execution is not against a SELECT statement &quot;</span>
</span><span id="1-721">                <span class="s2">&quot;so there are no load options.&quot;</span>
</span><span id="1-722">            <span class="p">)</span>
</span><span id="1-723">
</span><span id="1-724">        <span class="n">lo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-725">            <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">,</span>
</span><span id="1-726">            <span class="n">Type</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span><span class="p">],</span>
</span><span id="1-727">        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-728">            <span class="s2">&quot;_sa_orm_load_options&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span>
</span><span id="1-729">        <span class="p">)</span>
</span><span id="1-730">        <span class="k">return</span> <span class="n">lo</span>
</span><span id="1-731">
</span><span id="1-732">    <span class="nd">@property</span>
</span><span id="1-733">    <span class="k">def</span> <span class="nf">update_delete_options</span><span class="p">(</span>
</span><span id="1-734">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-735">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-736">        <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span id="1-737">        <span class="n">Type</span><span class="p">[</span><span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">],</span>
</span><span id="1-738">    <span class="p">]:</span>
</span><span id="1-739"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the update_delete_options that will be used for this</span>
</span><span id="1-740"><span class="sd">        execution.&quot;&quot;&quot;</span>
</span><span id="1-741">
</span><span id="1-742">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_crud</span><span class="p">:</span>
</span><span id="1-743">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-744">                <span class="s2">&quot;This ORM execution is not against an UPDATE or DELETE &quot;</span>
</span><span id="1-745">                <span class="s2">&quot;statement so there are no update options.&quot;</span>
</span><span id="1-746">            <span class="p">)</span>
</span><span id="1-747">        <span class="n">uo</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-748">            <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span id="1-749">            <span class="n">Type</span><span class="p">[</span><span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">],</span>
</span><span id="1-750">        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-751">            <span class="s2">&quot;_sa_orm_update_options&quot;</span><span class="p">,</span>
</span><span id="1-752">            <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">BulkUDCompileState</span><span class="o">.</span><span class="n">default_update_options</span><span class="p">,</span>
</span><span id="1-753">        <span class="p">)</span>
</span><span id="1-754">        <span class="k">return</span> <span class="n">uo</span>
</span><span id="1-755">
</span><span id="1-756">    <span class="nd">@property</span>
</span><span id="1-757">    <span class="k">def</span> <span class="nf">_non_compile_orm_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]:</span>
</span><span id="1-758">        <span class="k">return</span> <span class="p">[</span>
</span><span id="1-759">            <span class="n">opt</span>
</span><span id="1-760">            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_with_options</span>
</span><span id="1-761">            <span class="k">if</span> <span class="n">is_orm_option</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opt</span><span class="o">.</span><span class="n">_is_compile_state</span>
</span><span id="1-762">        <span class="p">]</span>
</span><span id="1-763">
</span><span id="1-764">    <span class="nd">@property</span>
</span><span id="1-765">    <span class="k">def</span> <span class="nf">user_defined_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">UserDefinedOption</span><span class="p">]:</span>
</span><span id="1-766"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The sequence of :class:`.UserDefinedOptions` that have been</span>
</span><span id="1-767"><span class="sd">        associated with the statement being invoked.</span>
</span><span id="1-768">
</span><span id="1-769"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-770">        <span class="k">return</span> <span class="p">[</span>
</span><span id="1-771">            <span class="n">opt</span>
</span><span id="1-772">            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="o">.</span><span class="n">_with_options</span>
</span><span id="1-773">            <span class="k">if</span> <span class="n">is_user_defined_option</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
</span><span id="1-774">        <span class="p">]</span>
</span><span id="1-775">
</span><span id="1-776">
</span><span id="1-777"><span class="k">class</span> <span class="nc">SessionTransactionOrigin</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="1-778"><span class="w">    </span><span class="sd">&quot;&quot;&quot;indicates the origin of a :class:`.SessionTransaction`.</span>
</span><span id="1-779">
</span><span id="1-780"><span class="sd">    This enumeration is present on the</span>
</span><span id="1-781"><span class="sd">    :attr:`.SessionTransaction.origin` attribute of any</span>
</span><span id="1-782"><span class="sd">    :class:`.SessionTransaction` object.</span>
</span><span id="1-783">
</span><span id="1-784"><span class="sd">    .. versionadded:: 2.0</span>
</span><span id="1-785">
</span><span id="1-786"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-787">
</span><span id="1-788">    <span class="n">AUTOBEGIN</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="1-789"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction were started by autobegin&quot;&quot;&quot;</span>
</span><span id="1-790">
</span><span id="1-791">    <span class="n">BEGIN</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="1-792"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction were started by calling :meth:`_orm.Session.begin`&quot;&quot;&quot;</span>
</span><span id="1-793">
</span><span id="1-794">    <span class="n">BEGIN_NESTED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="1-795"><span class="w">    </span><span class="sd">&quot;&quot;&quot;tranaction were started by :meth:`_orm.Session.begin_nested`&quot;&quot;&quot;</span>
</span><span id="1-796">
</span><span id="1-797">    <span class="n">SUBTRANSACTION</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="1-798"><span class="w">    </span><span class="sd">&quot;&quot;&quot;transaction is an internal &quot;subtransaction&quot; &quot;&quot;&quot;</span>
</span><span id="1-799">
</span><span id="1-800">
</span><span id="1-801"><span class="k">class</span> <span class="nc">SessionTransaction</span><span class="p">(</span><span class="n">_StateChange</span><span class="p">,</span> <span class="n">TransactionalContext</span><span class="p">):</span>
</span><span id="1-802"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A :class:`.Session`-level transaction.</span>
</span><span id="1-803">
</span><span id="1-804"><span class="sd">    :class:`.SessionTransaction` is produced from the</span>
</span><span id="1-805"><span class="sd">    :meth:`_orm.Session.begin`</span>
</span><span id="1-806"><span class="sd">    and :meth:`_orm.Session.begin_nested` methods.   It&#39;s largely an internal</span>
</span><span id="1-807"><span class="sd">    object that in modern use provides a context manager for session</span>
</span><span id="1-808"><span class="sd">    transactions.</span>
</span><span id="1-809">
</span><span id="1-810"><span class="sd">    Documentation on interacting with :class:`_orm.SessionTransaction` is</span>
</span><span id="1-811"><span class="sd">    at: :ref:`unitofwork_transaction`.</span>
</span><span id="1-812">
</span><span id="1-813">
</span><span id="1-814"><span class="sd">    .. versionchanged:: 1.4  The scoping and API methods to work with the</span>
</span><span id="1-815"><span class="sd">       :class:`_orm.SessionTransaction` object directly have been simplified.</span>
</span><span id="1-816">
</span><span id="1-817"><span class="sd">    .. seealso::</span>
</span><span id="1-818">
</span><span id="1-819"><span class="sd">        :ref:`unitofwork_transaction`</span>
</span><span id="1-820">
</span><span id="1-821"><span class="sd">        :meth:`.Session.begin`</span>
</span><span id="1-822">
</span><span id="1-823"><span class="sd">        :meth:`.Session.begin_nested`</span>
</span><span id="1-824">
</span><span id="1-825"><span class="sd">        :meth:`.Session.rollback`</span>
</span><span id="1-826">
</span><span id="1-827"><span class="sd">        :meth:`.Session.commit`</span>
</span><span id="1-828">
</span><span id="1-829"><span class="sd">        :meth:`.Session.in_transaction`</span>
</span><span id="1-830">
</span><span id="1-831"><span class="sd">        :meth:`.Session.in_nested_transaction`</span>
</span><span id="1-832">
</span><span id="1-833"><span class="sd">        :meth:`.Session.get_transaction`</span>
</span><span id="1-834">
</span><span id="1-835"><span class="sd">        :meth:`.Session.get_nested_transaction`</span>
</span><span id="1-836">
</span><span id="1-837">
</span><span id="1-838"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-839">
</span><span id="1-840">    <span class="n">_rollback_exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-841">
</span><span id="1-842">    <span class="n">_connections</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
</span><span id="1-843">        <span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Transaction</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-844">    <span class="p">]</span>
</span><span id="1-845">    <span class="n">session</span><span class="p">:</span> <span class="n">Session</span>
</span><span id="1-846">    <span class="n">_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span id="1-847">
</span><span id="1-848">    <span class="n">_state</span><span class="p">:</span> <span class="n">SessionTransactionState</span>
</span><span id="1-849">
</span><span id="1-850">    <span class="n">_new</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span id="1-851">    <span class="n">_deleted</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span id="1-852">    <span class="n">_dirty</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span>
</span><span id="1-853">    <span class="n">_key_switches</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span>
</span><span id="1-854">        <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-855">    <span class="p">]</span>
</span><span id="1-856">
</span><span id="1-857">    <span class="n">origin</span><span class="p">:</span> <span class="n">SessionTransactionOrigin</span>
</span><span id="1-858"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Origin of this :class:`_orm.SessionTransaction`.</span>
</span><span id="1-859">
</span><span id="1-860"><span class="sd">    Refers to a :class:`.SessionTransactionOrigin` instance which is an</span>
</span><span id="1-861"><span class="sd">    enumeration indicating the source event that led to constructing</span>
</span><span id="1-862"><span class="sd">    this :class:`_orm.SessionTransaction`.</span>
</span><span id="1-863">
</span><span id="1-864"><span class="sd">    .. versionadded:: 2.0</span>
</span><span id="1-865">
</span><span id="1-866"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-867">
</span><span id="1-868">    <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-869"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Indicates if this is a nested, or SAVEPOINT, transaction.</span>
</span><span id="1-870">
</span><span id="1-871"><span class="sd">    When :attr:`.SessionTransaction.nested` is True, it is expected</span>
</span><span id="1-872"><span class="sd">    that :attr:`.SessionTransaction.parent` will be present as well,</span>
</span><span id="1-873"><span class="sd">    linking to the enclosing :class:`.SessionTransaction`.</span>
</span><span id="1-874">
</span><span id="1-875"><span class="sd">    .. seealso::</span>
</span><span id="1-876">
</span><span id="1-877"><span class="sd">        :attr:`.SessionTransaction.origin`</span>
</span><span id="1-878">
</span><span id="1-879"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-880">
</span><span id="1-881">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-882">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-883">        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
</span><span id="1-884">        <span class="n">origin</span><span class="p">:</span> <span class="n">SessionTransactionOrigin</span><span class="p">,</span>
</span><span id="1-885">        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-886">    <span class="p">):</span>
</span><span id="1-887">        <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-888">
</span><span id="1-889">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
</span><span id="1-890">        <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-891">        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
</span><span id="1-892">        <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="o">=</span> <span class="n">nested</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN_NESTED</span>
</span><span id="1-893">        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
</span><span id="1-894">
</span><span id="1-895">        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">_close_state</span> <span class="ow">is</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
</span><span id="1-896">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-897">                <span class="s2">&quot;This Session has been permanently closed and is unable &quot;</span>
</span><span id="1-898">                <span class="s2">&quot;to handle any more transaction requests.&quot;</span>
</span><span id="1-899">            <span class="p">)</span>
</span><span id="1-900">
</span><span id="1-901">        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="1-902">            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
</span><span id="1-903">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-904">                    <span class="s2">&quot;Can&#39;t start a SAVEPOINT transaction when no existing &quot;</span>
</span><span id="1-905">                    <span class="s2">&quot;transaction is in progress&quot;</span>
</span><span id="1-906">                <span class="p">)</span>
</span><span id="1-907">
</span><span id="1-908">            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested_transaction</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_nested_transaction</span>
</span><span id="1-909">        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">SUBTRANSACTION</span><span class="p">:</span>
</span><span id="1-910">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-911">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-912">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-913">
</span><span id="1-914">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span id="1-915">
</span><span id="1-916">        <span class="bp">self</span><span class="o">.</span><span class="n">_take_snapshot</span><span class="p">()</span>
</span><span id="1-917">
</span><span id="1-918">        <span class="c1"># make sure transaction is assigned before we call the</span>
</span><span id="1-919">        <span class="c1"># dispatch</span>
</span><span id="1-920">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-921">
</span><span id="1-922">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_transaction_create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-923">
</span><span id="1-924">    <span class="k">def</span> <span class="nf">_raise_for_prerequisite_state</span><span class="p">(</span>
</span><span id="1-925">        <span class="bp">self</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">_StateChangeState</span>
</span><span id="1-926">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span id="1-927">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span><span class="p">:</span>
</span><span id="1-928">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rollback_exception</span><span class="p">:</span>
</span><span id="1-929">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">(</span>
</span><span id="1-930">                    <span class="s2">&quot;This Session&#39;s transaction has been rolled back &quot;</span>
</span><span id="1-931">                    <span class="s2">&quot;due to a previous exception during flush.&quot;</span>
</span><span id="1-932">                    <span class="s2">&quot; To begin a new transaction with this Session, &quot;</span>
</span><span id="1-933">                    <span class="s2">&quot;first issue Session.rollback().&quot;</span>
</span><span id="1-934">                    <span class="sa">f</span><span class="s2">&quot; Original exception was: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rollback_exception</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="1-935">                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;7s2a&quot;</span><span class="p">,</span>
</span><span id="1-936">                <span class="p">)</span>
</span><span id="1-937">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-938">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-939">                    <span class="s2">&quot;This session is in &#39;inactive&#39; state, due to the &quot;</span>
</span><span id="1-940">                    <span class="s2">&quot;SQL transaction being rolled back; no further SQL &quot;</span>
</span><span id="1-941">                    <span class="s2">&quot;can be emitted within this transaction.&quot;</span>
</span><span id="1-942">                <span class="p">)</span>
</span><span id="1-943">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
</span><span id="1-944">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">(</span><span class="s2">&quot;This transaction is closed&quot;</span><span class="p">)</span>
</span><span id="1-945">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PROVISIONING_CONNECTION</span><span class="p">:</span>
</span><span id="1-946">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-947">                <span class="s2">&quot;This session is provisioning a new connection; concurrent &quot;</span>
</span><span id="1-948">                <span class="s2">&quot;operations are not permitted&quot;</span><span class="p">,</span>
</span><span id="1-949">                <span class="n">code</span><span class="o">=</span><span class="s2">&quot;isce&quot;</span><span class="p">,</span>
</span><span id="1-950">            <span class="p">)</span>
</span><span id="1-951">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-952">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-953">                <span class="sa">f</span><span class="s2">&quot;This session is in &#39;</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; state; no &quot;</span>
</span><span id="1-954">                <span class="s2">&quot;further SQL can be emitted within this transaction.&quot;</span>
</span><span id="1-955">            <span class="p">)</span>
</span><span id="1-956">
</span><span id="1-957">    <span class="nd">@property</span>
</span><span id="1-958">    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span id="1-959"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The parent :class:`.SessionTransaction` of this</span>
</span><span id="1-960"><span class="sd">        :class:`.SessionTransaction`.</span>
</span><span id="1-961">
</span><span id="1-962"><span class="sd">        If this attribute is ``None``, indicates this</span>
</span><span id="1-963"><span class="sd">        :class:`.SessionTransaction` is at the top of the stack, and</span>
</span><span id="1-964"><span class="sd">        corresponds to a real &quot;COMMIT&quot;/&quot;ROLLBACK&quot;</span>
</span><span id="1-965"><span class="sd">        block.  If non-``None``, then this is either a &quot;subtransaction&quot;</span>
</span><span id="1-966"><span class="sd">        (an internal marker object used by the flush process) or a</span>
</span><span id="1-967"><span class="sd">        &quot;nested&quot; / SAVEPOINT transaction.  If the</span>
</span><span id="1-968"><span class="sd">        :attr:`.SessionTransaction.nested` attribute is ``True``, then</span>
</span><span id="1-969"><span class="sd">        this is a SAVEPOINT, and if ``False``, indicates this a subtransaction.</span>
</span><span id="1-970">
</span><span id="1-971"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-972">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-973">
</span><span id="1-974">    <span class="nd">@property</span>
</span><span id="1-975">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-976">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-977">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-978">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span id="1-979">        <span class="p">)</span>
</span><span id="1-980">
</span><span id="1-981">    <span class="nd">@property</span>
</span><span id="1-982">    <span class="k">def</span> <span class="nf">_is_transaction_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-983">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-984">
</span><span id="1-985">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-986">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span id="1-987">    <span class="p">)</span>
</span><span id="1-988">    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span>
</span><span id="1-989">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-990">        <span class="n">bindkey</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-991">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ExecuteOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-992">        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-993">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span id="1-994">        <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="n">bindkey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="1-995">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">)</span>
</span><span id="1-996">
</span><span id="1-997">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-998">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span id="1-999">    <span class="p">)</span>
</span><span id="1-1000">    <span class="k">def</span> <span class="nf">_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span id="1-1001">        <span class="k">return</span> <span class="n">SessionTransaction</span><span class="p">(</span>
</span><span id="1-1002">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
</span><span id="1-1003">            <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN_NESTED</span>
</span><span id="1-1004">            <span class="k">if</span> <span class="n">nested</span>
</span><span id="1-1005">            <span class="k">else</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">SUBTRANSACTION</span><span class="p">,</span>
</span><span id="1-1006">            <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1007">        <span class="p">)</span>
</span><span id="1-1008">
</span><span id="1-1009">    <span class="k">def</span> <span class="nf">_iterate_self_and_parents</span><span class="p">(</span>
</span><span id="1-1010">        <span class="bp">self</span><span class="p">,</span> <span class="n">upto</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1011">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span id="1-1012">        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-1013">        <span class="n">result</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-1014">        <span class="k">while</span> <span class="n">current</span><span class="p">:</span>
</span><span id="1-1015">            <span class="n">result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">current</span><span class="p">,)</span>
</span><span id="1-1016">            <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="n">upto</span><span class="p">:</span>
</span><span id="1-1017">                <span class="k">break</span>
</span><span id="1-1018">            <span class="k">elif</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1019">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1020">                    <span class="s2">&quot;Transaction </span><span class="si">%s</span><span class="s2"> is not on the active transaction list&quot;</span>
</span><span id="1-1021">                    <span class="o">%</span> <span class="p">(</span><span class="n">upto</span><span class="p">)</span>
</span><span id="1-1022">                <span class="p">)</span>
</span><span id="1-1023">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1024">                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-1025">
</span><span id="1-1026">        <span class="k">return</span> <span class="n">result</span>
</span><span id="1-1027">
</span><span id="1-1028">    <span class="k">def</span> <span class="nf">_take_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1029">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span><span class="p">:</span>
</span><span id="1-1030">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-1031">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1032">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_new</span>
</span><span id="1-1033">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-1034">            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_dirty</span>
</span><span id="1-1035">            <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">_key_switches</span>
</span><span id="1-1036">            <span class="k">return</span>
</span><span id="1-1037">
</span><span id="1-1038">        <span class="n">is_begin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1039">            <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN</span><span class="p">,</span>
</span><span id="1-1040">            <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">AUTOBEGIN</span><span class="p">,</span>
</span><span id="1-1041">        <span class="p">)</span>
</span><span id="1-1042">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_begin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span id="1-1043">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="1-1044">
</span><span id="1-1045">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1046">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1047">        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1048">        <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1049">
</span><span id="1-1050">    <span class="k">def</span> <span class="nf">_restore_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirty_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1051"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore the restoration state taken before a transaction began.</span>
</span><span id="1-1052">
</span><span id="1-1053"><span class="sd">        Corresponds to a rollback.</span>
</span><span id="1-1054">
</span><span id="1-1055"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1056">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span>
</span><span id="1-1057">
</span><span id="1-1058">        <span class="n">to_expunge</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span id="1-1059">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">(</span><span class="n">to_expunge</span><span class="p">,</span> <span class="n">to_transient</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1060">
</span><span id="1-1061">        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">oldkey</span><span class="p">,</span> <span class="n">newkey</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1062">            <span class="c1"># we probably can do this conditionally based on</span>
</span><span id="1-1063">            <span class="c1"># if we expunged or not, but safe_discard does that anyway</span>
</span><span id="1-1064">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="1-1065">
</span><span id="1-1066">            <span class="c1"># restore the old key</span>
</span><span id="1-1067">            <span class="n">s</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">oldkey</span>
</span><span id="1-1068">
</span><span id="1-1069">            <span class="c1"># now restore the object, but only if we didn&#39;t expunge</span>
</span><span id="1-1070">            <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_expunge</span><span class="p">:</span>
</span><span id="1-1071">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="1-1072">
</span><span id="1-1073">        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_deleted</span><span class="p">):</span>
</span><span id="1-1074">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">revert_deletion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1075">
</span><span id="1-1076">        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-1077">
</span><span id="1-1078">        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span id="1-1079">            <span class="k">if</span> <span class="ow">not</span> <span class="n">dirty_only</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">modified</span> <span class="ow">or</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">:</span>
</span><span id="1-1080">                <span class="n">s</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span id="1-1081">
</span><span id="1-1082">    <span class="k">def</span> <span class="nf">_remove_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1083"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the restoration state taken before a transaction began.</span>
</span><span id="1-1084">
</span><span id="1-1085"><span class="sd">        Corresponds to a commit.</span>
</span><span id="1-1086">
</span><span id="1-1087"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1088">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_transaction_boundary</span>
</span><span id="1-1089">
</span><span id="1-1090">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">expire_on_commit</span><span class="p">:</span>
</span><span id="1-1091">            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span id="1-1092">                <span class="n">s</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span id="1-1093">
</span><span id="1-1094">            <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span>
</span><span id="1-1095">                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="1-1096">            <span class="p">)</span>
</span><span id="1-1097">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="1-1098">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1099">            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-1100">            <span class="k">assert</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1101">            <span class="n">parent</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span id="1-1102">            <span class="n">parent</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">)</span>
</span><span id="1-1103">            <span class="n">parent</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span>
</span><span id="1-1104">            <span class="n">parent</span><span class="o">.</span><span class="n">_key_switches</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">)</span>
</span><span id="1-1105">
</span><span id="1-1106">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-1107">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span id="1-1108">    <span class="p">)</span>
</span><span id="1-1109">    <span class="k">def</span> <span class="nf">_connection_for_bind</span><span class="p">(</span>
</span><span id="1-1110">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1111">        <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">,</span>
</span><span id="1-1112">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">],</span>
</span><span id="1-1113">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span id="1-1114">        <span class="k">if</span> <span class="n">bind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
</span><span id="1-1115">            <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-1116">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1117">                    <span class="s2">&quot;Connection is already established for the &quot;</span>
</span><span id="1-1118">                    <span class="s2">&quot;given bind; execution_options ignored&quot;</span>
</span><span id="1-1119">                <span class="p">)</span>
</span><span id="1-1120">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">bind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="1-1121">
</span><span id="1-1122">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PROVISIONING_CONNECTION</span>
</span><span id="1-1123">
</span><span id="1-1124">        <span class="n">local_connect</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1125">        <span class="n">should_commit</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1126">
</span><span id="1-1127">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-1128">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span id="1-1129">                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span>
</span><span id="1-1130">                    <span class="n">bind</span><span class="p">,</span> <span class="n">execution_options</span>
</span><span id="1-1131">                <span class="p">)</span>
</span><span id="1-1132">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1133">                    <span class="k">return</span> <span class="n">conn</span>
</span><span id="1-1134">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1135">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Connection</span><span class="p">):</span>
</span><span id="1-1136">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-1137">                    <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">engine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">:</span>
</span><span id="1-1138">                        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1139">                            <span class="s2">&quot;Session already has a Connection associated &quot;</span>
</span><span id="1-1140">                            <span class="s2">&quot;for the given Connection&#39;s Engine&quot;</span>
</span><span id="1-1141">                        <span class="p">)</span>
</span><span id="1-1142">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1143">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">bind</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span id="1-1144">                    <span class="n">local_connect</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1145">
</span><span id="1-1146">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-1147">                <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
</span><span id="1-1148">                    <span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="o">**</span><span class="n">execution_options</span><span class="p">)</span>
</span><span id="1-1149">
</span><span id="1-1150">                <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span>
</span><span id="1-1151">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1152">                    <span class="c1"># TODO: shouldn&#39;t we only be here if not</span>
</span><span id="1-1153">                    <span class="c1"># conn.in_transaction() ?</span>
</span><span id="1-1154">                    <span class="c1"># if twophase is set and conn.in_transaction(), validate</span>
</span><span id="1-1155">                    <span class="c1"># that it is in fact twophase.</span>
</span><span id="1-1156">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_twophase</span><span class="p">()</span>
</span><span id="1-1157">                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1158">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
</span><span id="1-1159">                <span class="k">elif</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
</span><span id="1-1160">                    <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">join_transaction_mode</span>
</span><span id="1-1161">
</span><span id="1-1162">                    <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">:</span>
</span><span id="1-1163">                        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_nested_transaction</span><span class="p">():</span>
</span><span id="1-1164">                            <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="s2">&quot;create_savepoint&quot;</span>
</span><span id="1-1165">                        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1166">                            <span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="s2">&quot;rollback_only&quot;</span>
</span><span id="1-1167">
</span><span id="1-1168">                    <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1169">                        <span class="s2">&quot;control_fully&quot;</span><span class="p">,</span>
</span><span id="1-1170">                        <span class="s2">&quot;rollback_only&quot;</span><span class="p">,</span>
</span><span id="1-1171">                    <span class="p">):</span>
</span><span id="1-1172">                        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">in_nested_transaction</span><span class="p">():</span>
</span><span id="1-1173">                            <span class="n">transaction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1174">                                <span class="n">conn</span><span class="o">.</span><span class="n">_get_required_nested_transaction</span><span class="p">()</span>
</span><span id="1-1175">                            <span class="p">)</span>
</span><span id="1-1176">                        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1177">                            <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">_get_required_transaction</span><span class="p">()</span>
</span><span id="1-1178">                        <span class="k">if</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;rollback_only&quot;</span><span class="p">:</span>
</span><span id="1-1179">                            <span class="n">should_commit</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1180">                    <span class="k">elif</span> <span class="n">join_transaction_mode</span> <span class="o">==</span> <span class="s2">&quot;create_savepoint&quot;</span><span class="p">:</span>
</span><span id="1-1181">                        <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin_nested</span><span class="p">()</span>
</span><span id="1-1182">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-1183">                        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="n">join_transaction_mode</span>
</span><span id="1-1184">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1185">                    <span class="n">transaction</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
</span><span id="1-1186">            <span class="k">except</span><span class="p">:</span>
</span><span id="1-1187">                <span class="c1"># connection will not not be associated with this Session;</span>
</span><span id="1-1188">                <span class="c1"># close it immediately so that it isn&#39;t closed under GC</span>
</span><span id="1-1189">                <span class="k">if</span> <span class="n">local_connect</span><span class="p">:</span>
</span><span id="1-1190">                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1191">                <span class="k">raise</span>
</span><span id="1-1192">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1193">                <span class="n">bind_is_connection</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Connection</span><span class="p">)</span>
</span><span id="1-1194">
</span><span id="1-1195">                <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">engine</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1196">                    <span class="n">conn</span><span class="p">,</span>
</span><span id="1-1197">                    <span class="n">transaction</span><span class="p">,</span>
</span><span id="1-1198">                    <span class="n">should_commit</span><span class="p">,</span>
</span><span id="1-1199">                    <span class="ow">not</span> <span class="n">bind_is_connection</span><span class="p">,</span>
</span><span id="1-1200">                <span class="p">)</span>
</span><span id="1-1201">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_begin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
</span><span id="1-1202">                <span class="k">return</span> <span class="n">conn</span>
</span><span id="1-1203">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-1204">            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span id="1-1205">
</span><span id="1-1206">    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1207">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span><span class="p">:</span>
</span><span id="1-1208">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1209">                <span class="s2">&quot;&#39;twophase&#39; mode not enabled, or not root transaction; &quot;</span>
</span><span id="1-1210">                <span class="s2">&quot;can&#39;t prepare.&quot;</span>
</span><span id="1-1211">            <span class="p">)</span>
</span><span id="1-1212">        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_impl</span><span class="p">()</span>
</span><span id="1-1213">
</span><span id="1-1214">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-1215">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,),</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span>
</span><span id="1-1216">    <span class="p">)</span>
</span><span id="1-1217">    <span class="k">def</span> <span class="nf">_prepare_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1218">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1219">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_commit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-1220">
</span><span id="1-1221">        <span class="n">stx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1222">        <span class="k">assert</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1223">        <span class="k">if</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="1-1224">            <span class="k">for</span> <span class="n">subtransaction</span> <span class="ow">in</span> <span class="n">stx</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">(</span><span class="n">upto</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-1225">                <span class="n">subtransaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="1-1226">
</span><span id="1-1227">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span id="1-1228">            <span class="k">for</span> <span class="n">_flush_guard</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
</span><span id="1-1229">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span id="1-1230">                    <span class="k">break</span>
</span><span id="1-1231">                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="1-1232">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1233">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">FlushError</span><span class="p">(</span>
</span><span id="1-1234">                    <span class="s2">&quot;Over 100 subsequent flushes have occurred within &quot;</span>
</span><span id="1-1235">                    <span class="s2">&quot;session.commit() - is an after_flush() hook &quot;</span>
</span><span id="1-1236">                    <span class="s2">&quot;creating new objects?&quot;</span>
</span><span id="1-1237">                <span class="p">)</span>
</span><span id="1-1238">
</span><span id="1-1239">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">twophase</span><span class="p">:</span>
</span><span id="1-1240">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-1241">                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="1-1242">                    <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;TwoPhaseTransaction&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
</span><span id="1-1243">            <span class="k">except</span><span class="p">:</span>
</span><span id="1-1244">                <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span id="1-1245">                    <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="1-1246">
</span><span id="1-1247">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span>
</span><span id="1-1248">
</span><span id="1-1249">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-1250">        <span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">),</span>
</span><span id="1-1251">        <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span>
</span><span id="1-1252">    <span class="p">)</span>
</span><span id="1-1253">    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1254">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">:</span>
</span><span id="1-1255">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">):</span>
</span><span id="1-1256">                <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_impl</span><span class="p">()</span>
</span><span id="1-1257">
</span><span id="1-1258">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1259">            <span class="k">for</span> <span class="n">conn</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">should_commit</span><span class="p">,</span> <span class="n">autoclose</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="1-1260">                <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="1-1261">            <span class="p">):</span>
</span><span id="1-1262">                <span class="k">if</span> <span class="n">should_commit</span><span class="p">:</span>
</span><span id="1-1263">                    <span class="n">trans</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="1-1264">
</span><span id="1-1265">            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">COMMITTED</span>
</span><span id="1-1266">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_commit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-1267">
</span><span id="1-1268">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_snapshot</span><span class="p">()</span>
</span><span id="1-1269">
</span><span id="1-1270">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">):</span>
</span><span id="1-1271">            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1272">
</span><span id="1-1273">        <span class="k">if</span> <span class="n">_to_root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span id="1-1274">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1275">
</span><span id="1-1276">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-1277">        <span class="p">(</span>
</span><span id="1-1278">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
</span><span id="1-1279">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span><span class="p">,</span>
</span><span id="1-1280">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">,</span>
</span><span id="1-1281">        <span class="p">),</span>
</span><span id="1-1282">        <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">,</span>
</span><span id="1-1283">    <span class="p">)</span>
</span><span id="1-1284">    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span>
</span><span id="1-1285">        <span class="bp">self</span><span class="p">,</span> <span class="n">_capture_exception</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">_to_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1286">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1287">        <span class="n">stx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1288">        <span class="k">assert</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1289">        <span class="k">if</span> <span class="n">stx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="1-1290">            <span class="k">for</span> <span class="n">subtransaction</span> <span class="ow">in</span> <span class="n">stx</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">(</span><span class="n">upto</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-1291">                <span class="n">subtransaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1292">
</span><span id="1-1293">        <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-1294">        <span class="n">rollback_err</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1295">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1296">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span>
</span><span id="1-1297">            <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">PREPARED</span><span class="p">,</span>
</span><span id="1-1298">        <span class="p">):</span>
</span><span id="1-1299">            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">():</span>
</span><span id="1-1300">                <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">transaction</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1301">                    <span class="k">try</span><span class="p">:</span>
</span><span id="1-1302">                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="1-1303">                            <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span id="1-1304">
</span><span id="1-1305">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span id="1-1306">                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_rollback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-1307">                    <span class="k">except</span><span class="p">:</span>
</span><span id="1-1308">                        <span class="n">rollback_err</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span><span id="1-1309">                    <span class="k">finally</span><span class="p">:</span>
</span><span id="1-1310">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span id="1-1311">                        <span class="n">transaction</span><span class="o">.</span><span class="n">_restore_snapshot</span><span class="p">(</span>
</span><span id="1-1312">                            <span class="n">dirty_only</span><span class="o">=</span><span class="n">transaction</span><span class="o">.</span><span class="n">nested</span>
</span><span id="1-1313">                        <span class="p">)</span>
</span><span id="1-1314">                    <span class="n">boundary</span> <span class="o">=</span> <span class="n">transaction</span>
</span><span id="1-1315">                    <span class="k">break</span>
</span><span id="1-1316">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1317">                    <span class="n">transaction</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">DEACTIVE</span>
</span><span id="1-1318">
</span><span id="1-1319">        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="1-1320">
</span><span id="1-1321">        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollback_err</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sess</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span id="1-1322">            <span class="c1"># if items were added, deleted, or mutated</span>
</span><span id="1-1323">            <span class="c1"># here, we need to re-restore the snapshot</span>
</span><span id="1-1324">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1325">                <span class="s2">&quot;Session&#39;s state has been changed on &quot;</span>
</span><span id="1-1326">                <span class="s2">&quot;a non-active transaction - this state &quot;</span>
</span><span id="1-1327">                <span class="s2">&quot;will be discarded.&quot;</span>
</span><span id="1-1328">            <span class="p">)</span>
</span><span id="1-1329">            <span class="n">boundary</span><span class="o">.</span><span class="n">_restore_snapshot</span><span class="p">(</span><span class="n">dirty_only</span><span class="o">=</span><span class="n">boundary</span><span class="o">.</span><span class="n">nested</span><span class="p">)</span>
</span><span id="1-1330">
</span><span id="1-1331">        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expect_state</span><span class="p">(</span><span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">):</span>
</span><span id="1-1332">            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1333">
</span><span id="1-1334">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">and</span> <span class="n">_capture_exception</span><span class="p">:</span>
</span><span id="1-1335">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">_rollback_exception</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="1-1336">
</span><span id="1-1337">        <span class="k">if</span> <span class="n">rollback_err</span> <span class="ow">and</span> <span class="n">rollback_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="1-1338">            <span class="k">raise</span> <span class="n">rollback_err</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">rollback_err</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="1-1339">
</span><span id="1-1340">        <span class="n">sess</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_soft_rollback</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-1341">
</span><span id="1-1342">        <span class="k">if</span> <span class="n">_to_root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span>
</span><span id="1-1343">            <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1344">
</span><span id="1-1345">    <span class="nd">@_StateChange</span><span class="o">.</span><span class="n">declare_states</span><span class="p">(</span>
</span><span id="1-1346">        <span class="n">_StateChangeStates</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span id="1-1347">    <span class="p">)</span>
</span><span id="1-1348">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalidate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1349">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested</span><span class="p">:</span>
</span><span id="1-1350">            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1351">                <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested_transaction</span>
</span><span id="1-1352">            <span class="p">)</span>
</span><span id="1-1353">
</span><span id="1-1354">        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-1355">
</span><span id="1-1356">        <span class="k">for</span> <span class="n">connection</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">should_commit</span><span class="p">,</span> <span class="n">autoclose</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="1-1357">            <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="1-1358">        <span class="p">):</span>
</span><span id="1-1359">            <span class="k">if</span> <span class="n">invalidate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1360">                <span class="n">connection</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span id="1-1361">            <span class="k">if</span> <span class="n">should_commit</span> <span class="ow">and</span> <span class="n">transaction</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
</span><span id="1-1362">                <span class="n">transaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1363">            <span class="k">if</span> <span class="n">autoclose</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1364">                <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1365">
</span><span id="1-1366">        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span id="1-1367">        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="1-1368">
</span><span id="1-1369">        <span class="c1"># TODO: these two None sets were historically after the</span>
</span><span id="1-1370">        <span class="c1"># event hook below, and in 2.0 I changed it this way for some reason,</span>
</span><span id="1-1371">        <span class="c1"># and I remember there being a reason, but not what it was.</span>
</span><span id="1-1372">        <span class="c1"># Why do we need to get rid of them at all?  test_memusage::CycleTest</span>
</span><span id="1-1373">        <span class="c1"># passes with these commented out.</span>
</span><span id="1-1374">        <span class="c1"># self.session = None  # type: ignore</span>
</span><span id="1-1375">        <span class="c1"># self._connections = None  # type: ignore</span>
</span><span id="1-1376">
</span><span id="1-1377">        <span class="n">sess</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_transaction_end</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-1378">
</span><span id="1-1379">    <span class="k">def</span> <span class="nf">_get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
</span><span id="1-1380">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
</span><span id="1-1381">
</span><span id="1-1382">    <span class="k">def</span> <span class="nf">_transaction_is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1383">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span id="1-1384">
</span><span id="1-1385">    <span class="k">def</span> <span class="nf">_transaction_is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1386">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">is</span> <span class="n">SessionTransactionState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span id="1-1387">
</span><span id="1-1388">    <span class="k">def</span> <span class="nf">_rollback_can_be_called</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1389">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">COMMITTED</span><span class="p">,</span> <span class="n">CLOSED</span><span class="p">)</span>
</span><span id="1-1390">
</span><span id="1-1391">
</span><span id="1-1392"><span class="k">class</span> <span class="nc">_SessionCloseState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span><span id="1-1393">    <span class="n">ACTIVE</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="1-1394">    <span class="n">CLOSED</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="1-1395">    <span class="n">CLOSE_IS_RESET</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="1-1396">
</span><span id="1-1397">
</span><span id="1-1398"><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">_SessionClassMethods</span><span class="p">,</span> <span class="n">EventTarget</span><span class="p">):</span>
</span><span id="1-1399"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages persistence operations for ORM-mapped objects.</span>
</span><span id="1-1400">
</span><span id="1-1401"><span class="sd">    The :class:`_orm.Session` is **not safe for use in concurrent threads.**.</span>
</span><span id="1-1402"><span class="sd">    See :ref:`session_faq_threadsafe` for background.</span>
</span><span id="1-1403">
</span><span id="1-1404"><span class="sd">    The Session&#39;s usage paradigm is described at :doc:`/orm/session`.</span>
</span><span id="1-1405">
</span><span id="1-1406">
</span><span id="1-1407"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1408">
</span><span id="1-1409">    <span class="n">_is_asyncio</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1410">
</span><span id="1-1411">    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span>
</span><span id="1-1412">
</span><span id="1-1413">    <span class="n">identity_map</span><span class="p">:</span> <span class="n">IdentityMap</span>
</span><span id="1-1414"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A mapping of object identities to objects themselves.</span>
</span><span id="1-1415">
</span><span id="1-1416"><span class="sd">    Iterating through ``Session.identity_map.values()`` provides</span>
</span><span id="1-1417"><span class="sd">    access to the full set of persistent objects (i.e., those</span>
</span><span id="1-1418"><span class="sd">    that have row identity) currently in the session.</span>
</span><span id="1-1419">
</span><span id="1-1420"><span class="sd">    .. seealso::</span>
</span><span id="1-1421">
</span><span id="1-1422"><span class="sd">        :func:`.identity_key` - helper function to produce the keys used</span>
</span><span id="1-1423"><span class="sd">        in this dictionary.</span>
</span><span id="1-1424">
</span><span id="1-1425"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1426">
</span><span id="1-1427">    <span class="n">_new</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-1428">    <span class="n">_deleted</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-1429">    <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">]]</span>
</span><span id="1-1430">    <span class="n">__binds</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">_SessionBind</span><span class="p">]</span>
</span><span id="1-1431">    <span class="n">_flushing</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1432">    <span class="n">_warn_on_events</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1433">    <span class="n">_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span id="1-1434">    <span class="n">_nested_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]</span>
</span><span id="1-1435">    <span class="n">hash_key</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="1-1436">    <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1437">    <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1438">    <span class="n">enable_baked_queries</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1439">    <span class="n">twophase</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1440">    <span class="n">join_transaction_mode</span><span class="p">:</span> <span class="n">JoinTransactionMode</span>
</span><span id="1-1441">    <span class="n">_query_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-1442">    <span class="n">_close_state</span><span class="p">:</span> <span class="n">_SessionCloseState</span>
</span><span id="1-1443">
</span><span id="1-1444">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1445">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1446">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1447">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1448">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1449">        <span class="n">future</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1450">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1451">        <span class="n">autobegin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1452">        <span class="n">twophase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1453">        <span class="n">binds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">_SessionBind</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1454">        <span class="n">enable_baked_queries</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-1455">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1456">        <span class="n">query_cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1457">        <span class="n">autocommit</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-1458">        <span class="n">join_transaction_mode</span><span class="p">:</span> <span class="n">JoinTransactionMode</span> <span class="o">=</span> <span class="s2">&quot;conditional_savepoint&quot;</span><span class="p">,</span>
</span><span id="1-1459">        <span class="n">close_resets_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">_NoArg</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1460">    <span class="p">):</span>
</span><span id="1-1461"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.Session`.</span>
</span><span id="1-1462">
</span><span id="1-1463"><span class="sd">        See also the :class:`.sessionmaker` function which is used to</span>
</span><span id="1-1464"><span class="sd">        generate a :class:`.Session`-producing callable with a given</span>
</span><span id="1-1465"><span class="sd">        set of arguments.</span>
</span><span id="1-1466">
</span><span id="1-1467"><span class="sd">        :param autoflush: When ``True``, all query operations will issue a</span>
</span><span id="1-1468"><span class="sd">           :meth:`~.Session.flush` call to this ``Session`` before proceeding.</span>
</span><span id="1-1469"><span class="sd">           This is a convenience feature so that :meth:`~.Session.flush` need</span>
</span><span id="1-1470"><span class="sd">           not be called repeatedly in order for database queries to retrieve</span>
</span><span id="1-1471"><span class="sd">           results.</span>
</span><span id="1-1472">
</span><span id="1-1473"><span class="sd">           .. seealso::</span>
</span><span id="1-1474">
</span><span id="1-1475"><span class="sd">               :ref:`session_flushing` - additional background on autoflush</span>
</span><span id="1-1476">
</span><span id="1-1477"><span class="sd">        :param autobegin: Automatically start transactions (i.e. equivalent to</span>
</span><span id="1-1478"><span class="sd">           invoking :meth:`_orm.Session.begin`) when database access is</span>
</span><span id="1-1479"><span class="sd">           requested by an operation.   Defaults to ``True``.    Set to</span>
</span><span id="1-1480"><span class="sd">           ``False`` to prevent a :class:`_orm.Session` from implicitly</span>
</span><span id="1-1481"><span class="sd">           beginning transactions after construction, as well as after any of</span>
</span><span id="1-1482"><span class="sd">           the :meth:`_orm.Session.rollback`, :meth:`_orm.Session.commit`,</span>
</span><span id="1-1483"><span class="sd">           or :meth:`_orm.Session.close` methods are called.</span>
</span><span id="1-1484">
</span><span id="1-1485"><span class="sd">           .. versionadded:: 2.0</span>
</span><span id="1-1486">
</span><span id="1-1487"><span class="sd">           .. seealso::</span>
</span><span id="1-1488">
</span><span id="1-1489"><span class="sd">                :ref:`session_autobegin_disable`</span>
</span><span id="1-1490">
</span><span id="1-1491"><span class="sd">        :param bind: An optional :class:`_engine.Engine` or</span>
</span><span id="1-1492"><span class="sd">           :class:`_engine.Connection` to</span>
</span><span id="1-1493"><span class="sd">           which this ``Session`` should be bound. When specified, all SQL</span>
</span><span id="1-1494"><span class="sd">           operations performed by this session will execute via this</span>
</span><span id="1-1495"><span class="sd">           connectable.</span>
</span><span id="1-1496">
</span><span id="1-1497"><span class="sd">        :param binds: A dictionary which may specify any number of</span>
</span><span id="1-1498"><span class="sd">           :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span id="1-1499"><span class="sd">           objects as the source of</span>
</span><span id="1-1500"><span class="sd">           connectivity for SQL operations on a per-entity basis.   The keys</span>
</span><span id="1-1501"><span class="sd">           of the dictionary consist of any series of mapped classes,</span>
</span><span id="1-1502"><span class="sd">           arbitrary Python classes that are bases for mapped classes,</span>
</span><span id="1-1503"><span class="sd">           :class:`_schema.Table` objects and :class:`_orm.Mapper` objects.</span>
</span><span id="1-1504"><span class="sd">           The</span>
</span><span id="1-1505"><span class="sd">           values of the dictionary are then instances of</span>
</span><span id="1-1506"><span class="sd">           :class:`_engine.Engine`</span>
</span><span id="1-1507"><span class="sd">           or less commonly :class:`_engine.Connection` objects.</span>
</span><span id="1-1508"><span class="sd">           Operations which</span>
</span><span id="1-1509"><span class="sd">           proceed relative to a particular mapped class will consult this</span>
</span><span id="1-1510"><span class="sd">           dictionary for the closest matching entity in order to determine</span>
</span><span id="1-1511"><span class="sd">           which :class:`_engine.Engine` should be used for a particular SQL</span>
</span><span id="1-1512"><span class="sd">           operation.    The complete heuristics for resolution are</span>
</span><span id="1-1513"><span class="sd">           described at :meth:`.Session.get_bind`.  Usage looks like::</span>
</span><span id="1-1514">
</span><span id="1-1515"><span class="sd">            Session = sessionmaker(binds={</span>
</span><span id="1-1516"><span class="sd">                SomeMappedClass: create_engine(&#39;postgresql+psycopg2://engine1&#39;),</span>
</span><span id="1-1517"><span class="sd">                SomeDeclarativeBase: create_engine(&#39;postgresql+psycopg2://engine2&#39;),</span>
</span><span id="1-1518"><span class="sd">                some_mapper: create_engine(&#39;postgresql+psycopg2://engine3&#39;),</span>
</span><span id="1-1519"><span class="sd">                some_table: create_engine(&#39;postgresql+psycopg2://engine4&#39;),</span>
</span><span id="1-1520"><span class="sd">                })</span>
</span><span id="1-1521">
</span><span id="1-1522"><span class="sd">           .. seealso::</span>
</span><span id="1-1523">
</span><span id="1-1524"><span class="sd">                :ref:`session_partitioning`</span>
</span><span id="1-1525">
</span><span id="1-1526"><span class="sd">                :meth:`.Session.bind_mapper`</span>
</span><span id="1-1527">
</span><span id="1-1528"><span class="sd">                :meth:`.Session.bind_table`</span>
</span><span id="1-1529">
</span><span id="1-1530"><span class="sd">                :meth:`.Session.get_bind`</span>
</span><span id="1-1531">
</span><span id="1-1532">
</span><span id="1-1533"><span class="sd">        :param \class_: Specify an alternate class other than</span>
</span><span id="1-1534"><span class="sd">           ``sqlalchemy.orm.session.Session`` which should be used by the</span>
</span><span id="1-1535"><span class="sd">           returned class. This is the only argument that is local to the</span>
</span><span id="1-1536"><span class="sd">           :class:`.sessionmaker` function, and is not sent directly to the</span>
</span><span id="1-1537"><span class="sd">           constructor for ``Session``.</span>
</span><span id="1-1538">
</span><span id="1-1539"><span class="sd">        :param enable_baked_queries: legacy; defaults to ``True``.</span>
</span><span id="1-1540"><span class="sd">           A parameter consumed</span>
</span><span id="1-1541"><span class="sd">           by the :mod:`sqlalchemy.ext.baked` extension to determine if</span>
</span><span id="1-1542"><span class="sd">           &quot;baked queries&quot; should be cached, as is the normal operation</span>
</span><span id="1-1543"><span class="sd">           of this extension.  When set to ``False``, caching as used by</span>
</span><span id="1-1544"><span class="sd">           this particular extension is disabled.</span>
</span><span id="1-1545">
</span><span id="1-1546"><span class="sd">           .. versionchanged:: 1.4 The ``sqlalchemy.ext.baked`` extension is</span>
</span><span id="1-1547"><span class="sd">              legacy and is not used by any of SQLAlchemy&#39;s internals. This</span>
</span><span id="1-1548"><span class="sd">              flag therefore only affects applications that are making explicit</span>
</span><span id="1-1549"><span class="sd">              use of this extension within their own code.</span>
</span><span id="1-1550">
</span><span id="1-1551"><span class="sd">        :param expire_on_commit:  Defaults to ``True``. When ``True``, all</span>
</span><span id="1-1552"><span class="sd">           instances will be fully expired after each :meth:`~.commit`,</span>
</span><span id="1-1553"><span class="sd">           so that all attribute/object access subsequent to a completed</span>
</span><span id="1-1554"><span class="sd">           transaction will load from the most recent database state.</span>
</span><span id="1-1555">
</span><span id="1-1556"><span class="sd">            .. seealso::</span>
</span><span id="1-1557">
</span><span id="1-1558"><span class="sd">                :ref:`session_committing`</span>
</span><span id="1-1559">
</span><span id="1-1560"><span class="sd">        :param future: Deprecated; this flag is always True.</span>
</span><span id="1-1561">
</span><span id="1-1562"><span class="sd">          .. seealso::</span>
</span><span id="1-1563">
</span><span id="1-1564"><span class="sd">            :ref:`migration_20_toplevel`</span>
</span><span id="1-1565">
</span><span id="1-1566"><span class="sd">        :param info: optional dictionary of arbitrary data to be associated</span>
</span><span id="1-1567"><span class="sd">           with this :class:`.Session`.  Is available via the</span>
</span><span id="1-1568"><span class="sd">           :attr:`.Session.info` attribute.  Note the dictionary is copied at</span>
</span><span id="1-1569"><span class="sd">           construction time so that modifications to the per-</span>
</span><span id="1-1570"><span class="sd">           :class:`.Session` dictionary will be local to that</span>
</span><span id="1-1571"><span class="sd">           :class:`.Session`.</span>
</span><span id="1-1572">
</span><span id="1-1573"><span class="sd">        :param query_cls:  Class which should be used to create new Query</span>
</span><span id="1-1574"><span class="sd">          objects, as returned by the :meth:`~.Session.query` method.</span>
</span><span id="1-1575"><span class="sd">          Defaults to :class:`_query.Query`.</span>
</span><span id="1-1576">
</span><span id="1-1577"><span class="sd">        :param twophase:  When ``True``, all transactions will be started as</span>
</span><span id="1-1578"><span class="sd">            a &quot;two phase&quot; transaction, i.e. using the &quot;two phase&quot; semantics</span>
</span><span id="1-1579"><span class="sd">            of the database in use along with an XID.  During a</span>
</span><span id="1-1580"><span class="sd">            :meth:`~.commit`, after :meth:`~.flush` has been issued for all</span>
</span><span id="1-1581"><span class="sd">            attached databases, the :meth:`~.TwoPhaseTransaction.prepare`</span>
</span><span id="1-1582"><span class="sd">            method on each database&#39;s :class:`.TwoPhaseTransaction` will be</span>
</span><span id="1-1583"><span class="sd">            called. This allows each database to roll back the entire</span>
</span><span id="1-1584"><span class="sd">            transaction, before each transaction is committed.</span>
</span><span id="1-1585">
</span><span id="1-1586"><span class="sd">        :param autocommit: the &quot;autocommit&quot; keyword is present for backwards</span>
</span><span id="1-1587"><span class="sd">            compatibility but must remain at its default value of ``False``.</span>
</span><span id="1-1588">
</span><span id="1-1589"><span class="sd">        :param join_transaction_mode: Describes the transactional behavior to</span>
</span><span id="1-1590"><span class="sd">          take when a given bind is a :class:`_engine.Connection` that</span>
</span><span id="1-1591"><span class="sd">          has already begun a transaction outside the scope of this</span>
</span><span id="1-1592"><span class="sd">          :class:`_orm.Session`; in other words the</span>
</span><span id="1-1593"><span class="sd">          :meth:`_engine.Connection.in_transaction()` method returns True.</span>
</span><span id="1-1594">
</span><span id="1-1595"><span class="sd">          The following behaviors only take effect when the :class:`_orm.Session`</span>
</span><span id="1-1596"><span class="sd">          **actually makes use of the connection given**; that is, a method</span>
</span><span id="1-1597"><span class="sd">          such as :meth:`_orm.Session.execute`, :meth:`_orm.Session.connection`,</span>
</span><span id="1-1598"><span class="sd">          etc. are actually invoked:</span>
</span><span id="1-1599">
</span><span id="1-1600"><span class="sd">          * ``&quot;conditional_savepoint&quot;`` - this is the default.  if the given</span>
</span><span id="1-1601"><span class="sd">            :class:`_engine.Connection` is begun within a transaction but</span>
</span><span id="1-1602"><span class="sd">            does not have a SAVEPOINT, then ``&quot;rollback_only&quot;`` is used.</span>
</span><span id="1-1603"><span class="sd">            If the :class:`_engine.Connection` is additionally within</span>
</span><span id="1-1604"><span class="sd">            a SAVEPOINT, in other words</span>
</span><span id="1-1605"><span class="sd">            :meth:`_engine.Connection.in_nested_transaction()` method returns</span>
</span><span id="1-1606"><span class="sd">            True, then ``&quot;create_savepoint&quot;`` is used.</span>
</span><span id="1-1607">
</span><span id="1-1608"><span class="sd">            ``&quot;conditional_savepoint&quot;`` behavior attempts to make use of</span>
</span><span id="1-1609"><span class="sd">            savepoints in order to keep the state of the existing transaction</span>
</span><span id="1-1610"><span class="sd">            unchanged, but only if there is already a savepoint in progress;</span>
</span><span id="1-1611"><span class="sd">            otherwise, it is not assumed that the backend in use has adequate</span>
</span><span id="1-1612"><span class="sd">            support for SAVEPOINT, as availability of this feature varies.</span>
</span><span id="1-1613"><span class="sd">            ``&quot;conditional_savepoint&quot;`` also seeks to establish approximate</span>
</span><span id="1-1614"><span class="sd">            backwards compatibility with previous :class:`_orm.Session`</span>
</span><span id="1-1615"><span class="sd">            behavior, for applications that are not setting a specific mode. It</span>
</span><span id="1-1616"><span class="sd">            is recommended that one of the explicit settings be used.</span>
</span><span id="1-1617">
</span><span id="1-1618"><span class="sd">          * ``&quot;create_savepoint&quot;`` - the :class:`_orm.Session` will use</span>
</span><span id="1-1619"><span class="sd">            :meth:`_engine.Connection.begin_nested()` in all cases to create</span>
</span><span id="1-1620"><span class="sd">            its own transaction.  This transaction by its nature rides</span>
</span><span id="1-1621"><span class="sd">            &quot;on top&quot; of any existing transaction that&#39;s opened on the given</span>
</span><span id="1-1622"><span class="sd">            :class:`_engine.Connection`; if the underlying database and</span>
</span><span id="1-1623"><span class="sd">            the driver in use has full, non-broken support for SAVEPOINT, the</span>
</span><span id="1-1624"><span class="sd">            external transaction will remain unaffected throughout the</span>
</span><span id="1-1625"><span class="sd">            lifespan of the :class:`_orm.Session`.</span>
</span><span id="1-1626">
</span><span id="1-1627"><span class="sd">            The ``&quot;create_savepoint&quot;`` mode is the most useful for integrating</span>
</span><span id="1-1628"><span class="sd">            a :class:`_orm.Session` into a test suite where an externally</span>
</span><span id="1-1629"><span class="sd">            initiated transaction should remain unaffected; however, it relies</span>
</span><span id="1-1630"><span class="sd">            on proper SAVEPOINT support from the underlying driver and</span>
</span><span id="1-1631"><span class="sd">            database.</span>
</span><span id="1-1632">
</span><span id="1-1633"><span class="sd">            .. tip:: When using SQLite, the SQLite driver included through</span>
</span><span id="1-1634"><span class="sd">               Python 3.11 does not handle SAVEPOINTs correctly in all cases</span>
</span><span id="1-1635"><span class="sd">               without workarounds. See the section</span>
</span><span id="1-1636"><span class="sd">               :ref:`pysqlite_serializable` for details on current workarounds.</span>
</span><span id="1-1637">
</span><span id="1-1638"><span class="sd">          * ``&quot;control_fully&quot;`` - the :class:`_orm.Session` will take</span>
</span><span id="1-1639"><span class="sd">            control of the given transaction as its own;</span>
</span><span id="1-1640"><span class="sd">            :meth:`_orm.Session.commit` will call ``.commit()`` on the</span>
</span><span id="1-1641"><span class="sd">            transaction, :meth:`_orm.Session.rollback` will call</span>
</span><span id="1-1642"><span class="sd">            ``.rollback()`` on the transaction, :meth:`_orm.Session.close` will</span>
</span><span id="1-1643"><span class="sd">            call ``.rollback`` on the transaction.</span>
</span><span id="1-1644">
</span><span id="1-1645"><span class="sd">            .. tip:: This mode of use is equivalent to how SQLAlchemy 1.4 would</span>
</span><span id="1-1646"><span class="sd">               handle a :class:`_engine.Connection` given with an existing</span>
</span><span id="1-1647"><span class="sd">               SAVEPOINT (i.e. :meth:`_engine.Connection.begin_nested`); the</span>
</span><span id="1-1648"><span class="sd">               :class:`_orm.Session` would take full control of the existing</span>
</span><span id="1-1649"><span class="sd">               SAVEPOINT.</span>
</span><span id="1-1650">
</span><span id="1-1651"><span class="sd">          * ``&quot;rollback_only&quot;`` - the :class:`_orm.Session` will take control</span>
</span><span id="1-1652"><span class="sd">            of the given transaction for ``.rollback()`` calls only;</span>
</span><span id="1-1653"><span class="sd">            ``.commit()`` calls will not be propagated to the given</span>
</span><span id="1-1654"><span class="sd">            transaction.  ``.close()`` calls will have no effect on the</span>
</span><span id="1-1655"><span class="sd">            given transaction.</span>
</span><span id="1-1656">
</span><span id="1-1657"><span class="sd">            .. tip:: This mode of use is equivalent to how SQLAlchemy 1.4 would</span>
</span><span id="1-1658"><span class="sd">               handle a :class:`_engine.Connection` given with an existing</span>
</span><span id="1-1659"><span class="sd">               regular database transaction (i.e.</span>
</span><span id="1-1660"><span class="sd">               :meth:`_engine.Connection.begin`); the :class:`_orm.Session`</span>
</span><span id="1-1661"><span class="sd">               would propagate :meth:`_orm.Session.rollback` calls to the</span>
</span><span id="1-1662"><span class="sd">               underlying transaction, but not :meth:`_orm.Session.commit` or</span>
</span><span id="1-1663"><span class="sd">               :meth:`_orm.Session.close` calls.</span>
</span><span id="1-1664">
</span><span id="1-1665"><span class="sd">          .. versionadded:: 2.0.0rc1</span>
</span><span id="1-1666">
</span><span id="1-1667"><span class="sd">        :param close_resets_only: Defaults to ``True``. Determines if</span>
</span><span id="1-1668"><span class="sd">          the session should reset itself after calling ``.close()``</span>
</span><span id="1-1669"><span class="sd">          or should pass in a no longer usable state, disabling re-use.</span>
</span><span id="1-1670">
</span><span id="1-1671"><span class="sd">          .. versionadded:: 2.0.22 added flag ``close_resets_only``.</span>
</span><span id="1-1672"><span class="sd">            A future SQLAlchemy version may change the default value of</span>
</span><span id="1-1673"><span class="sd">            this flag to ``False``.</span>
</span><span id="1-1674">
</span><span id="1-1675"><span class="sd">          .. seealso::</span>
</span><span id="1-1676">
</span><span id="1-1677"><span class="sd">            :ref:`session_closing` - Detail on the semantics of</span>
</span><span id="1-1678"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span id="1-1679">
</span><span id="1-1680"><span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
</span><span id="1-1681">
</span><span id="1-1682">        <span class="c1"># considering allowing the &quot;autocommit&quot; keyword to still be accepted</span>
</span><span id="1-1683">        <span class="c1"># as long as it&#39;s False, so that external test suites, oslo.db etc</span>
</span><span id="1-1684">        <span class="c1"># continue to function as the argument appears to be passed in lots</span>
</span><span id="1-1685">        <span class="c1"># of cases including in our own test suite</span>
</span><span id="1-1686">        <span class="k">if</span> <span class="n">autocommit</span><span class="p">:</span>
</span><span id="1-1687">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1688">                <span class="s2">&quot;autocommit=True is no longer supported&quot;</span>
</span><span id="1-1689">            <span class="p">)</span>
</span><span id="1-1690">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">WeakInstanceDict</span><span class="p">()</span>
</span><span id="1-1691">
</span><span id="1-1692">        <span class="k">if</span> <span class="ow">not</span> <span class="n">future</span><span class="p">:</span>
</span><span id="1-1693">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1694">                <span class="s2">&quot;The &#39;future&#39; parameter passed to &quot;</span>
</span><span id="1-1695">                <span class="s2">&quot;Session() may only be set to True.&quot;</span>
</span><span id="1-1696">            <span class="p">)</span>
</span><span id="1-1697">
</span><span id="1-1698">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># InstanceState-&gt;object, strong refs object</span>
</span><span id="1-1699">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># same</span>
</span><span id="1-1700">        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-1701">        <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1702">        <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1703">        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1704">        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1705">        <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1706">        <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span> <span class="o">=</span> <span class="n">_new_sessionid</span><span class="p">()</span>
</span><span id="1-1707">        <span class="bp">self</span><span class="o">.</span><span class="n">autobegin</span> <span class="o">=</span> <span class="n">autobegin</span>
</span><span id="1-1708">        <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span id="1-1709">        <span class="bp">self</span><span class="o">.</span><span class="n">expire_on_commit</span> <span class="o">=</span> <span class="n">expire_on_commit</span>
</span><span id="1-1710">        <span class="bp">self</span><span class="o">.</span><span class="n">enable_baked_queries</span> <span class="o">=</span> <span class="n">enable_baked_queries</span>
</span><span id="1-1711">
</span><span id="1-1712">        <span class="c1"># the idea is that at some point NO_ARG will warn that in the future</span>
</span><span id="1-1713">        <span class="c1"># the default will switch to close_resets_only=False.</span>
</span><span id="1-1714">        <span class="k">if</span> <span class="n">close_resets_only</span> <span class="ow">or</span> <span class="n">close_resets_only</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">:</span>
</span><span id="1-1715">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSE_IS_RESET</span>
</span><span id="1-1716">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1717">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">ACTIVE</span>
</span><span id="1-1718">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1719">            <span class="n">join_transaction_mode</span>
</span><span id="1-1720">            <span class="ow">and</span> <span class="n">join_transaction_mode</span>
</span><span id="1-1721">            <span class="ow">not</span> <span class="ow">in</span> <span class="n">JoinTransactionMode</span><span class="o">.</span><span class="n">__args__</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1722">        <span class="p">):</span>
</span><span id="1-1723">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1724">                <span class="sa">f</span><span class="s2">&quot;invalid selection for join_transaction_mode: &quot;</span>
</span><span id="1-1725">                <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">join_transaction_mode</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="1-1726">            <span class="p">)</span>
</span><span id="1-1727">        <span class="bp">self</span><span class="o">.</span><span class="n">join_transaction_mode</span> <span class="o">=</span> <span class="n">join_transaction_mode</span>
</span><span id="1-1728">
</span><span id="1-1729">        <span class="bp">self</span><span class="o">.</span><span class="n">twophase</span> <span class="o">=</span> <span class="n">twophase</span>
</span><span id="1-1730">        <span class="bp">self</span><span class="o">.</span><span class="n">_query_cls</span> <span class="o">=</span> <span class="n">query_cls</span> <span class="k">if</span> <span class="n">query_cls</span> <span class="k">else</span> <span class="n">query</span><span class="o">.</span><span class="n">Query</span>
</span><span id="1-1731">        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
</span><span id="1-1732">            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="1-1733">
</span><span id="1-1734">        <span class="k">if</span> <span class="n">binds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1735">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">bind</span> <span class="ow">in</span> <span class="n">binds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1736">                <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span id="1-1737">
</span><span id="1-1738">        <span class="n">_sessions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-1739">
</span><span id="1-1740">    <span class="c1"># used by sqlalchemy.engine.util.TransactionalContext</span>
</span><span id="1-1741">    <span class="n">_trans_context_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransactionalContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1742">
</span><span id="1-1743">    <span class="n">connection_callable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_ConnectionCallableProto</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1744">
</span><span id="1-1745">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_S</span><span class="p">:</span>
</span><span id="1-1746">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-1747">
</span><span id="1-1748">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1749">        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-1750">
</span><span id="1-1751">    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="1-1752">    <span class="k">def</span> <span class="nf">_maker_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">_S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">_S</span><span class="p">]:</span>
</span><span id="1-1753">        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="1-1754">            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
</span><span id="1-1755">                <span class="k">yield</span> <span class="bp">self</span>
</span><span id="1-1756">
</span><span id="1-1757">    <span class="k">def</span> <span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1758"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a transaction.</span>
</span><span id="1-1759">
</span><span id="1-1760"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1761">
</span><span id="1-1762"><span class="sd">        .. seealso::</span>
</span><span id="1-1763">
</span><span id="1-1764"><span class="sd">            :attr:`_orm.Session.is_active`</span>
</span><span id="1-1765">
</span><span id="1-1766">
</span><span id="1-1767"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1768">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1769">
</span><span id="1-1770">    <span class="k">def</span> <span class="nf">in_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1771"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this :class:`_orm.Session` has begun a nested</span>
</span><span id="1-1772"><span class="sd">        transaction, e.g. SAVEPOINT.</span>
</span><span id="1-1773">
</span><span id="1-1774"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1775">
</span><span id="1-1776"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1777">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1778">
</span><span id="1-1779">    <span class="k">def</span> <span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span id="1-1780"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current root transaction in progress, if any.</span>
</span><span id="1-1781">
</span><span id="1-1782"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1783">
</span><span id="1-1784"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1785">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1786">        <span class="k">while</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">trans</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1787">            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_parent</span>
</span><span id="1-1788">        <span class="k">return</span> <span class="n">trans</span>
</span><span id="1-1789">
</span><span id="1-1790">    <span class="k">def</span> <span class="nf">get_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SessionTransaction</span><span class="p">]:</span>
</span><span id="1-1791"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current nested transaction in progress, if any.</span>
</span><span id="1-1792">
</span><span id="1-1793"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-1794">
</span><span id="1-1795"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1796">
</span><span id="1-1797">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span>
</span><span id="1-1798">
</span><span id="1-1799">    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
</span><span id="1-1800">    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
</span><span id="1-1801"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A user-modifiable dictionary.</span>
</span><span id="1-1802">
</span><span id="1-1803"><span class="sd">        The initial value of this dictionary can be populated using the</span>
</span><span id="1-1804"><span class="sd">        ``info`` argument to the :class:`.Session` constructor or</span>
</span><span id="1-1805"><span class="sd">        :class:`.sessionmaker` constructor or factory methods.  The dictionary</span>
</span><span id="1-1806"><span class="sd">        here is always local to this :class:`.Session` and can be modified</span>
</span><span id="1-1807"><span class="sd">        independently of all other :class:`.Session` objects.</span>
</span><span id="1-1808">
</span><span id="1-1809"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1810">        <span class="k">return</span> <span class="p">{}</span>
</span><span id="1-1811">
</span><span id="1-1812">    <span class="k">def</span> <span class="nf">_autobegin_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span id="1-1813">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1814">            <span class="k">if</span> <span class="ow">not</span> <span class="n">begin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autobegin</span><span class="p">:</span>
</span><span id="1-1815">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1816">                    <span class="s2">&quot;Autobegin is disabled on this Session; please call &quot;</span>
</span><span id="1-1817">                    <span class="s2">&quot;session.begin() to start a new transaction&quot;</span>
</span><span id="1-1818">                <span class="p">)</span>
</span><span id="1-1819">            <span class="n">trans</span> <span class="o">=</span> <span class="n">SessionTransaction</span><span class="p">(</span>
</span><span id="1-1820">                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1821">                <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">BEGIN</span>
</span><span id="1-1822">                <span class="k">if</span> <span class="n">begin</span>
</span><span id="1-1823">                <span class="k">else</span> <span class="n">SessionTransactionOrigin</span><span class="o">.</span><span class="n">AUTOBEGIN</span><span class="p">,</span>
</span><span id="1-1824">            <span class="p">)</span>
</span><span id="1-1825">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="n">trans</span>
</span><span id="1-1826">            <span class="k">return</span> <span class="n">trans</span>
</span><span id="1-1827">
</span><span id="1-1828">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1829">
</span><span id="1-1830">    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span id="1-1831"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a transaction, or nested transaction,</span>
</span><span id="1-1832"><span class="sd">        on this :class:`.Session`, if one is not already begun.</span>
</span><span id="1-1833">
</span><span id="1-1834"><span class="sd">        The :class:`_orm.Session` object features **autobegin** behavior,</span>
</span><span id="1-1835"><span class="sd">        so that normally it is not necessary to call the</span>
</span><span id="1-1836"><span class="sd">        :meth:`_orm.Session.begin`</span>
</span><span id="1-1837"><span class="sd">        method explicitly. However, it may be used in order to control</span>
</span><span id="1-1838"><span class="sd">        the scope of when the transactional state is begun.</span>
</span><span id="1-1839">
</span><span id="1-1840"><span class="sd">        When used to begin the outermost transaction, an error is raised</span>
</span><span id="1-1841"><span class="sd">        if this :class:`.Session` is already inside of a transaction.</span>
</span><span id="1-1842">
</span><span id="1-1843"><span class="sd">        :param nested: if True, begins a SAVEPOINT transaction and is</span>
</span><span id="1-1844"><span class="sd">         equivalent to calling :meth:`~.Session.begin_nested`. For</span>
</span><span id="1-1845"><span class="sd">         documentation on SAVEPOINT transactions, please see</span>
</span><span id="1-1846"><span class="sd">         :ref:`session_begin_nested`.</span>
</span><span id="1-1847">
</span><span id="1-1848"><span class="sd">        :return: the :class:`.SessionTransaction` object.  Note that</span>
</span><span id="1-1849"><span class="sd">         :class:`.SessionTransaction`</span>
</span><span id="1-1850"><span class="sd">         acts as a Python context manager, allowing :meth:`.Session.begin`</span>
</span><span id="1-1851"><span class="sd">         to be used in a &quot;with&quot; block.  See :ref:`session_explicit_begin` for</span>
</span><span id="1-1852"><span class="sd">         an example.</span>
</span><span id="1-1853">
</span><span id="1-1854"><span class="sd">        .. seealso::</span>
</span><span id="1-1855">
</span><span id="1-1856"><span class="sd">            :ref:`session_autobegin`</span>
</span><span id="1-1857">
</span><span id="1-1858"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span id="1-1859">
</span><span id="1-1860"><span class="sd">            :meth:`.Session.begin_nested`</span>
</span><span id="1-1861">
</span><span id="1-1862">
</span><span id="1-1863"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1864">
</span><span id="1-1865">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1866">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1867">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1868">
</span><span id="1-1869">            <span class="k">if</span> <span class="ow">not</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="1-1870">                <span class="k">return</span> <span class="n">trans</span>
</span><span id="1-1871">
</span><span id="1-1872">        <span class="k">assert</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1873">
</span><span id="1-1874">        <span class="k">if</span> <span class="n">nested</span><span class="p">:</span>
</span><span id="1-1875">            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_begin</span><span class="p">(</span><span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">)</span>
</span><span id="1-1876">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="n">trans</span>
</span><span id="1-1877">            <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="n">trans</span>
</span><span id="1-1878">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1879">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1880">                <span class="s2">&quot;A transaction is already begun on this Session.&quot;</span>
</span><span id="1-1881">            <span class="p">)</span>
</span><span id="1-1882">
</span><span id="1-1883">        <span class="k">return</span> <span class="n">trans</span>  <span class="c1"># needed for __enter__/__exit__ hook</span>
</span><span id="1-1884">
</span><span id="1-1885">    <span class="k">def</span> <span class="nf">begin_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SessionTransaction</span><span class="p">:</span>
</span><span id="1-1886"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a &quot;nested&quot; transaction on this Session, e.g. SAVEPOINT.</span>
</span><span id="1-1887">
</span><span id="1-1888"><span class="sd">        The target database(s) and associated drivers must support SQL</span>
</span><span id="1-1889"><span class="sd">        SAVEPOINT for this method to function correctly.</span>
</span><span id="1-1890">
</span><span id="1-1891"><span class="sd">        For documentation on SAVEPOINT</span>
</span><span id="1-1892"><span class="sd">        transactions, please see :ref:`session_begin_nested`.</span>
</span><span id="1-1893">
</span><span id="1-1894"><span class="sd">        :return: the :class:`.SessionTransaction` object.  Note that</span>
</span><span id="1-1895"><span class="sd">         :class:`.SessionTransaction` acts as a context manager, allowing</span>
</span><span id="1-1896"><span class="sd">         :meth:`.Session.begin_nested` to be used in a &quot;with&quot; block.</span>
</span><span id="1-1897"><span class="sd">         See :ref:`session_begin_nested` for a usage example.</span>
</span><span id="1-1898">
</span><span id="1-1899"><span class="sd">        .. seealso::</span>
</span><span id="1-1900">
</span><span id="1-1901"><span class="sd">            :ref:`session_begin_nested`</span>
</span><span id="1-1902">
</span><span id="1-1903"><span class="sd">            :ref:`pysqlite_serializable` - special workarounds required</span>
</span><span id="1-1904"><span class="sd">            with the SQLite driver in order for SAVEPOINT to work</span>
</span><span id="1-1905"><span class="sd">            correctly.</span>
</span><span id="1-1906">
</span><span id="1-1907"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1908">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1909">
</span><span id="1-1910">    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1911"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rollback the current transaction in progress.</span>
</span><span id="1-1912">
</span><span id="1-1913"><span class="sd">        If no transaction is in progress, this method is a pass-through.</span>
</span><span id="1-1914">
</span><span id="1-1915"><span class="sd">        The method always rolls back</span>
</span><span id="1-1916"><span class="sd">        the topmost database transaction, discarding any nested</span>
</span><span id="1-1917"><span class="sd">        transactions that may be in progress.</span>
</span><span id="1-1918">
</span><span id="1-1919"><span class="sd">        .. seealso::</span>
</span><span id="1-1920">
</span><span id="1-1921"><span class="sd">            :ref:`session_rollback`</span>
</span><span id="1-1922">
</span><span id="1-1923"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span id="1-1924">
</span><span id="1-1925"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1926">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1927">            <span class="k">pass</span>
</span><span id="1-1928">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1929">            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1930">
</span><span id="1-1931">    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1932"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush pending changes and commit the current transaction.</span>
</span><span id="1-1933">
</span><span id="1-1934"><span class="sd">        When the COMMIT operation is complete, all objects are fully</span>
</span><span id="1-1935"><span class="sd">        :term:`expired`, erasing their internal contents, which will be</span>
</span><span id="1-1936"><span class="sd">        automatically re-loaded when the objects are next accessed. In the</span>
</span><span id="1-1937"><span class="sd">        interim, these objects are in an expired state and will not function if</span>
</span><span id="1-1938"><span class="sd">        they are :term:`detached` from the :class:`.Session`. Additionally,</span>
</span><span id="1-1939"><span class="sd">        this re-load operation is not supported when using asyncio-oriented</span>
</span><span id="1-1940"><span class="sd">        APIs. The :paramref:`.Session.expire_on_commit` parameter may be used</span>
</span><span id="1-1941"><span class="sd">        to disable this behavior.</span>
</span><span id="1-1942">
</span><span id="1-1943"><span class="sd">        When there is no transaction in place for the :class:`.Session`,</span>
</span><span id="1-1944"><span class="sd">        indicating that no operations were invoked on this :class:`.Session`</span>
</span><span id="1-1945"><span class="sd">        since the previous call to :meth:`.Session.commit`, the method will</span>
</span><span id="1-1946"><span class="sd">        begin and commit an internal-only &quot;logical&quot; transaction, that does not</span>
</span><span id="1-1947"><span class="sd">        normally affect the database unless pending flush changes were</span>
</span><span id="1-1948"><span class="sd">        detected, but will still invoke event handlers and object expiration</span>
</span><span id="1-1949"><span class="sd">        rules.</span>
</span><span id="1-1950">
</span><span id="1-1951"><span class="sd">        The outermost database transaction is committed unconditionally,</span>
</span><span id="1-1952"><span class="sd">        automatically releasing any SAVEPOINTs in effect.</span>
</span><span id="1-1953">
</span><span id="1-1954"><span class="sd">        .. seealso::</span>
</span><span id="1-1955">
</span><span id="1-1956"><span class="sd">            :ref:`session_committing`</span>
</span><span id="1-1957">
</span><span id="1-1958"><span class="sd">            :ref:`unitofwork_transaction`</span>
</span><span id="1-1959">
</span><span id="1-1960"><span class="sd">            :ref:`asyncio_orm_avoid_lazyloads`</span>
</span><span id="1-1961">
</span><span id="1-1962"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1963">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1964">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1965">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span id="1-1966">
</span><span id="1-1967">        <span class="n">trans</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">_to_root</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-1968">
</span><span id="1-1969">    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1970"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the current transaction in progress for two phase commit.</span>
</span><span id="1-1971">
</span><span id="1-1972"><span class="sd">        If no transaction is in progress, this method raises an</span>
</span><span id="1-1973"><span class="sd">        :exc:`~sqlalchemy.exc.InvalidRequestError`.</span>
</span><span id="1-1974">
</span><span id="1-1975"><span class="sd">        Only root transactions of two phase sessions can be prepared. If the</span>
</span><span id="1-1976"><span class="sd">        current transaction is not such, an</span>
</span><span id="1-1977"><span class="sd">        :exc:`~sqlalchemy.exc.InvalidRequestError` is raised.</span>
</span><span id="1-1978">
</span><span id="1-1979"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1980">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-1981">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1982">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span id="1-1983">
</span><span id="1-1984">        <span class="n">trans</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
</span><span id="1-1985">
</span><span id="1-1986">    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span>
</span><span id="1-1987">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1988">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1989">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1990">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span id="1-1991"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a :class:`_engine.Connection` object corresponding to this</span>
</span><span id="1-1992"><span class="sd">        :class:`.Session` object&#39;s transactional state.</span>
</span><span id="1-1993">
</span><span id="1-1994"><span class="sd">        Either the :class:`_engine.Connection` corresponding to the current</span>
</span><span id="1-1995"><span class="sd">        transaction is returned, or if no transaction is in progress, a new</span>
</span><span id="1-1996"><span class="sd">        one is begun and the :class:`_engine.Connection`</span>
</span><span id="1-1997"><span class="sd">        returned (note that no</span>
</span><span id="1-1998"><span class="sd">        transactional state is established with the DBAPI until the first</span>
</span><span id="1-1999"><span class="sd">        SQL statement is emitted).</span>
</span><span id="1-2000">
</span><span id="1-2001"><span class="sd">        Ambiguity in multi-bind or unbound :class:`.Session` objects can be</span>
</span><span id="1-2002"><span class="sd">        resolved through any of the optional keyword arguments.   This</span>
</span><span id="1-2003"><span class="sd">        ultimately makes usage of the :meth:`.get_bind` method for resolution.</span>
</span><span id="1-2004">
</span><span id="1-2005"><span class="sd">        :param bind_arguments: dictionary of bind arguments.  May include</span>
</span><span id="1-2006"><span class="sd">         &quot;mapper&quot;, &quot;bind&quot;, &quot;clause&quot;, other custom arguments that are passed</span>
</span><span id="1-2007"><span class="sd">         to :meth:`.Session.get_bind`.</span>
</span><span id="1-2008">
</span><span id="1-2009"><span class="sd">        :param execution_options: a dictionary of execution options that will</span>
</span><span id="1-2010"><span class="sd">         be passed to :meth:`_engine.Connection.execution_options`, **when the</span>
</span><span id="1-2011"><span class="sd">         connection is first procured only**.   If the connection is already</span>
</span><span id="1-2012"><span class="sd">         present within the :class:`.Session`, a warning is emitted and</span>
</span><span id="1-2013"><span class="sd">         the arguments are ignored.</span>
</span><span id="1-2014">
</span><span id="1-2015"><span class="sd">         .. seealso::</span>
</span><span id="1-2016">
</span><span id="1-2017"><span class="sd">            :ref:`session_transaction_isolation`</span>
</span><span id="1-2018">
</span><span id="1-2019"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2020">
</span><span id="1-2021">        <span class="k">if</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span id="1-2022">            <span class="n">bind</span> <span class="o">=</span> <span class="n">bind_arguments</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;bind&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2023">
</span><span id="1-2024">            <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2025">                <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="o">**</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span id="1-2026">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2027">            <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
</span><span id="1-2028">
</span><span id="1-2029">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span>
</span><span id="1-2030">            <span class="n">bind</span><span class="p">,</span>
</span><span id="1-2031">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2032">        <span class="p">)</span>
</span><span id="1-2033">
</span><span id="1-2034">    <span class="k">def</span> <span class="nf">_connection_for_bind</span><span class="p">(</span>
</span><span id="1-2035">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2036">        <span class="n">engine</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">,</span>
</span><span id="1-2037">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2038">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2039">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
</span><span id="1-2040">        <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-2041">
</span><span id="1-2042">        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-2043">        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2044">            <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span id="1-2045">        <span class="k">return</span> <span class="n">trans</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">)</span>
</span><span id="1-2046">
</span><span id="1-2047">    <span class="nd">@overload</span>
</span><span id="1-2048">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span id="1-2049">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2050">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2051">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2052">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2053">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2054">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2055">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2056">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2057">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2058">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-2059">        <span class="o">...</span>
</span><span id="1-2060">
</span><span id="1-2061">    <span class="nd">@overload</span>
</span><span id="1-2062">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span id="1-2063">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2064">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2065">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2066">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2067">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2068">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2069">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2070">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2071">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-2072">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2073">        <span class="o">...</span>
</span><span id="1-2074">
</span><span id="1-2075">    <span class="k">def</span> <span class="nf">_execute_internal</span><span class="p">(</span>
</span><span id="1-2076">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2077">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2078">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2079">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2080">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2081">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2082">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2083">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2084">        <span class="n">_scalar_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-2085">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-2086">        <span class="n">statement</span> <span class="o">=</span> <span class="n">coercions</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">roles</span><span class="o">.</span><span class="n">StatementRole</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
</span><span id="1-2087">
</span><span id="1-2088">        <span class="k">if</span> <span class="ow">not</span> <span class="n">bind_arguments</span><span class="p">:</span>
</span><span id="1-2089">            <span class="n">bind_arguments</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-2090">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2091">            <span class="n">bind_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span id="1-2092">
</span><span id="1-2093">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2094">            <span class="n">statement</span><span class="o">.</span><span class="n">_propagate_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compile_state_plugin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2095">            <span class="o">==</span> <span class="s2">&quot;orm&quot;</span>
</span><span id="1-2096">        <span class="p">):</span>
</span><span id="1-2097">            <span class="n">compile_state_cls</span> <span class="o">=</span> <span class="n">CompileState</span><span class="o">.</span><span class="n">_get_plugin_class_for_plugin</span><span class="p">(</span>
</span><span id="1-2098">                <span class="n">statement</span><span class="p">,</span> <span class="s2">&quot;orm&quot;</span>
</span><span id="1-2099">            <span class="p">)</span>
</span><span id="1-2100">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-2101">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-2102">                    <span class="n">compile_state_cls</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">AbstractORMCompileState</span>
</span><span id="1-2103">                <span class="p">)</span>
</span><span id="1-2104">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2105">            <span class="n">compile_state_cls</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-2106">            <span class="n">bind_arguments</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;clause&quot;</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
</span><span id="1-2107">
</span><span id="1-2108">        <span class="n">execution_options</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">coerce_to_immutabledict</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span>
</span><span id="1-2109">
</span><span id="1-2110">        <span class="k">if</span> <span class="n">_parent_execute_state</span><span class="p">:</span>
</span><span id="1-2111">            <span class="n">events_todo</span> <span class="o">=</span> <span class="n">_parent_execute_state</span><span class="o">.</span><span class="n">_remaining_events</span><span class="p">()</span>
</span><span id="1-2112">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2113">            <span class="n">events_todo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_orm_execute</span>
</span><span id="1-2114">            <span class="k">if</span> <span class="n">_add_event</span><span class="p">:</span>
</span><span id="1-2115">                <span class="n">events_todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">events_todo</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">_add_event</span><span class="p">]</span>
</span><span id="1-2116">
</span><span id="1-2117">        <span class="k">if</span> <span class="n">events_todo</span><span class="p">:</span>
</span><span id="1-2118">            <span class="k">if</span> <span class="n">compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2119">                <span class="c1"># for event handlers, do the orm_pre_session_exec</span>
</span><span id="1-2120">                <span class="c1"># pass ahead of the event handlers, so that things like</span>
</span><span id="1-2121">                <span class="c1"># .load_options, .update_delete_options etc. are populated.</span>
</span><span id="1-2122">                <span class="c1"># is_pre_event=True allows the hook to hold off on things</span>
</span><span id="1-2123">                <span class="c1"># it doesn&#39;t want to do twice, including autoflush as well</span>
</span><span id="1-2124">                <span class="c1"># as &quot;pre fetch&quot; for DML, etc.</span>
</span><span id="1-2125">                <span class="p">(</span>
</span><span id="1-2126">                    <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2127">                    <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2128">                <span class="p">)</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_pre_session_exec</span><span class="p">(</span>
</span><span id="1-2129">                    <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2130">                    <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2131">                    <span class="n">params</span><span class="p">,</span>
</span><span id="1-2132">                    <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2133">                    <span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2134">                    <span class="kc">True</span><span class="p">,</span>
</span><span id="1-2135">                <span class="p">)</span>
</span><span id="1-2136">
</span><span id="1-2137">            <span class="n">orm_exec_state</span> <span class="o">=</span> <span class="n">ORMExecuteState</span><span class="p">(</span>
</span><span id="1-2138">                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2139">                <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2140">                <span class="n">params</span><span class="p">,</span>
</span><span id="1-2141">                <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2142">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2143">                <span class="n">compile_state_cls</span><span class="p">,</span>
</span><span id="1-2144">                <span class="n">events_todo</span><span class="p">,</span>
</span><span id="1-2145">            <span class="p">)</span>
</span><span id="1-2146">            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events_todo</span><span class="p">):</span>
</span><span id="1-2147">                <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">_starting_event_idx</span> <span class="o">=</span> <span class="n">idx</span>
</span><span id="1-2148">                <span class="n">fn_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">orm_exec_state</span><span class="p">)</span>
</span><span id="1-2149">                <span class="k">if</span> <span class="n">fn_result</span><span class="p">:</span>
</span><span id="1-2150">                    <span class="k">if</span> <span class="n">_scalar_result</span><span class="p">:</span>
</span><span id="1-2151">                        <span class="k">return</span> <span class="n">fn_result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
</span><span id="1-2152">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2153">                        <span class="k">return</span> <span class="n">fn_result</span>
</span><span id="1-2154">
</span><span id="1-2155">            <span class="n">statement</span> <span class="o">=</span> <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">statement</span>
</span><span id="1-2156">            <span class="n">execution_options</span> <span class="o">=</span> <span class="n">orm_exec_state</span><span class="o">.</span><span class="n">local_execution_options</span>
</span><span id="1-2157">
</span><span id="1-2158">        <span class="k">if</span> <span class="n">compile_state_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2159">            <span class="c1"># now run orm_pre_session_exec() &quot;for real&quot;.   if there were</span>
</span><span id="1-2160">            <span class="c1"># event hooks, this will re-run the steps that interpret</span>
</span><span id="1-2161">            <span class="c1"># new execution_options into load_options / update_delete_options,</span>
</span><span id="1-2162">            <span class="c1"># which we assume the event hook might have updated.</span>
</span><span id="1-2163">            <span class="c1"># autoflush will also be invoked in this step if enabled.</span>
</span><span id="1-2164">            <span class="p">(</span>
</span><span id="1-2165">                <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2166">                <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2167">            <span class="p">)</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_pre_session_exec</span><span class="p">(</span>
</span><span id="1-2168">                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2169">                <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2170">                <span class="n">params</span><span class="p">,</span>
</span><span id="1-2171">                <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2172">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2173">                <span class="kc">False</span><span class="p">,</span>
</span><span id="1-2174">            <span class="p">)</span>
</span><span id="1-2175">
</span><span id="1-2176">        <span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bind</span><span class="p">(</span><span class="o">**</span><span class="n">bind_arguments</span><span class="p">)</span>
</span><span id="1-2177">
</span><span id="1-2178">        <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_for_bind</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
</span><span id="1-2179">
</span><span id="1-2180">        <span class="k">if</span> <span class="n">_scalar_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compile_state_cls</span><span class="p">:</span>
</span><span id="1-2181">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-2182">                <span class="n">params</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">_CoreSingleExecuteParams</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="1-2183">            <span class="k">return</span> <span class="n">conn</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
</span><span id="1-2184">                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span>
</span><span id="1-2185">            <span class="p">)</span>
</span><span id="1-2186">
</span><span id="1-2187">        <span class="k">if</span> <span class="n">compile_state_cls</span><span class="p">:</span>
</span><span id="1-2188">            <span class="n">result</span><span class="p">:</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">compile_state_cls</span><span class="o">.</span><span class="n">orm_execute_statement</span><span class="p">(</span>
</span><span id="1-2189">                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2190">                <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2191">                <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span>
</span><span id="1-2192">                <span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2193">                <span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2194">                <span class="n">conn</span><span class="p">,</span>
</span><span id="1-2195">            <span class="p">)</span>
</span><span id="1-2196">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2197">            <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span id="1-2198">                <span class="n">statement</span><span class="p">,</span> <span class="n">params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span>
</span><span id="1-2199">            <span class="p">)</span>
</span><span id="1-2200">
</span><span id="1-2201">        <span class="k">if</span> <span class="n">_scalar_result</span><span class="p">:</span>
</span><span id="1-2202">            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
</span><span id="1-2203">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2204">            <span class="k">return</span> <span class="n">result</span>
</span><span id="1-2205">
</span><span id="1-2206">    <span class="nd">@overload</span>
</span><span id="1-2207">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span id="1-2208">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2209">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-2210">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2211">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2212">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2213">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2214">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2215">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2216">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-2217">        <span class="o">...</span>
</span><span id="1-2218">
</span><span id="1-2219">    <span class="nd">@overload</span>
</span><span id="1-2220">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span id="1-2221">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2222">        <span class="n">statement</span><span class="p">:</span> <span class="n">UpdateBase</span><span class="p">,</span>
</span><span id="1-2223">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2224">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2225">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2226">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2227">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2228">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2229">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2230">        <span class="o">...</span>
</span><span id="1-2231">
</span><span id="1-2232">    <span class="nd">@overload</span>
</span><span id="1-2233">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span id="1-2234">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2235">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2236">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2237">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2238">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2239">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2240">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2241">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2242">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2243">        <span class="o">...</span>
</span><span id="1-2244">
</span><span id="1-2245">    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
</span><span id="1-2246">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2247">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2248">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2249">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2250">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2251">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2252">        <span class="n">_parent_execute_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2253">        <span class="n">_add_event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2254">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2255"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Execute a SQL expression construct.</span>
</span><span id="1-2256">
</span><span id="1-2257"><span class="sd">        Returns a :class:`_engine.Result` object representing</span>
</span><span id="1-2258"><span class="sd">        results of the statement execution.</span>
</span><span id="1-2259">
</span><span id="1-2260"><span class="sd">        E.g.::</span>
</span><span id="1-2261">
</span><span id="1-2262"><span class="sd">            from sqlalchemy import select</span>
</span><span id="1-2263"><span class="sd">            result = session.execute(</span>
</span><span id="1-2264"><span class="sd">                select(User).where(User.id == 5)</span>
</span><span id="1-2265"><span class="sd">            )</span>
</span><span id="1-2266">
</span><span id="1-2267"><span class="sd">        The API contract of :meth:`_orm.Session.execute` is similar to that</span>
</span><span id="1-2268"><span class="sd">        of :meth:`_engine.Connection.execute`, the :term:`2.0 style` version</span>
</span><span id="1-2269"><span class="sd">        of :class:`_engine.Connection`.</span>
</span><span id="1-2270">
</span><span id="1-2271"><span class="sd">        .. versionchanged:: 1.4 the :meth:`_orm.Session.execute` method is</span>
</span><span id="1-2272"><span class="sd">           now the primary point of ORM statement execution when using</span>
</span><span id="1-2273"><span class="sd">           :term:`2.0 style` ORM usage.</span>
</span><span id="1-2274">
</span><span id="1-2275"><span class="sd">        :param statement:</span>
</span><span id="1-2276"><span class="sd">            An executable statement (i.e. an :class:`.Executable` expression</span>
</span><span id="1-2277"><span class="sd">            such as :func:`_expression.select`).</span>
</span><span id="1-2278">
</span><span id="1-2279"><span class="sd">        :param params:</span>
</span><span id="1-2280"><span class="sd">            Optional dictionary, or list of dictionaries, containing</span>
</span><span id="1-2281"><span class="sd">            bound parameter values.   If a single dictionary, single-row</span>
</span><span id="1-2282"><span class="sd">            execution occurs; if a list of dictionaries, an</span>
</span><span id="1-2283"><span class="sd">            &quot;executemany&quot; will be invoked.  The keys in each dictionary</span>
</span><span id="1-2284"><span class="sd">            must correspond to parameter names present in the statement.</span>
</span><span id="1-2285">
</span><span id="1-2286"><span class="sd">        :param execution_options: optional dictionary of execution options,</span>
</span><span id="1-2287"><span class="sd">         which will be associated with the statement execution.  This</span>
</span><span id="1-2288"><span class="sd">         dictionary can provide a subset of the options that are accepted</span>
</span><span id="1-2289"><span class="sd">         by :meth:`_engine.Connection.execution_options`, and may also</span>
</span><span id="1-2290"><span class="sd">         provide additional options understood only in an ORM context.</span>
</span><span id="1-2291">
</span><span id="1-2292"><span class="sd">         .. seealso::</span>
</span><span id="1-2293">
</span><span id="1-2294"><span class="sd">            :ref:`orm_queryguide_execution_options` - ORM-specific execution</span>
</span><span id="1-2295"><span class="sd">            options</span>
</span><span id="1-2296">
</span><span id="1-2297"><span class="sd">        :param bind_arguments: dictionary of additional arguments to determine</span>
</span><span id="1-2298"><span class="sd">         the bind.  May include &quot;mapper&quot;, &quot;bind&quot;, or other custom arguments.</span>
</span><span id="1-2299"><span class="sd">         Contents of this dictionary are passed to the</span>
</span><span id="1-2300"><span class="sd">         :meth:`.Session.get_bind` method.</span>
</span><span id="1-2301">
</span><span id="1-2302"><span class="sd">        :return: a :class:`_engine.Result` object.</span>
</span><span id="1-2303">
</span><span id="1-2304">
</span><span id="1-2305"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2306">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span id="1-2307">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2308">            <span class="n">params</span><span class="p">,</span>
</span><span id="1-2309">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2310">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2311">            <span class="n">_parent_execute_state</span><span class="o">=</span><span class="n">_parent_execute_state</span><span class="p">,</span>
</span><span id="1-2312">            <span class="n">_add_event</span><span class="o">=</span><span class="n">_add_event</span><span class="p">,</span>
</span><span id="1-2313">        <span class="p">)</span>
</span><span id="1-2314">
</span><span id="1-2315">    <span class="nd">@overload</span>
</span><span id="1-2316">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-2317">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2318">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span id="1-2319">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2320">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2321">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2322">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2323">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2324">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-2325">        <span class="o">...</span>
</span><span id="1-2326">
</span><span id="1-2327">    <span class="nd">@overload</span>
</span><span id="1-2328">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-2329">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2330">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2331">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2332">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2333">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2334">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2335">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2336">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-2337">        <span class="o">...</span>
</span><span id="1-2338">
</span><span id="1-2339">    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
</span><span id="1-2340">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2341">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2342">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2343">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2344">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2345">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2346">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2347">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-2348"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return a scalar result.</span>
</span><span id="1-2349">
</span><span id="1-2350"><span class="sd">        Usage and parameters are the same as that of</span>
</span><span id="1-2351"><span class="sd">        :meth:`_orm.Session.execute`; the return result is a scalar Python</span>
</span><span id="1-2352"><span class="sd">        value.</span>
</span><span id="1-2353">
</span><span id="1-2354"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2355">
</span><span id="1-2356">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span id="1-2357">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2358">            <span class="n">params</span><span class="p">,</span>
</span><span id="1-2359">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2360">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2361">            <span class="n">_scalar_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-2362">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-2363">        <span class="p">)</span>
</span><span id="1-2364">
</span><span id="1-2365">    <span class="nd">@overload</span>
</span><span id="1-2366">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-2367">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2368">        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
</span><span id="1-2369">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2370">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2371">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2372">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2373">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2374">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-2375">        <span class="o">...</span>
</span><span id="1-2376">
</span><span id="1-2377">    <span class="nd">@overload</span>
</span><span id="1-2378">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-2379">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2380">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2381">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2382">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2383">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2384">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2385">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2386">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2387">        <span class="o">...</span>
</span><span id="1-2388">
</span><span id="1-2389">    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
</span><span id="1-2390">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2391">        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
</span><span id="1-2392">        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2393">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2394">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2395">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2396">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2397">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2398"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement and return the results as scalars.</span>
</span><span id="1-2399">
</span><span id="1-2400"><span class="sd">        Usage and parameters are the same as that of</span>
</span><span id="1-2401"><span class="sd">        :meth:`_orm.Session.execute`; the return result is a</span>
</span><span id="1-2402"><span class="sd">        :class:`_result.ScalarResult` filtering object which</span>
</span><span id="1-2403"><span class="sd">        will return single elements rather than :class:`_row.Row` objects.</span>
</span><span id="1-2404">
</span><span id="1-2405"><span class="sd">        :return:  a :class:`_result.ScalarResult` object</span>
</span><span id="1-2406">
</span><span id="1-2407"><span class="sd">        .. versionadded:: 1.4.24 Added :meth:`_orm.Session.scalars`</span>
</span><span id="1-2408">
</span><span id="1-2409"><span class="sd">        .. versionadded:: 1.4.26 Added :meth:`_orm.scoped_session.scalars`</span>
</span><span id="1-2410">
</span><span id="1-2411"><span class="sd">        .. seealso::</span>
</span><span id="1-2412">
</span><span id="1-2413"><span class="sd">            :ref:`orm_queryguide_select_orm_entities` - contrasts the behavior</span>
</span><span id="1-2414"><span class="sd">            of :meth:`_orm.Session.execute` to :meth:`_orm.Session.scalars`</span>
</span><span id="1-2415">
</span><span id="1-2416"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2417">
</span><span id="1-2418">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_internal</span><span class="p">(</span>
</span><span id="1-2419">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-2420">            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
</span><span id="1-2421">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-2422">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-2423">            <span class="n">_scalar_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># mypy appreciates this</span>
</span><span id="1-2424">            <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
</span><span id="1-2425">        <span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span>
</span><span id="1-2426">
</span><span id="1-2427">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2428"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span id="1-2429"><span class="sd">        :class:`_orm.Session`.</span>
</span><span id="1-2430">
</span><span id="1-2431"><span class="sd">        This expunges all ORM objects associated with this</span>
</span><span id="1-2432"><span class="sd">        :class:`_orm.Session`, ends any transaction in progress and</span>
</span><span id="1-2433"><span class="sd">        :term:`releases` any :class:`_engine.Connection` objects which this</span>
</span><span id="1-2434"><span class="sd">        :class:`_orm.Session` itself has checked out from associated</span>
</span><span id="1-2435"><span class="sd">        :class:`_engine.Engine` objects. The operation then leaves the</span>
</span><span id="1-2436"><span class="sd">        :class:`_orm.Session` in a state which it may be used again.</span>
</span><span id="1-2437">
</span><span id="1-2438"><span class="sd">        .. tip::</span>
</span><span id="1-2439">
</span><span id="1-2440"><span class="sd">            In the default running mode the :meth:`_orm.Session.close`</span>
</span><span id="1-2441"><span class="sd">            method **does not prevent the Session from being used again**.</span>
</span><span id="1-2442"><span class="sd">            The :class:`_orm.Session` itself does not actually have a</span>
</span><span id="1-2443"><span class="sd">            distinct &quot;closed&quot; state; it merely means</span>
</span><span id="1-2444"><span class="sd">            the :class:`_orm.Session` will release all database connections</span>
</span><span id="1-2445"><span class="sd">            and ORM objects.</span>
</span><span id="1-2446">
</span><span id="1-2447"><span class="sd">            Setting the parameter :paramref:`_orm.Session.close_resets_only`</span>
</span><span id="1-2448"><span class="sd">            to ``False`` will instead make the ``close`` final, meaning that</span>
</span><span id="1-2449"><span class="sd">            any further action on the session will be forbidden.</span>
</span><span id="1-2450">
</span><span id="1-2451"><span class="sd">        .. versionchanged:: 1.4  The :meth:`.Session.close` method does not</span>
</span><span id="1-2452"><span class="sd">           immediately create a new :class:`.SessionTransaction` object;</span>
</span><span id="1-2453"><span class="sd">           instead, the new :class:`.SessionTransaction` is created only if</span>
</span><span id="1-2454"><span class="sd">           the :class:`.Session` is used again for a database operation.</span>
</span><span id="1-2455">
</span><span id="1-2456"><span class="sd">        .. seealso::</span>
</span><span id="1-2457">
</span><span id="1-2458"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span id="1-2459"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span id="1-2460">
</span><span id="1-2461"><span class="sd">            :meth:`_orm.Session.reset` - a similar method that behaves like</span>
</span><span id="1-2462"><span class="sd">            ``close()`` with  the parameter</span>
</span><span id="1-2463"><span class="sd">            :paramref:`_orm.Session.close_resets_only` set to ``True``.</span>
</span><span id="1-2464">
</span><span id="1-2465"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2466">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-2467">
</span><span id="1-2468">    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2469"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close out the transactional resources and ORM objects used by this</span>
</span><span id="1-2470"><span class="sd">        :class:`_orm.Session`, resetting the session to its initial state.</span>
</span><span id="1-2471">
</span><span id="1-2472"><span class="sd">        This method provides for same &quot;reset-only&quot; behavior that the</span>
</span><span id="1-2473"><span class="sd">        :meth:_orm.Session.close method has provided historically, where the</span>
</span><span id="1-2474"><span class="sd">        state of the :class:`_orm.Session` is reset as though the object were</span>
</span><span id="1-2475"><span class="sd">        brand new, and ready to be used again.</span>
</span><span id="1-2476"><span class="sd">        The method may then be useful for :class:`_orm.Session` objects</span>
</span><span id="1-2477"><span class="sd">        which set :paramref:`_orm.Session.close_resets_only` to ``False``,</span>
</span><span id="1-2478"><span class="sd">        so that &quot;reset only&quot; behavior is still available from this method.</span>
</span><span id="1-2479">
</span><span id="1-2480"><span class="sd">        .. versionadded:: 2.0.22</span>
</span><span id="1-2481">
</span><span id="1-2482"><span class="sd">        .. seealso::</span>
</span><span id="1-2483">
</span><span id="1-2484"><span class="sd">            :ref:`session_closing` - detail on the semantics of</span>
</span><span id="1-2485"><span class="sd">            :meth:`_orm.Session.close` and :meth:`_orm.Session.reset`.</span>
</span><span id="1-2486">
</span><span id="1-2487"><span class="sd">            :meth:`_orm.Session.close` - a similar method will additionally</span>
</span><span id="1-2488"><span class="sd">            prevent re-use of the Session when the parameter</span>
</span><span id="1-2489"><span class="sd">            :paramref:`_orm.Session.close_resets_only` is set to ``False``.</span>
</span><span id="1-2490"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2491">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-2492">
</span><span id="1-2493">    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2494"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close this Session, using connection invalidation.</span>
</span><span id="1-2495">
</span><span id="1-2496"><span class="sd">        This is a variant of :meth:`.Session.close` that will additionally</span>
</span><span id="1-2497"><span class="sd">        ensure that the :meth:`_engine.Connection.invalidate`</span>
</span><span id="1-2498"><span class="sd">        method will be called on each :class:`_engine.Connection` object</span>
</span><span id="1-2499"><span class="sd">        that is currently in use for a transaction (typically there is only</span>
</span><span id="1-2500"><span class="sd">        one connection unless the :class:`_orm.Session` is used with</span>
</span><span id="1-2501"><span class="sd">        multiple engines).</span>
</span><span id="1-2502">
</span><span id="1-2503"><span class="sd">        This can be called when the database is known to be in a state where</span>
</span><span id="1-2504"><span class="sd">        the connections are no longer safe to be used.</span>
</span><span id="1-2505">
</span><span id="1-2506"><span class="sd">        Below illustrates a scenario when using `gevent</span>
</span><span id="1-2507"><span class="sd">        &lt;https://www.gevent.org/&gt;`_, which can produce ``Timeout`` exceptions</span>
</span><span id="1-2508"><span class="sd">        that may mean the underlying connection should be discarded::</span>
</span><span id="1-2509">
</span><span id="1-2510"><span class="sd">            import gevent</span>
</span><span id="1-2511">
</span><span id="1-2512"><span class="sd">            try:</span>
</span><span id="1-2513"><span class="sd">                sess = Session()</span>
</span><span id="1-2514"><span class="sd">                sess.add(User())</span>
</span><span id="1-2515"><span class="sd">                sess.commit()</span>
</span><span id="1-2516"><span class="sd">            except gevent.Timeout:</span>
</span><span id="1-2517"><span class="sd">                sess.invalidate()</span>
</span><span id="1-2518"><span class="sd">                raise</span>
</span><span id="1-2519"><span class="sd">            except:</span>
</span><span id="1-2520"><span class="sd">                sess.rollback()</span>
</span><span id="1-2521"><span class="sd">                raise</span>
</span><span id="1-2522">
</span><span id="1-2523"><span class="sd">        The method additionally does everything that :meth:`_orm.Session.close`</span>
</span><span id="1-2524"><span class="sd">        does, including that all ORM objects are expunged.</span>
</span><span id="1-2525">
</span><span id="1-2526"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2527">        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">invalidate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-2528">
</span><span id="1-2529">    <span class="k">def</span> <span class="nf">_close_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">invalidate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">is_reset</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2530">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reset</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="ow">is</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">:</span>
</span><span id="1-2531">            <span class="bp">self</span><span class="o">.</span><span class="n">_close_state</span> <span class="o">=</span> <span class="n">_SessionCloseState</span><span class="o">.</span><span class="n">CLOSED</span>
</span><span id="1-2532">        <span class="bp">self</span><span class="o">.</span><span class="n">expunge_all</span><span class="p">()</span>
</span><span id="1-2533">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2534">            <span class="k">for</span> <span class="n">transaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_iterate_self_and_parents</span><span class="p">():</span>
</span><span id="1-2535">                <span class="n">transaction</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">invalidate</span><span class="p">)</span>
</span><span id="1-2536">
</span><span id="1-2537">    <span class="k">def</span> <span class="nf">expunge_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2538"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all object instances from this ``Session``.</span>
</span><span id="1-2539">
</span><span id="1-2540"><span class="sd">        This is equivalent to calling ``expunge(obj)`` on all objects in this</span>
</span><span id="1-2541"><span class="sd">        ``Session``.</span>
</span><span id="1-2542">
</span><span id="1-2543"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2544">
</span><span id="1-2545">        <span class="n">all_states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">()</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span id="1-2546">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_kill</span><span class="p">()</span>
</span><span id="1-2547">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">WeakInstanceDict</span><span class="p">()</span>
</span><span id="1-2548">        <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-2549">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-2550">
</span><span id="1-2551">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span><span class="n">all_states</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="1-2552">
</span><span id="1-2553">    <span class="k">def</span> <span class="nf">_add_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">_SessionBindKey</span><span class="p">,</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2554">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-2555">            <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-2556">        <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-2557">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span id="1-2558">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-2559">                    <span class="s2">&quot;Not an acceptable bind target: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span id="1-2560">                <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-2561">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2562">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-2563">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2564">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-2565">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp</span><span class="p">,</span> <span class="n">Inspectable</span><span class="p">)</span>
</span><span id="1-2566">
</span><span id="1-2567">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp</span><span class="p">,</span> <span class="n">TableClause</span><span class="p">):</span>
</span><span id="1-2568">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">insp</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-2569">            <span class="k">elif</span> <span class="n">insp_is_mapper</span><span class="p">(</span><span class="n">insp</span><span class="p">):</span>
</span><span id="1-2570">                <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">insp</span><span class="o">.</span><span class="n">class_</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-2571">                <span class="k">for</span> <span class="n">_selectable</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">_all_tables</span><span class="p">:</span>
</span><span id="1-2572">                    <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">_selectable</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-2573">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2574">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-2575">                    <span class="s2">&quot;Not an acceptable bind target: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span>
</span><span id="1-2576">                <span class="p">)</span>
</span><span id="1-2577">
</span><span id="1-2578">    <span class="k">def</span> <span class="nf">bind_mapper</span><span class="p">(</span>
</span><span id="1-2579">        <span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span>
</span><span id="1-2580">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2581"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate a :class:`_orm.Mapper` or arbitrary Python class with a</span>
</span><span id="1-2582"><span class="sd">        &quot;bind&quot;, e.g. an :class:`_engine.Engine` or</span>
</span><span id="1-2583"><span class="sd">        :class:`_engine.Connection`.</span>
</span><span id="1-2584">
</span><span id="1-2585"><span class="sd">        The given entity is added to a lookup used by the</span>
</span><span id="1-2586"><span class="sd">        :meth:`.Session.get_bind` method.</span>
</span><span id="1-2587">
</span><span id="1-2588"><span class="sd">        :param mapper: a :class:`_orm.Mapper` object,</span>
</span><span id="1-2589"><span class="sd">         or an instance of a mapped</span>
</span><span id="1-2590"><span class="sd">         class, or any Python class that is the base of a set of mapped</span>
</span><span id="1-2591"><span class="sd">         classes.</span>
</span><span id="1-2592">
</span><span id="1-2593"><span class="sd">        :param bind: an :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span id="1-2594"><span class="sd">                    object.</span>
</span><span id="1-2595">
</span><span id="1-2596"><span class="sd">        .. seealso::</span>
</span><span id="1-2597">
</span><span id="1-2598"><span class="sd">            :ref:`session_partitioning`</span>
</span><span id="1-2599">
</span><span id="1-2600"><span class="sd">            :paramref:`.Session.binds`</span>
</span><span id="1-2601">
</span><span id="1-2602"><span class="sd">            :meth:`.Session.bind_table`</span>
</span><span id="1-2603">
</span><span id="1-2604">
</span><span id="1-2605"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2606">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span id="1-2607">
</span><span id="1-2608">    <span class="k">def</span> <span class="nf">bind_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">TableClause</span><span class="p">,</span> <span class="n">bind</span><span class="p">:</span> <span class="n">_SessionBind</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2609"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate a :class:`_schema.Table` with a &quot;bind&quot;, e.g. an</span>
</span><span id="1-2610"><span class="sd">        :class:`_engine.Engine`</span>
</span><span id="1-2611"><span class="sd">        or :class:`_engine.Connection`.</span>
</span><span id="1-2612">
</span><span id="1-2613"><span class="sd">        The given :class:`_schema.Table` is added to a lookup used by the</span>
</span><span id="1-2614"><span class="sd">        :meth:`.Session.get_bind` method.</span>
</span><span id="1-2615">
</span><span id="1-2616"><span class="sd">        :param table: a :class:`_schema.Table` object,</span>
</span><span id="1-2617"><span class="sd">         which is typically the target</span>
</span><span id="1-2618"><span class="sd">         of an ORM mapping, or is present within a selectable that is</span>
</span><span id="1-2619"><span class="sd">         mapped.</span>
</span><span id="1-2620">
</span><span id="1-2621"><span class="sd">        :param bind: an :class:`_engine.Engine` or :class:`_engine.Connection`</span>
</span><span id="1-2622"><span class="sd">         object.</span>
</span><span id="1-2623">
</span><span id="1-2624"><span class="sd">        .. seealso::</span>
</span><span id="1-2625">
</span><span id="1-2626"><span class="sd">            :ref:`session_partitioning`</span>
</span><span id="1-2627">
</span><span id="1-2628"><span class="sd">            :paramref:`.Session.binds`</span>
</span><span id="1-2629">
</span><span id="1-2630"><span class="sd">            :meth:`.Session.bind_mapper`</span>
</span><span id="1-2631">
</span><span id="1-2632">
</span><span id="1-2633"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2634">        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bind</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">bind</span><span class="p">)</span>
</span><span id="1-2635">
</span><span id="1-2636">    <span class="k">def</span> <span class="nf">get_bind</span><span class="p">(</span>
</span><span id="1-2637">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2638">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2639">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-2640">        <span class="n">clause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClauseElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2641">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2642">        <span class="n">_sa_skip_events</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2643">        <span class="n">_sa_skip_for_implicit_returning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-2644">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-2645">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Engine</span><span class="p">,</span> <span class="n">Connection</span><span class="p">]:</span>
</span><span id="1-2646"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a &quot;bind&quot; to which this :class:`.Session` is bound.</span>
</span><span id="1-2647">
</span><span id="1-2648"><span class="sd">        The &quot;bind&quot; is usually an instance of :class:`_engine.Engine`,</span>
</span><span id="1-2649"><span class="sd">        except in the case where the :class:`.Session` has been</span>
</span><span id="1-2650"><span class="sd">        explicitly bound directly to a :class:`_engine.Connection`.</span>
</span><span id="1-2651">
</span><span id="1-2652"><span class="sd">        For a multiply-bound or unbound :class:`.Session`, the</span>
</span><span id="1-2653"><span class="sd">        ``mapper`` or ``clause`` arguments are used to determine the</span>
</span><span id="1-2654"><span class="sd">        appropriate bind to return.</span>
</span><span id="1-2655">
</span><span id="1-2656"><span class="sd">        Note that the &quot;mapper&quot; argument is usually present</span>
</span><span id="1-2657"><span class="sd">        when :meth:`.Session.get_bind` is called via an ORM</span>
</span><span id="1-2658"><span class="sd">        operation such as a :meth:`.Session.query`, each</span>
</span><span id="1-2659"><span class="sd">        individual INSERT/UPDATE/DELETE operation within a</span>
</span><span id="1-2660"><span class="sd">        :meth:`.Session.flush`, call, etc.</span>
</span><span id="1-2661">
</span><span id="1-2662"><span class="sd">        The order of resolution is:</span>
</span><span id="1-2663">
</span><span id="1-2664"><span class="sd">        1. if mapper given and :paramref:`.Session.binds` is present,</span>
</span><span id="1-2665"><span class="sd">           locate a bind based first on the mapper in use, then</span>
</span><span id="1-2666"><span class="sd">           on the mapped class in use, then on any base classes that are</span>
</span><span id="1-2667"><span class="sd">           present in the ``__mro__`` of the mapped class, from more specific</span>
</span><span id="1-2668"><span class="sd">           superclasses to more general.</span>
</span><span id="1-2669"><span class="sd">        2. if clause given and ``Session.binds`` is present,</span>
</span><span id="1-2670"><span class="sd">           locate a bind based on :class:`_schema.Table` objects</span>
</span><span id="1-2671"><span class="sd">           found in the given clause present in ``Session.binds``.</span>
</span><span id="1-2672"><span class="sd">        3. if ``Session.binds`` is present, return that.</span>
</span><span id="1-2673"><span class="sd">        4. if clause given, attempt to return a bind</span>
</span><span id="1-2674"><span class="sd">           linked to the :class:`_schema.MetaData` ultimately</span>
</span><span id="1-2675"><span class="sd">           associated with the clause.</span>
</span><span id="1-2676"><span class="sd">        5. if mapper given, attempt to return a bind</span>
</span><span id="1-2677"><span class="sd">           linked to the :class:`_schema.MetaData` ultimately</span>
</span><span id="1-2678"><span class="sd">           associated with the :class:`_schema.Table` or other</span>
</span><span id="1-2679"><span class="sd">           selectable to which the mapper is mapped.</span>
</span><span id="1-2680"><span class="sd">        6. No bind can be found, :exc:`~sqlalchemy.exc.UnboundExecutionError`</span>
</span><span id="1-2681"><span class="sd">           is raised.</span>
</span><span id="1-2682">
</span><span id="1-2683"><span class="sd">        Note that the :meth:`.Session.get_bind` method can be overridden on</span>
</span><span id="1-2684"><span class="sd">        a user-defined subclass of :class:`.Session` to provide any kind</span>
</span><span id="1-2685"><span class="sd">        of bind resolution scheme.  See the example at</span>
</span><span id="1-2686"><span class="sd">        :ref:`session_custom_partitioning`.</span>
</span><span id="1-2687">
</span><span id="1-2688"><span class="sd">        :param mapper:</span>
</span><span id="1-2689"><span class="sd">          Optional mapped class or corresponding :class:`_orm.Mapper` instance.</span>
</span><span id="1-2690"><span class="sd">          The bind can be derived from a :class:`_orm.Mapper` first by</span>
</span><span id="1-2691"><span class="sd">          consulting the &quot;binds&quot; map associated with this :class:`.Session`,</span>
</span><span id="1-2692"><span class="sd">          and secondly by consulting the :class:`_schema.MetaData` associated</span>
</span><span id="1-2693"><span class="sd">          with the :class:`_schema.Table` to which the :class:`_orm.Mapper` is</span>
</span><span id="1-2694"><span class="sd">          mapped for a bind.</span>
</span><span id="1-2695">
</span><span id="1-2696"><span class="sd">        :param clause:</span>
</span><span id="1-2697"><span class="sd">            A :class:`_expression.ClauseElement` (i.e.</span>
</span><span id="1-2698"><span class="sd">            :func:`_expression.select`,</span>
</span><span id="1-2699"><span class="sd">            :func:`_expression.text`,</span>
</span><span id="1-2700"><span class="sd">            etc.).  If the ``mapper`` argument is not present or could not</span>
</span><span id="1-2701"><span class="sd">            produce a bind, the given expression construct will be searched</span>
</span><span id="1-2702"><span class="sd">            for a bound element, typically a :class:`_schema.Table`</span>
</span><span id="1-2703"><span class="sd">            associated with</span>
</span><span id="1-2704"><span class="sd">            bound :class:`_schema.MetaData`.</span>
</span><span id="1-2705">
</span><span id="1-2706"><span class="sd">        .. seealso::</span>
</span><span id="1-2707">
</span><span id="1-2708"><span class="sd">             :ref:`session_partitioning`</span>
</span><span id="1-2709">
</span><span id="1-2710"><span class="sd">             :paramref:`.Session.binds`</span>
</span><span id="1-2711">
</span><span id="1-2712"><span class="sd">             :meth:`.Session.bind_mapper`</span>
</span><span id="1-2713">
</span><span id="1-2714"><span class="sd">             :meth:`.Session.bind_table`</span>
</span><span id="1-2715">
</span><span id="1-2716"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2717">
</span><span id="1-2718">        <span class="c1"># this function is documented as a subclassing hook, so we have</span>
</span><span id="1-2719">        <span class="c1"># to call this method even if the return is simple</span>
</span><span id="1-2720">        <span class="k">if</span> <span class="n">bind</span><span class="p">:</span>
</span><span id="1-2721">            <span class="k">return</span> <span class="n">bind</span>
</span><span id="1-2722">        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span id="1-2723">            <span class="c1"># simplest and most common case, we have a bind and no</span>
</span><span id="1-2724">            <span class="c1"># per-mapper/table binds, we&#39;re done</span>
</span><span id="1-2725">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span id="1-2726">
</span><span id="1-2727">        <span class="c1"># we don&#39;t have self.bind and either have self.__binds</span>
</span><span id="1-2728">        <span class="c1"># or we don&#39;t have self.__binds (which is legacy).  Look at the</span>
</span><span id="1-2729">        <span class="c1"># mapper and the clause</span>
</span><span id="1-2730">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2731">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span id="1-2732">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span id="1-2733">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-2734">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">UnboundExecutionError</span><span class="p">(</span>
</span><span id="1-2735">                    <span class="s2">&quot;This session is not bound to a single Engine or &quot;</span>
</span><span id="1-2736">                    <span class="s2">&quot;Connection, and no context was provided to locate &quot;</span>
</span><span id="1-2737">                    <span class="s2">&quot;a binding.&quot;</span>
</span><span id="1-2738">                <span class="p">)</span>
</span><span id="1-2739">
</span><span id="1-2740">        <span class="c1"># look more closely at the mapper.</span>
</span><span id="1-2741">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2742">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-2743">                <span class="n">inspected_mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
</span><span id="1-2744">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoInspectionAvailable</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-2745">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span id="1-2746">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedClassError</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-2747">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-2748">                    <span class="k">raise</span>
</span><span id="1-2749">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2750">            <span class="n">inspected_mapper</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-2751">
</span><span id="1-2752">        <span class="c1"># match up the mapper or clause in the __binds</span>
</span><span id="1-2753">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span id="1-2754">            <span class="c1"># matching mappers and selectables to entries in the</span>
</span><span id="1-2755">            <span class="c1"># binds dictionary; supported use case.</span>
</span><span id="1-2756">            <span class="k">if</span> <span class="n">inspected_mapper</span><span class="p">:</span>
</span><span id="1-2757">                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">inspected_mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-2758">                    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span id="1-2759">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
</span><span id="1-2760">                <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2761">                    <span class="n">clause</span> <span class="o">=</span> <span class="n">inspected_mapper</span><span class="o">.</span><span class="n">persist_selectable</span>
</span><span id="1-2762">
</span><span id="1-2763">            <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2764">                <span class="n">plugin_subject</span> <span class="o">=</span> <span class="n">clause</span><span class="o">.</span><span class="n">_propagate_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-2765">                    <span class="s2">&quot;plugin_subject&quot;</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="1-2766">                <span class="p">)</span>
</span><span id="1-2767">
</span><span id="1-2768">                <span class="k">if</span> <span class="n">plugin_subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2769">                    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">plugin_subject</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-2770">                        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span id="1-2771">                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
</span><span id="1-2772">
</span><span id="1-2773">                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">visitors</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">clause</span><span class="p">):</span>
</span><span id="1-2774">                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">:</span>
</span><span id="1-2775">                        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-2776">                            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span>
</span><span id="1-2777">                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__binds</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
</span><span id="1-2778">
</span><span id="1-2779">        <span class="c1"># none of the __binds matched, but we have a fallback bind.</span>
</span><span id="1-2780">        <span class="c1"># return that</span>
</span><span id="1-2781">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">:</span>
</span><span id="1-2782">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>
</span><span id="1-2783">
</span><span id="1-2784">        <span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-2785">        <span class="k">if</span> <span class="n">inspected_mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2786">            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mapper </span><span class="si">{</span><span class="n">inspected_mapper</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="1-2787">        <span class="k">if</span> <span class="n">clause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2788">            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SQL expression&quot;</span><span class="p">)</span>
</span><span id="1-2789">
</span><span id="1-2790">        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">UnboundExecutionError</span><span class="p">(</span>
</span><span id="1-2791">            <span class="sa">f</span><span class="s2">&quot;Could not locate a bind configured on &quot;</span>
</span><span id="1-2792">            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="si">}</span><span class="s1"> or this Session.&#39;</span>
</span><span id="1-2793">        <span class="p">)</span>
</span><span id="1-2794">
</span><span id="1-2795">    <span class="nd">@overload</span>
</span><span id="1-2796">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_entity</span><span class="p">:</span> <span class="n">_EntityType</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-2797">        <span class="o">...</span>
</span><span id="1-2798">
</span><span id="1-2799">    <span class="nd">@overload</span>
</span><span id="1-2800">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2801">        <span class="bp">self</span><span class="p">,</span> <span class="n">_colexpr</span><span class="p">:</span> <span class="n">TypedColumnsClauseRole</span><span class="p">[</span><span class="n">_T</span><span class="p">]</span>
</span><span id="1-2802">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span id="1-2803">        <span class="o">...</span>
</span><span id="1-2804">
</span><span id="1-2805">    <span class="c1"># START OVERLOADED FUNCTIONS self.query RowReturningQuery 2-8</span>
</span><span id="1-2806">
</span><span id="1-2807">    <span class="c1"># code within this block is **programmatically,</span>
</span><span id="1-2808">    <span class="c1"># statically generated** by tools/generate_tuple_map_overloads.py</span>
</span><span id="1-2809">
</span><span id="1-2810">    <span class="nd">@overload</span>
</span><span id="1-2811">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2812">        <span class="bp">self</span><span class="p">,</span> <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span> <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">]</span>
</span><span id="1-2813">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">]]:</span>
</span><span id="1-2814">        <span class="o">...</span>
</span><span id="1-2815">
</span><span id="1-2816">    <span class="nd">@overload</span>
</span><span id="1-2817">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2818">        <span class="bp">self</span><span class="p">,</span> <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span> <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span> <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">]</span>
</span><span id="1-2819">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">]]:</span>
</span><span id="1-2820">        <span class="o">...</span>
</span><span id="1-2821">
</span><span id="1-2822">    <span class="nd">@overload</span>
</span><span id="1-2823">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2824">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2825">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span id="1-2826">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span id="1-2827">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span id="1-2828">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span id="1-2829">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">]]:</span>
</span><span id="1-2830">        <span class="o">...</span>
</span><span id="1-2831">
</span><span id="1-2832">    <span class="nd">@overload</span>
</span><span id="1-2833">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2834">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2835">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span id="1-2836">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span id="1-2837">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span id="1-2838">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span id="1-2839">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span id="1-2840">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">]]:</span>
</span><span id="1-2841">        <span class="o">...</span>
</span><span id="1-2842">
</span><span id="1-2843">    <span class="nd">@overload</span>
</span><span id="1-2844">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2845">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2846">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span id="1-2847">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span id="1-2848">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span id="1-2849">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span id="1-2850">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span id="1-2851">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span id="1-2852">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">]]:</span>
</span><span id="1-2853">        <span class="o">...</span>
</span><span id="1-2854">
</span><span id="1-2855">    <span class="nd">@overload</span>
</span><span id="1-2856">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2857">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2858">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span id="1-2859">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span id="1-2860">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span id="1-2861">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span id="1-2862">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span id="1-2863">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span id="1-2864">        <span class="n">__ent6</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T6</span><span class="p">],</span>
</span><span id="1-2865">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">,</span> <span class="n">_T6</span><span class="p">]]:</span>
</span><span id="1-2866">        <span class="o">...</span>
</span><span id="1-2867">
</span><span id="1-2868">    <span class="nd">@overload</span>
</span><span id="1-2869">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2870">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2871">        <span class="n">__ent0</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T0</span><span class="p">],</span>
</span><span id="1-2872">        <span class="n">__ent1</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T1</span><span class="p">],</span>
</span><span id="1-2873">        <span class="n">__ent2</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T2</span><span class="p">],</span>
</span><span id="1-2874">        <span class="n">__ent3</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T3</span><span class="p">],</span>
</span><span id="1-2875">        <span class="n">__ent4</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T4</span><span class="p">],</span>
</span><span id="1-2876">        <span class="n">__ent5</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T5</span><span class="p">],</span>
</span><span id="1-2877">        <span class="n">__ent6</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T6</span><span class="p">],</span>
</span><span id="1-2878">        <span class="n">__ent7</span><span class="p">:</span> <span class="n">_TCCA</span><span class="p">[</span><span class="n">_T7</span><span class="p">],</span>
</span><span id="1-2879">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RowReturningQuery</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T0</span><span class="p">,</span> <span class="n">_T1</span><span class="p">,</span> <span class="n">_T2</span><span class="p">,</span> <span class="n">_T3</span><span class="p">,</span> <span class="n">_T4</span><span class="p">,</span> <span class="n">_T5</span><span class="p">,</span> <span class="n">_T6</span><span class="p">,</span> <span class="n">_T7</span><span class="p">]]:</span>
</span><span id="1-2880">        <span class="o">...</span>
</span><span id="1-2881">
</span><span id="1-2882">    <span class="c1"># END OVERLOADED FUNCTIONS self.query</span>
</span><span id="1-2883">
</span><span id="1-2884">    <span class="nd">@overload</span>
</span><span id="1-2885">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2886">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">:</span> <span class="n">_ColumnsClauseArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-2887">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2888">        <span class="o">...</span>
</span><span id="1-2889">
</span><span id="1-2890">    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span>
</span><span id="1-2891">        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">entities</span><span class="p">:</span> <span class="n">_ColumnsClauseArgument</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-2892">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2893"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new :class:`_query.Query` object corresponding to this</span>
</span><span id="1-2894"><span class="sd">        :class:`_orm.Session`.</span>
</span><span id="1-2895">
</span><span id="1-2896"><span class="sd">        Note that the :class:`_query.Query` object is legacy as of</span>
</span><span id="1-2897"><span class="sd">        SQLAlchemy 2.0; the :func:`_sql.select` construct is now used</span>
</span><span id="1-2898"><span class="sd">        to construct ORM queries.</span>
</span><span id="1-2899">
</span><span id="1-2900"><span class="sd">        .. seealso::</span>
</span><span id="1-2901">
</span><span id="1-2902"><span class="sd">            :ref:`unified_tutorial`</span>
</span><span id="1-2903">
</span><span id="1-2904"><span class="sd">            :ref:`queryguide_toplevel`</span>
</span><span id="1-2905">
</span><span id="1-2906"><span class="sd">            :ref:`query_api_toplevel` - legacy API doc</span>
</span><span id="1-2907">
</span><span id="1-2908"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2909">
</span><span id="1-2910">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_cls</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="1-2911">
</span><span id="1-2912">    <span class="k">def</span> <span class="nf">_identity_lookup</span><span class="p">(</span>
</span><span id="1-2913">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-2914">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-2915">        <span class="n">primary_key_identity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
</span><span id="1-2916">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2917">        <span class="n">passive</span><span class="p">:</span> <span class="n">PassiveFlag</span> <span class="o">=</span> <span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_OFF</span><span class="p">,</span>
</span><span id="1-2918">        <span class="n">lazy_loaded_from</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2919">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-2920">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-2921">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">LoaderCallableStatus</span><span class="p">]:</span>
</span><span id="1-2922"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Locate an object in the identity map.</span>
</span><span id="1-2923">
</span><span id="1-2924"><span class="sd">        Given a primary key identity, constructs an identity key and then</span>
</span><span id="1-2925"><span class="sd">        looks in the session&#39;s identity map.  If present, the object may</span>
</span><span id="1-2926"><span class="sd">        be run through unexpiration rules (e.g. load unloaded attributes,</span>
</span><span id="1-2927"><span class="sd">        check if was deleted).</span>
</span><span id="1-2928">
</span><span id="1-2929"><span class="sd">        e.g.::</span>
</span><span id="1-2930">
</span><span id="1-2931"><span class="sd">            obj = session._identity_lookup(inspect(SomeClass), (1, ))</span>
</span><span id="1-2932">
</span><span id="1-2933"><span class="sd">        :param mapper: mapper in use</span>
</span><span id="1-2934"><span class="sd">        :param primary_key_identity: the primary key we are searching for, as</span>
</span><span id="1-2935"><span class="sd">         a tuple.</span>
</span><span id="1-2936"><span class="sd">        :param identity_token: identity token that should be used to create</span>
</span><span id="1-2937"><span class="sd">         the identity key.  Used as is, however overriding subclasses can</span>
</span><span id="1-2938"><span class="sd">         repurpose this in order to interpret the value in a special way,</span>
</span><span id="1-2939"><span class="sd">         such as if None then look among multiple target tokens.</span>
</span><span id="1-2940"><span class="sd">        :param passive: passive load flag passed to</span>
</span><span id="1-2941"><span class="sd">         :func:`.loading.get_from_identity`, which impacts the behavior if</span>
</span><span id="1-2942"><span class="sd">         the object is found; the object may be validated and/or unexpired</span>
</span><span id="1-2943"><span class="sd">         if the flag allows for SQL to be emitted.</span>
</span><span id="1-2944"><span class="sd">        :param lazy_loaded_from: an :class:`.InstanceState` that is</span>
</span><span id="1-2945"><span class="sd">         specifically asking for this identity as a related identity.  Used</span>
</span><span id="1-2946"><span class="sd">         for sharding schemes where there is a correspondence between an object</span>
</span><span id="1-2947"><span class="sd">         and a related object being lazy-loaded (or otherwise</span>
</span><span id="1-2948"><span class="sd">         relationship-loaded).</span>
</span><span id="1-2949">
</span><span id="1-2950"><span class="sd">        :return: None if the object is not found in the identity map, *or*</span>
</span><span id="1-2951"><span class="sd">         if the object was unexpired and found to have been deleted.</span>
</span><span id="1-2952"><span class="sd">         if passive flags disallow SQL and the object is expired, returns</span>
</span><span id="1-2953"><span class="sd">         PASSIVE_NO_RESULT.   In all other cases the instance is returned.</span>
</span><span id="1-2954">
</span><span id="1-2955"><span class="sd">        .. versionchanged:: 1.4.0 - the :meth:`.Session._identity_lookup`</span>
</span><span id="1-2956"><span class="sd">           method was moved from :class:`_query.Query` to</span>
</span><span id="1-2957"><span class="sd">           :class:`.Session`, to avoid having to instantiate the</span>
</span><span id="1-2958"><span class="sd">           :class:`_query.Query` object.</span>
</span><span id="1-2959">
</span><span id="1-2960">
</span><span id="1-2961"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2962">
</span><span id="1-2963">        <span class="n">key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">identity_key_from_primary_key</span><span class="p">(</span>
</span><span id="1-2964">            <span class="n">primary_key_identity</span><span class="p">,</span> <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span>
</span><span id="1-2965">        <span class="p">)</span>
</span><span id="1-2966">
</span><span id="1-2967">        <span class="c1"># work around: https://github.com/python/typing/discussions/1143</span>
</span><span id="1-2968">        <span class="n">return_value</span> <span class="o">=</span> <span class="n">loading</span><span class="o">.</span><span class="n">get_from_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">passive</span><span class="p">)</span>
</span><span id="1-2969">        <span class="k">return</span> <span class="n">return_value</span>
</span><span id="1-2970">
</span><span id="1-2971">    <span class="nd">@util</span><span class="o">.</span><span class="n">non_memoized_property</span>
</span><span id="1-2972">    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="1-2973">    <span class="k">def</span> <span class="nf">no_autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span id="1-2974"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a context manager that disables autoflush.</span>
</span><span id="1-2975">
</span><span id="1-2976"><span class="sd">        e.g.::</span>
</span><span id="1-2977">
</span><span id="1-2978"><span class="sd">            with session.no_autoflush:</span>
</span><span id="1-2979">
</span><span id="1-2980"><span class="sd">                some_object = SomeClass()</span>
</span><span id="1-2981"><span class="sd">                session.add(some_object)</span>
</span><span id="1-2982"><span class="sd">                # won&#39;t autoflush</span>
</span><span id="1-2983"><span class="sd">                some_object.related_thing = session.query(SomeRelated).first()</span>
</span><span id="1-2984">
</span><span id="1-2985"><span class="sd">        Operations that proceed within the ``with:`` block</span>
</span><span id="1-2986"><span class="sd">        will not be subject to flushes occurring upon query</span>
</span><span id="1-2987"><span class="sd">        access.  This is useful when initializing a series</span>
</span><span id="1-2988"><span class="sd">        of objects which involve existing database queries,</span>
</span><span id="1-2989"><span class="sd">        where the uncompleted object should not yet be flushed.</span>
</span><span id="1-2990">
</span><span id="1-2991"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-2992">        <span class="n">autoflush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span>
</span><span id="1-2993">        <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-2994">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-2995">            <span class="k">yield</span> <span class="bp">self</span>
</span><span id="1-2996">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-2997">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span id="1-2998">
</span><span id="1-2999">    <span class="nd">@util</span><span class="o">.</span><span class="n">langhelpers</span><span class="o">.</span><span class="n">tag_method_for_warnings</span><span class="p">(</span>
</span><span id="1-3000">        <span class="s2">&quot;This warning originated from the Session &#39;autoflush&#39; process, &quot;</span>
</span><span id="1-3001">        <span class="s2">&quot;which was invoked automatically in response to a user-initiated &quot;</span>
</span><span id="1-3002">        <span class="s2">&quot;operation.&quot;</span><span class="p">,</span>
</span><span id="1-3003">        <span class="n">sa_exc</span><span class="o">.</span><span class="n">SAWarning</span><span class="p">,</span>
</span><span id="1-3004">    <span class="p">)</span>
</span><span id="1-3005">    <span class="k">def</span> <span class="nf">_autoflush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3006">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span id="1-3007">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-3008">                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="1-3009">            <span class="k">except</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">StatementError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="1-3010">                <span class="c1"># note we are reraising StatementError as opposed to</span>
</span><span id="1-3011">                <span class="c1"># raising FlushError with &quot;chaining&quot; to remain compatible</span>
</span><span id="1-3012">                <span class="c1"># with code that catches StatementError, IntegrityError,</span>
</span><span id="1-3013">                <span class="c1"># etc.</span>
</span><span id="1-3014">                <span class="n">e</span><span class="o">.</span><span class="n">add_detail</span><span class="p">(</span>
</span><span id="1-3015">                    <span class="s2">&quot;raised as a result of Query-invoked autoflush; &quot;</span>
</span><span id="1-3016">                    <span class="s2">&quot;consider using a session.no_autoflush block if this &quot;</span>
</span><span id="1-3017">                    <span class="s2">&quot;flush is occurring prematurely&quot;</span>
</span><span id="1-3018">                <span class="p">)</span>
</span><span id="1-3019">                <span class="k">raise</span> <span class="n">e</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="1-3020">
</span><span id="1-3021">    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span>
</span><span id="1-3022">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3023">        <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
</span><span id="1-3024">        <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3025">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3026">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3027"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire and refresh attributes on the given instance.</span>
</span><span id="1-3028">
</span><span id="1-3029"><span class="sd">        The selected attributes will first be expired as they would when using</span>
</span><span id="1-3030"><span class="sd">        :meth:`_orm.Session.expire`; then a SELECT statement will be issued to</span>
</span><span id="1-3031"><span class="sd">        the database to refresh column-oriented attributes with the current</span>
</span><span id="1-3032"><span class="sd">        value available in the current transaction.</span>
</span><span id="1-3033">
</span><span id="1-3034"><span class="sd">        :func:`_orm.relationship` oriented attributes will also be immediately</span>
</span><span id="1-3035"><span class="sd">        loaded if they were already eagerly loaded on the object, using the</span>
</span><span id="1-3036"><span class="sd">        same eager loading strategy that they were loaded with originally.</span>
</span><span id="1-3037">
</span><span id="1-3038"><span class="sd">        .. versionadded:: 1.4 - the :meth:`_orm.Session.refresh` method</span>
</span><span id="1-3039"><span class="sd">           can also refresh eagerly loaded attributes.</span>
</span><span id="1-3040">
</span><span id="1-3041"><span class="sd">        :func:`_orm.relationship` oriented attributes that would normally</span>
</span><span id="1-3042"><span class="sd">        load using the ``select`` (or &quot;lazy&quot;) loader strategy will also</span>
</span><span id="1-3043"><span class="sd">        load **if they are named explicitly in the attribute_names</span>
</span><span id="1-3044"><span class="sd">        collection**, emitting a SELECT statement for the attribute using the</span>
</span><span id="1-3045"><span class="sd">        ``immediate`` loader strategy.  If lazy-loaded relationships are not</span>
</span><span id="1-3046"><span class="sd">        named in :paramref:`_orm.Session.refresh.attribute_names`, then</span>
</span><span id="1-3047"><span class="sd">        they remain as &quot;lazy loaded&quot; attributes and are not implicitly</span>
</span><span id="1-3048"><span class="sd">        refreshed.</span>
</span><span id="1-3049">
</span><span id="1-3050"><span class="sd">        .. versionchanged:: 2.0.4  The :meth:`_orm.Session.refresh` method</span>
</span><span id="1-3051"><span class="sd">           will now refresh lazy-loaded :func:`_orm.relationship` oriented</span>
</span><span id="1-3052"><span class="sd">           attributes for those which are named explicitly in the</span>
</span><span id="1-3053"><span class="sd">           :paramref:`_orm.Session.refresh.attribute_names` collection.</span>
</span><span id="1-3054">
</span><span id="1-3055"><span class="sd">        .. tip::</span>
</span><span id="1-3056">
</span><span id="1-3057"><span class="sd">            While the :meth:`_orm.Session.refresh` method is capable of</span>
</span><span id="1-3058"><span class="sd">            refreshing both column and relationship oriented attributes, its</span>
</span><span id="1-3059"><span class="sd">            primary focus is on refreshing of local column-oriented attributes</span>
</span><span id="1-3060"><span class="sd">            on a single instance. For more open ended &quot;refresh&quot; functionality,</span>
</span><span id="1-3061"><span class="sd">            including the ability to refresh the attributes on many objects at</span>
</span><span id="1-3062"><span class="sd">            once while having explicit control over relationship loader</span>
</span><span id="1-3063"><span class="sd">            strategies, use the</span>
</span><span id="1-3064"><span class="sd">            :ref:`populate existing &lt;orm_queryguide_populate_existing&gt;` feature</span>
</span><span id="1-3065"><span class="sd">            instead.</span>
</span><span id="1-3066">
</span><span id="1-3067"><span class="sd">        Note that a highly isolated transaction will return the same values as</span>
</span><span id="1-3068"><span class="sd">        were previously read in that same transaction, regardless of changes</span>
</span><span id="1-3069"><span class="sd">        in database state outside of that transaction.   Refreshing</span>
</span><span id="1-3070"><span class="sd">        attributes usually only makes sense at the start of a transaction</span>
</span><span id="1-3071"><span class="sd">        where database rows have not yet been accessed.</span>
</span><span id="1-3072">
</span><span id="1-3073"><span class="sd">        :param attribute_names: optional.  An iterable collection of</span>
</span><span id="1-3074"><span class="sd">          string attribute names indicating a subset of attributes to</span>
</span><span id="1-3075"><span class="sd">          be refreshed.</span>
</span><span id="1-3076">
</span><span id="1-3077"><span class="sd">        :param with_for_update: optional boolean ``True`` indicating FOR UPDATE</span>
</span><span id="1-3078"><span class="sd">          should be used, or may be a dictionary containing flags to</span>
</span><span id="1-3079"><span class="sd">          indicate a more specific set of FOR UPDATE flags for the SELECT;</span>
</span><span id="1-3080"><span class="sd">          flags should match the parameters of</span>
</span><span id="1-3081"><span class="sd">          :meth:`_query.Query.with_for_update`.</span>
</span><span id="1-3082"><span class="sd">          Supersedes the :paramref:`.Session.refresh.lockmode` parameter.</span>
</span><span id="1-3083">
</span><span id="1-3084"><span class="sd">        .. seealso::</span>
</span><span id="1-3085">
</span><span id="1-3086"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span id="1-3087">
</span><span id="1-3088"><span class="sd">            :meth:`.Session.expire`</span>
</span><span id="1-3089">
</span><span id="1-3090"><span class="sd">            :meth:`.Session.expire_all`</span>
</span><span id="1-3091">
</span><span id="1-3092"><span class="sd">            :ref:`orm_queryguide_populate_existing` - allows any ORM query</span>
</span><span id="1-3093"><span class="sd">            to refresh objects as they would be loaded normally.</span>
</span><span id="1-3094">
</span><span id="1-3095"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3096">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3097">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3098">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3099">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3100">
</span><span id="1-3101">        <span class="bp">self</span><span class="o">.</span><span class="n">_expire_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span id="1-3102">
</span><span id="1-3103">        <span class="c1"># this autoflush previously used to occur as a secondary effect</span>
</span><span id="1-3104">        <span class="c1"># of the load_on_ident below.   Meaning we&#39;d organize the SELECT</span>
</span><span id="1-3105">        <span class="c1"># based on current DB pks, then flush, then if pks changed in that</span>
</span><span id="1-3106">        <span class="c1"># flush, crash.  this was unticketed but discovered as part of</span>
</span><span id="1-3107">        <span class="c1"># #8703.  So here, autoflush up front, dont autoflush inside</span>
</span><span id="1-3108">        <span class="c1"># load_on_ident.</span>
</span><span id="1-3109">        <span class="bp">self</span><span class="o">.</span><span class="n">_autoflush</span><span class="p">()</span>
</span><span id="1-3110">
</span><span id="1-3111">        <span class="k">if</span> <span class="n">with_for_update</span> <span class="o">==</span> <span class="p">{}:</span>
</span><span id="1-3112">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-3113">                <span class="s2">&quot;with_for_update should be the boolean value &quot;</span>
</span><span id="1-3114">                <span class="s2">&quot;True, or a dictionary with options.  &quot;</span>
</span><span id="1-3115">                <span class="s2">&quot;A blank dictionary is ambiguous.&quot;</span>
</span><span id="1-3116">            <span class="p">)</span>
</span><span id="1-3117">
</span><span id="1-3118">        <span class="n">with_for_update</span> <span class="o">=</span> <span class="n">ForUpdateArg</span><span class="o">.</span><span class="n">_from_argument</span><span class="p">(</span><span class="n">with_for_update</span><span class="p">)</span>
</span><span id="1-3119">
</span><span id="1-3120">        <span class="n">stmt</span><span class="p">:</span> <span class="n">Select</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">object_mapper</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</span><span id="1-3121">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-3122">            <span class="n">loading</span><span class="o">.</span><span class="n">load_on_ident</span><span class="p">(</span>
</span><span id="1-3123">                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3124">                <span class="n">stmt</span><span class="p">,</span>
</span><span id="1-3125">                <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
</span><span id="1-3126">                <span class="n">refresh_state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
</span><span id="1-3127">                <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-3128">                <span class="n">only_load_props</span><span class="o">=</span><span class="n">attribute_names</span><span class="p">,</span>
</span><span id="1-3129">                <span class="n">require_pk_cols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-3130">                <span class="c1"># technically unnecessary as we just did autoflush</span>
</span><span id="1-3131">                <span class="c1"># above, however removes the additional unnecessary</span>
</span><span id="1-3132">                <span class="c1"># call to _autoflush()</span>
</span><span id="1-3133">                <span class="n">no_autoflush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-3134">                <span class="n">is_user_refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-3135">            <span class="p">)</span>
</span><span id="1-3136">            <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-3137">        <span class="p">):</span>
</span><span id="1-3138">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3139">                <span class="s2">&quot;Could not refresh instance &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">instance_str</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3140">            <span class="p">)</span>
</span><span id="1-3141">
</span><span id="1-3142">    <span class="k">def</span> <span class="nf">expire_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3143"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expires all persistent instances within this Session.</span>
</span><span id="1-3144">
</span><span id="1-3145"><span class="sd">        When any attributes on a persistent instance is next accessed,</span>
</span><span id="1-3146"><span class="sd">        a query will be issued using the</span>
</span><span id="1-3147"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span id="1-3148"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span id="1-3149"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span id="1-3150"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span id="1-3151"><span class="sd">        in database state outside of that transaction.</span>
</span><span id="1-3152">
</span><span id="1-3153"><span class="sd">        To expire individual objects and individual attributes</span>
</span><span id="1-3154"><span class="sd">        on those objects, use :meth:`Session.expire`.</span>
</span><span id="1-3155">
</span><span id="1-3156"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span id="1-3157"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span id="1-3158"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span id="1-3159"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span id="1-3160"><span class="sd">        calling :meth:`Session.expire_all` is not usually needed,</span>
</span><span id="1-3161"><span class="sd">        assuming the transaction is isolated.</span>
</span><span id="1-3162">
</span><span id="1-3163"><span class="sd">        .. seealso::</span>
</span><span id="1-3164">
</span><span id="1-3165"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span id="1-3166">
</span><span id="1-3167"><span class="sd">            :meth:`.Session.expire`</span>
</span><span id="1-3168">
</span><span id="1-3169"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span id="1-3170">
</span><span id="1-3171"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span id="1-3172">
</span><span id="1-3173"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3174">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">all_states</span><span class="p">():</span>
</span><span id="1-3175">            <span class="n">state</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span id="1-3176">
</span><span id="1-3177">    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span>
</span><span id="1-3178">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-3179">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3180"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire the attributes on an instance.</span>
</span><span id="1-3181">
</span><span id="1-3182"><span class="sd">        Marks the attributes of an instance as out of date. When an expired</span>
</span><span id="1-3183"><span class="sd">        attribute is next accessed, a query will be issued to the</span>
</span><span id="1-3184"><span class="sd">        :class:`.Session` object&#39;s current transactional context in order to</span>
</span><span id="1-3185"><span class="sd">        load all expired attributes for the given instance.   Note that</span>
</span><span id="1-3186"><span class="sd">        a highly isolated transaction will return the same values as were</span>
</span><span id="1-3187"><span class="sd">        previously read in that same transaction, regardless of changes</span>
</span><span id="1-3188"><span class="sd">        in database state outside of that transaction.</span>
</span><span id="1-3189">
</span><span id="1-3190"><span class="sd">        To expire all objects in the :class:`.Session` simultaneously,</span>
</span><span id="1-3191"><span class="sd">        use :meth:`Session.expire_all`.</span>
</span><span id="1-3192">
</span><span id="1-3193"><span class="sd">        The :class:`.Session` object&#39;s default behavior is to</span>
</span><span id="1-3194"><span class="sd">        expire all state whenever the :meth:`Session.rollback`</span>
</span><span id="1-3195"><span class="sd">        or :meth:`Session.commit` methods are called, so that new</span>
</span><span id="1-3196"><span class="sd">        state can be loaded for the new transaction.   For this reason,</span>
</span><span id="1-3197"><span class="sd">        calling :meth:`Session.expire` only makes sense for the specific</span>
</span><span id="1-3198"><span class="sd">        case that a non-ORM SQL statement was emitted in the current</span>
</span><span id="1-3199"><span class="sd">        transaction.</span>
</span><span id="1-3200">
</span><span id="1-3201"><span class="sd">        :param instance: The instance to be refreshed.</span>
</span><span id="1-3202"><span class="sd">        :param attribute_names: optional list of string attribute names</span>
</span><span id="1-3203"><span class="sd">          indicating a subset of attributes to be expired.</span>
</span><span id="1-3204">
</span><span id="1-3205"><span class="sd">        .. seealso::</span>
</span><span id="1-3206">
</span><span id="1-3207"><span class="sd">            :ref:`session_expire` - introductory material</span>
</span><span id="1-3208">
</span><span id="1-3209"><span class="sd">            :meth:`.Session.expire`</span>
</span><span id="1-3210">
</span><span id="1-3211"><span class="sd">            :meth:`.Session.refresh`</span>
</span><span id="1-3212">
</span><span id="1-3213"><span class="sd">            :meth:`_orm.Query.populate_existing`</span>
</span><span id="1-3214">
</span><span id="1-3215"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3216">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3217">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3218">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3219">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3220">        <span class="bp">self</span><span class="o">.</span><span class="n">_expire_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span id="1-3221">
</span><span id="1-3222">    <span class="k">def</span> <span class="nf">_expire_state</span><span class="p">(</span>
</span><span id="1-3223">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3224">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-3225">        <span class="n">attribute_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
</span><span id="1-3226">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3227">        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_persistent</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3228">        <span class="k">if</span> <span class="n">attribute_names</span><span class="p">:</span>
</span><span id="1-3229">            <span class="n">state</span><span class="o">.</span><span class="n">_expire_attributes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">attribute_names</span><span class="p">)</span>
</span><span id="1-3230">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-3231">            <span class="c1"># pre-fetch the full cascade since the expire is going to</span>
</span><span id="1-3232">            <span class="c1"># remove associations</span>
</span><span id="1-3233">            <span class="n">cascaded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="1-3234">                <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;refresh-expire&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-3235">            <span class="p">)</span>
</span><span id="1-3236">            <span class="bp">self</span><span class="o">.</span><span class="n">_conditional_expire</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3237">            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascaded</span><span class="p">:</span>
</span><span id="1-3238">                <span class="bp">self</span><span class="o">.</span><span class="n">_conditional_expire</span><span class="p">(</span><span class="n">st_</span><span class="p">)</span>
</span><span id="1-3239">
</span><span id="1-3240">    <span class="k">def</span> <span class="nf">_conditional_expire</span><span class="p">(</span>
</span><span id="1-3241">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">autoflush</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-3242">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3243"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Expire a state if persistent, else expunge if pending&quot;&quot;&quot;</span>
</span><span id="1-3244">
</span><span id="1-3245">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-3246">            <span class="n">state</span><span class="o">.</span><span class="n">_expire</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span id="1-3247">        <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-3248">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3249">            <span class="n">state</span><span class="o">.</span><span class="n">_detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-3250">
</span><span id="1-3251">    <span class="k">def</span> <span class="nf">expunge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3252"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the `instance` from this ``Session``.</span>
</span><span id="1-3253">
</span><span id="1-3254"><span class="sd">        This will free all internal references to the instance.  Cascading</span>
</span><span id="1-3255"><span class="sd">        will be applied according to the *expunge* cascade rule.</span>
</span><span id="1-3256">
</span><span id="1-3257"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3258">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3259">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3260">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3261">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3262">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">:</span>
</span><span id="1-3263">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3264">                <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> is not present in this Session&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3265">            <span class="p">)</span>
</span><span id="1-3266">
</span><span id="1-3267">        <span class="n">cascaded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="1-3268">            <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;expunge&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-3269">        <span class="p">)</span>
</span><span id="1-3270">        <span class="bp">self</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">st_</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascaded</span><span class="p">])</span>
</span><span id="1-3271">
</span><span id="1-3272">    <span class="k">def</span> <span class="nf">_expunge_states</span><span class="p">(</span>
</span><span id="1-3273">        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">to_transient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-3274">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3275">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="1-3276">            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-3277">                <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3278">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span id="1-3279">                <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3280">                <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-3281">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span id="1-3282">                <span class="c1"># state is &quot;detached&quot; from being deleted, but still present</span>
</span><span id="1-3283">                <span class="c1"># in the transaction snapshot</span>
</span><span id="1-3284">                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-3285">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_detach_states</span><span class="p">(</span>
</span><span id="1-3286">            <span class="n">states</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">to_transient</span><span class="o">=</span><span class="n">to_transient</span>
</span><span id="1-3287">        <span class="p">)</span>
</span><span id="1-3288">
</span><span id="1-3289">    <span class="k">def</span> <span class="nf">_register_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3290"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register all persistent objects from a flush.</span>
</span><span id="1-3291">
</span><span id="1-3292"><span class="sd">        This is used both for pending objects moving to the persistent</span>
</span><span id="1-3293"><span class="sd">        state as well as already persistent objects.</span>
</span><span id="1-3294">
</span><span id="1-3295"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3296">
</span><span id="1-3297">        <span class="n">pending_to_persistent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">pending_to_persistent</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="1-3298">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="1-3299">            <span class="n">mapper</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3300">
</span><span id="1-3301">            <span class="c1"># prevent against last minute dereferences of the object</span>
</span><span id="1-3302">            <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span id="1-3303">            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3304">                <span class="n">instance_key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3305">
</span><span id="1-3306">                <span class="k">if</span> <span class="p">(</span>
</span><span id="1-3307">                    <span class="n">_none_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">instance_key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="1-3308">                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">allow_partial_pks</span>
</span><span id="1-3309">                    <span class="ow">or</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">instance_key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="1-3310">                <span class="p">):</span>
</span><span id="1-3311">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">FlushError</span><span class="p">(</span>
</span><span id="1-3312">                        <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> has a NULL identity key.  If this is an &quot;</span>
</span><span id="1-3313">                        <span class="s2">&quot;auto-generated value, check that the database table &quot;</span>
</span><span id="1-3314">                        <span class="s2">&quot;allows generation of new primary key values, and &quot;</span>
</span><span id="1-3315">                        <span class="s2">&quot;that the mapped Column object is configured to &quot;</span>
</span><span id="1-3316">                        <span class="s2">&quot;expect these generated values.  Ensure also that &quot;</span>
</span><span id="1-3317">                        <span class="s2">&quot;this flush() is not occurring at an inappropriate &quot;</span>
</span><span id="1-3318">                        <span class="s2">&quot;time, such as within a load() event.&quot;</span>
</span><span id="1-3319">                        <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3320">                    <span class="p">)</span>
</span><span id="1-3321">
</span><span id="1-3322">                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3323">                    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">instance_key</span>
</span><span id="1-3324">                <span class="k">elif</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">instance_key</span><span class="p">:</span>
</span><span id="1-3325">                    <span class="c1"># primary key switch. use safe_discard() in case another</span>
</span><span id="1-3326">                    <span class="c1"># state has already replaced this one in the identity</span>
</span><span id="1-3327">                    <span class="c1"># map (see test/orm/test_naturalpks.py ReversePKsTest)</span>
</span><span id="1-3328">                    <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3329">                    <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
</span><span id="1-3330">                    <span class="k">assert</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-3331">                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">:</span>
</span><span id="1-3332">                        <span class="n">orig_key</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="1-3333">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-3334">                        <span class="n">orig_key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-3335">                    <span class="n">trans</span><span class="o">.</span><span class="n">_key_switches</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-3336">                        <span class="n">orig_key</span><span class="p">,</span>
</span><span id="1-3337">                        <span class="n">instance_key</span><span class="p">,</span>
</span><span id="1-3338">                    <span class="p">)</span>
</span><span id="1-3339">                    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">instance_key</span>
</span><span id="1-3340">
</span><span id="1-3341">                <span class="c1"># there can be an existing state in the identity map</span>
</span><span id="1-3342">                <span class="c1"># that is replaced when the primary keys of two instances</span>
</span><span id="1-3343">                <span class="c1"># are swapped; see test/orm/test_naturalpks.py -&gt; test_reverse</span>
</span><span id="1-3344">                <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3345">                <span class="k">if</span> <span class="p">(</span>
</span><span id="1-3346">                    <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-3347">                    <span class="ow">and</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">old</span><span class="p">)</span> <span class="o">==</span> <span class="n">instance_key</span>
</span><span id="1-3348">                    <span class="ow">and</span> <span class="n">old</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-3349">                <span class="p">):</span>
</span><span id="1-3350">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-3351">                        <span class="s2">&quot;Identity map already had an identity for </span><span class="si">%s</span><span class="s2">, &quot;</span>
</span><span id="1-3352">                        <span class="s2">&quot;replacing it with newly flushed object.   Are there &quot;</span>
</span><span id="1-3353">                        <span class="s2">&quot;load operations occurring inside of an event handler &quot;</span>
</span><span id="1-3354">                        <span class="s2">&quot;within the flush?&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">instance_key</span><span class="p">,)</span>
</span><span id="1-3355">                    <span class="p">)</span>
</span><span id="1-3356">                <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-3357">
</span><span id="1-3358">        <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_commit_all_states</span><span class="p">(</span>
</span><span id="1-3359">            <span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span>
</span><span id="1-3360">        <span class="p">)</span>
</span><span id="1-3361">
</span><span id="1-3362">        <span class="bp">self</span><span class="o">.</span><span class="n">_register_altered</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
</span><span id="1-3363">
</span><span id="1-3364">        <span class="k">if</span> <span class="n">pending_to_persistent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3365">            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">):</span>
</span><span id="1-3366">                <span class="n">pending_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-3367">
</span><span id="1-3368">        <span class="c1"># remove from new last, might be the last strong ref</span>
</span><span id="1-3369">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">):</span>
</span><span id="1-3370">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3371">
</span><span id="1-3372">    <span class="k">def</span> <span class="nf">_register_altered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3373">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span id="1-3374">            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="1-3375">                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-3376">                    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_new</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-3377">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-3378">                    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_dirty</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-3379">
</span><span id="1-3380">    <span class="k">def</span> <span class="nf">_remove_newly_deleted</span><span class="p">(</span>
</span><span id="1-3381">        <span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-3382">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3383">        <span class="n">persistent_to_deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">persistent_to_deleted</span> <span class="ow">or</span> <span class="kc">None</span>
</span><span id="1-3384">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
</span><span id="1-3385">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
</span><span id="1-3386">                <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">_deleted</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-3387">
</span><span id="1-3388">            <span class="k">if</span> <span class="n">persistent_to_deleted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3389">                <span class="c1"># get a strong reference before we pop out of</span>
</span><span id="1-3390">                <span class="c1"># self._deleted</span>
</span><span id="1-3391">                <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>  <span class="c1"># noqa</span>
</span><span id="1-3392">
</span><span id="1-3393">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">safe_discard</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3394">            <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-3395">            <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-3396">            <span class="c1"># can&#39;t call state._detach() here, because this state</span>
</span><span id="1-3397">            <span class="c1"># is still in the transaction snapshot and needs to be</span>
</span><span id="1-3398">            <span class="c1"># tracked as part of that</span>
</span><span id="1-3399">            <span class="k">if</span> <span class="n">persistent_to_deleted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3400">                <span class="n">persistent_to_deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-3401">
</span><span id="1-3402">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">_warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3403"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Place an object into this :class:`_orm.Session`.</span>
</span><span id="1-3404">
</span><span id="1-3405"><span class="sd">        Objects that are in the :term:`transient` state when passed to the</span>
</span><span id="1-3406"><span class="sd">        :meth:`_orm.Session.add` method will move to the</span>
</span><span id="1-3407"><span class="sd">        :term:`pending` state, until the next flush, at which point they</span>
</span><span id="1-3408"><span class="sd">        will move to the :term:`persistent` state.</span>
</span><span id="1-3409">
</span><span id="1-3410"><span class="sd">        Objects that are in the :term:`detached` state when passed to the</span>
</span><span id="1-3411"><span class="sd">        :meth:`_orm.Session.add` method will move to the :term:`persistent`</span>
</span><span id="1-3412"><span class="sd">        state directly.</span>
</span><span id="1-3413">
</span><span id="1-3414"><span class="sd">        If the transaction used by the :class:`_orm.Session` is rolled back,</span>
</span><span id="1-3415"><span class="sd">        objects which were transient when they were passed to</span>
</span><span id="1-3416"><span class="sd">        :meth:`_orm.Session.add` will be moved back to the</span>
</span><span id="1-3417"><span class="sd">        :term:`transient` state, and will no longer be present within this</span>
</span><span id="1-3418"><span class="sd">        :class:`_orm.Session`.</span>
</span><span id="1-3419">
</span><span id="1-3420"><span class="sd">        .. seealso::</span>
</span><span id="1-3421">
</span><span id="1-3422"><span class="sd">            :meth:`_orm.Session.add_all`</span>
</span><span id="1-3423">
</span><span id="1-3424"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span id="1-3425">
</span><span id="1-3426"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3427">        <span class="k">if</span> <span class="n">_warn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span id="1-3428">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.add()&quot;</span><span class="p">)</span>
</span><span id="1-3429">
</span><span id="1-3430">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3431">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3432">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3433">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3434">
</span><span id="1-3435">        <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3436">
</span><span id="1-3437">    <span class="k">def</span> <span class="nf">add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3438"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the given collection of instances to this :class:`_orm.Session`.</span>
</span><span id="1-3439">
</span><span id="1-3440"><span class="sd">        See the documentation for :meth:`_orm.Session.add` for a general</span>
</span><span id="1-3441"><span class="sd">        behavioral description.</span>
</span><span id="1-3442">
</span><span id="1-3443"><span class="sd">        .. seealso::</span>
</span><span id="1-3444">
</span><span id="1-3445"><span class="sd">            :meth:`_orm.Session.add`</span>
</span><span id="1-3446">
</span><span id="1-3447"><span class="sd">            :ref:`session_adding` - at :ref:`session_basics`</span>
</span><span id="1-3448">
</span><span id="1-3449"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3450">
</span><span id="1-3451">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span id="1-3452">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.add_all()&quot;</span><span class="p">)</span>
</span><span id="1-3453">
</span><span id="1-3454">        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="1-3455">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">_warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-3456">
</span><span id="1-3457">    <span class="k">def</span> <span class="nf">_save_or_update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3458">        <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-3459">        <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3460">
</span><span id="1-3461">        <span class="n">mapper</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3462">        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span>
</span><span id="1-3463">            <span class="s2">&quot;save-update&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">halt_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_contains_state</span>
</span><span id="1-3464">        <span class="p">):</span>
</span><span id="1-3465">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_impl</span><span class="p">(</span><span class="n">st_</span><span class="p">)</span>
</span><span id="1-3466">
</span><span id="1-3467">    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3468"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark an instance as deleted.</span>
</span><span id="1-3469">
</span><span id="1-3470"><span class="sd">        The object is assumed to be either :term:`persistent` or</span>
</span><span id="1-3471"><span class="sd">        :term:`detached` when passed; after the method is called, the</span>
</span><span id="1-3472"><span class="sd">        object will remain in the :term:`persistent` state until the next</span>
</span><span id="1-3473"><span class="sd">        flush proceeds.  During this time, the object will also be a member</span>
</span><span id="1-3474"><span class="sd">        of the :attr:`_orm.Session.deleted` collection.</span>
</span><span id="1-3475">
</span><span id="1-3476"><span class="sd">        When the next flush proceeds, the object will move to the</span>
</span><span id="1-3477"><span class="sd">        :term:`deleted` state, indicating a ``DELETE`` statement was emitted</span>
</span><span id="1-3478"><span class="sd">        for its row within the current transaction.   When the transaction</span>
</span><span id="1-3479"><span class="sd">        is successfully committed,</span>
</span><span id="1-3480"><span class="sd">        the deleted object is moved to the :term:`detached` state and is</span>
</span><span id="1-3481"><span class="sd">        no longer present within this :class:`_orm.Session`.</span>
</span><span id="1-3482">
</span><span id="1-3483"><span class="sd">        .. seealso::</span>
</span><span id="1-3484">
</span><span id="1-3485"><span class="sd">            :ref:`session_deleting` - at :ref:`session_basics`</span>
</span><span id="1-3486">
</span><span id="1-3487"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3488">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span id="1-3489">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.delete()&quot;</span><span class="p">)</span>
</span><span id="1-3490">
</span><span id="1-3491">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3492">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-3493">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3494">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3495">
</span><span id="1-3496">        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-3497">
</span><span id="1-3498">    <span class="k">def</span> <span class="nf">_delete_impl</span><span class="p">(</span>
</span><span id="1-3499">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">head</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-3500">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3501">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3502">            <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span id="1-3503">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3504">                    <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persisted&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3505">                <span class="p">)</span>
</span><span id="1-3506">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-3507">                <span class="k">return</span>
</span><span id="1-3508">
</span><span id="1-3509">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-3510">
</span><span id="1-3511">        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span id="1-3512">            <span class="k">return</span>
</span><span id="1-3513">
</span><span id="1-3514">        <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3515">
</span><span id="1-3516">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span id="1-3517">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-3518">
</span><span id="1-3519">        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span id="1-3520">            <span class="c1"># grab the cascades before adding the item to the deleted list</span>
</span><span id="1-3521">            <span class="c1"># so that autoflush does not delete the item</span>
</span><span id="1-3522">            <span class="c1"># the strong reference to the instance itself is significant here</span>
</span><span id="1-3523">            <span class="n">cascade_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="1-3524">                <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">cascade_iterator</span><span class="p">(</span><span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-3525">            <span class="p">)</span>
</span><span id="1-3526">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-3527">            <span class="n">cascade_states</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-3528">
</span><span id="1-3529">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-3530">
</span><span id="1-3531">        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
</span><span id="1-3532">            <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-3533">                <span class="k">assert</span> <span class="n">cascade_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-3534">            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">st_</span><span class="p">,</span> <span class="n">dct_</span> <span class="ow">in</span> <span class="n">cascade_states</span><span class="p">:</span>
</span><span id="1-3535">                <span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">st_</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-3536">
</span><span id="1-3537">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
</span><span id="1-3538">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3539">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-3540">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span id="1-3541">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-3542">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3543">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-3544">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3545">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3546">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-3547">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3548">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-3549"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an instance based on the given primary key identifier,</span>
</span><span id="1-3550"><span class="sd">        or ``None`` if not found.</span>
</span><span id="1-3551">
</span><span id="1-3552"><span class="sd">        E.g.::</span>
</span><span id="1-3553">
</span><span id="1-3554"><span class="sd">            my_user = session.get(User, 5)</span>
</span><span id="1-3555">
</span><span id="1-3556"><span class="sd">            some_object = session.get(VersionedFoo, (5, 10))</span>
</span><span id="1-3557">
</span><span id="1-3558"><span class="sd">            some_object = session.get(</span>
</span><span id="1-3559"><span class="sd">                VersionedFoo,</span>
</span><span id="1-3560"><span class="sd">                {&quot;id&quot;: 5, &quot;version_id&quot;: 10}</span>
</span><span id="1-3561"><span class="sd">            )</span>
</span><span id="1-3562">
</span><span id="1-3563"><span class="sd">        .. versionadded:: 1.4 Added :meth:`_orm.Session.get`, which is moved</span>
</span><span id="1-3564"><span class="sd">           from the now legacy :meth:`_orm.Query.get` method.</span>
</span><span id="1-3565">
</span><span id="1-3566"><span class="sd">        :meth:`_orm.Session.get` is special in that it provides direct</span>
</span><span id="1-3567"><span class="sd">        access to the identity map of the :class:`.Session`.</span>
</span><span id="1-3568"><span class="sd">        If the given primary key identifier is present</span>
</span><span id="1-3569"><span class="sd">        in the local identity map, the object is returned</span>
</span><span id="1-3570"><span class="sd">        directly from this collection and no SQL is emitted,</span>
</span><span id="1-3571"><span class="sd">        unless the object has been marked fully expired.</span>
</span><span id="1-3572"><span class="sd">        If not present,</span>
</span><span id="1-3573"><span class="sd">        a SELECT is performed in order to locate the object.</span>
</span><span id="1-3574">
</span><span id="1-3575"><span class="sd">        :meth:`_orm.Session.get` also will perform a check if</span>
</span><span id="1-3576"><span class="sd">        the object is present in the identity map and</span>
</span><span id="1-3577"><span class="sd">        marked as expired - a SELECT</span>
</span><span id="1-3578"><span class="sd">        is emitted to refresh the object as well as to</span>
</span><span id="1-3579"><span class="sd">        ensure that the row is still present.</span>
</span><span id="1-3580"><span class="sd">        If not, :class:`~sqlalchemy.orm.exc.ObjectDeletedError` is raised.</span>
</span><span id="1-3581">
</span><span id="1-3582"><span class="sd">        :param entity: a mapped class or :class:`.Mapper` indicating the</span>
</span><span id="1-3583"><span class="sd">         type of entity to be loaded.</span>
</span><span id="1-3584">
</span><span id="1-3585"><span class="sd">        :param ident: A scalar, tuple, or dictionary representing the</span>
</span><span id="1-3586"><span class="sd">         primary key.  For a composite (e.g. multiple column) primary key,</span>
</span><span id="1-3587"><span class="sd">         a tuple or dictionary should be passed.</span>
</span><span id="1-3588">
</span><span id="1-3589"><span class="sd">         For a single-column primary key, the scalar calling form is typically</span>
</span><span id="1-3590"><span class="sd">         the most expedient.  If the primary key of a row is the value &quot;5&quot;,</span>
</span><span id="1-3591"><span class="sd">         the call looks like::</span>
</span><span id="1-3592">
</span><span id="1-3593"><span class="sd">            my_object = session.get(SomeClass, 5)</span>
</span><span id="1-3594">
</span><span id="1-3595"><span class="sd">         The tuple form contains primary key values typically in</span>
</span><span id="1-3596"><span class="sd">         the order in which they correspond to the mapped</span>
</span><span id="1-3597"><span class="sd">         :class:`_schema.Table`</span>
</span><span id="1-3598"><span class="sd">         object&#39;s primary key columns, or if the</span>
</span><span id="1-3599"><span class="sd">         :paramref:`_orm.Mapper.primary_key` configuration parameter were</span>
</span><span id="1-3600"><span class="sd">         used, in</span>
</span><span id="1-3601"><span class="sd">         the order used for that parameter. For example, if the primary key</span>
</span><span id="1-3602"><span class="sd">         of a row is represented by the integer</span>
</span><span id="1-3603"><span class="sd">         digits &quot;5, 10&quot; the call would look like::</span>
</span><span id="1-3604">
</span><span id="1-3605"><span class="sd">             my_object = session.get(SomeClass, (5, 10))</span>
</span><span id="1-3606">
</span><span id="1-3607"><span class="sd">         The dictionary form should include as keys the mapped attribute names</span>
</span><span id="1-3608"><span class="sd">         corresponding to each element of the primary key.  If the mapped class</span>
</span><span id="1-3609"><span class="sd">         has the attributes ``id``, ``version_id`` as the attributes which</span>
</span><span id="1-3610"><span class="sd">         store the object&#39;s primary key value, the call would look like::</span>
</span><span id="1-3611">
</span><span id="1-3612"><span class="sd">            my_object = session.get(SomeClass, {&quot;id&quot;: 5, &quot;version_id&quot;: 10})</span>
</span><span id="1-3613">
</span><span id="1-3614"><span class="sd">        :param options: optional sequence of loader options which will be</span>
</span><span id="1-3615"><span class="sd">         applied to the query, if one is emitted.</span>
</span><span id="1-3616">
</span><span id="1-3617"><span class="sd">        :param populate_existing: causes the method to unconditionally emit</span>
</span><span id="1-3618"><span class="sd">         a SQL query and refresh the object with the newly loaded data,</span>
</span><span id="1-3619"><span class="sd">         regardless of whether or not the object is already present.</span>
</span><span id="1-3620">
</span><span id="1-3621"><span class="sd">        :param with_for_update: optional boolean ``True`` indicating FOR UPDATE</span>
</span><span id="1-3622"><span class="sd">          should be used, or may be a dictionary containing flags to</span>
</span><span id="1-3623"><span class="sd">          indicate a more specific set of FOR UPDATE flags for the SELECT;</span>
</span><span id="1-3624"><span class="sd">          flags should match the parameters of</span>
</span><span id="1-3625"><span class="sd">          :meth:`_query.Query.with_for_update`.</span>
</span><span id="1-3626"><span class="sd">          Supersedes the :paramref:`.Session.refresh.lockmode` parameter.</span>
</span><span id="1-3627">
</span><span id="1-3628"><span class="sd">        :param execution_options: optional dictionary of execution options,</span>
</span><span id="1-3629"><span class="sd">         which will be associated with the query execution if one is emitted.</span>
</span><span id="1-3630"><span class="sd">         This dictionary can provide a subset of the options that are</span>
</span><span id="1-3631"><span class="sd">         accepted by :meth:`_engine.Connection.execution_options`, and may</span>
</span><span id="1-3632"><span class="sd">         also provide additional options understood only in an ORM context.</span>
</span><span id="1-3633">
</span><span id="1-3634"><span class="sd">         .. versionadded:: 1.4.29</span>
</span><span id="1-3635">
</span><span id="1-3636"><span class="sd">         .. seealso::</span>
</span><span id="1-3637">
</span><span id="1-3638"><span class="sd">            :ref:`orm_queryguide_execution_options` - ORM-specific execution</span>
</span><span id="1-3639"><span class="sd">            options</span>
</span><span id="1-3640">
</span><span id="1-3641"><span class="sd">        :param bind_arguments: dictionary of additional arguments to determine</span>
</span><span id="1-3642"><span class="sd">         the bind.  May include &quot;mapper&quot;, &quot;bind&quot;, or other custom arguments.</span>
</span><span id="1-3643"><span class="sd">         Contents of this dictionary are passed to the</span>
</span><span id="1-3644"><span class="sd">         :meth:`.Session.get_bind` method.</span>
</span><span id="1-3645">
</span><span id="1-3646"><span class="sd">         .. versionadded: 2.0.0rc1</span>
</span><span id="1-3647">
</span><span id="1-3648"><span class="sd">        :return: The object instance, or ``None``.</span>
</span><span id="1-3649">
</span><span id="1-3650"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3651">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_impl</span><span class="p">(</span>
</span><span id="1-3652">            <span class="n">entity</span><span class="p">,</span>
</span><span id="1-3653">            <span class="n">ident</span><span class="p">,</span>
</span><span id="1-3654">            <span class="n">loading</span><span class="o">.</span><span class="n">load_on_pk_identity</span><span class="p">,</span>
</span><span id="1-3655">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-3656">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span id="1-3657">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-3658">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-3659">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-3660">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-3661">        <span class="p">)</span>
</span><span id="1-3662">
</span><span id="1-3663">    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span>
</span><span id="1-3664">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3665">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-3666">        <span class="n">ident</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span id="1-3667">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-3668">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3669">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-3670">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3671">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3672">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-3673">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3674">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span id="1-3675"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return exactly one instance based on the given primary key</span>
</span><span id="1-3676"><span class="sd">        identifier, or raise an exception if not found.</span>
</span><span id="1-3677">
</span><span id="1-3678"><span class="sd">        Raises ``sqlalchemy.orm.exc.NoResultFound`` if the query</span>
</span><span id="1-3679"><span class="sd">        selects no rows.</span>
</span><span id="1-3680">
</span><span id="1-3681"><span class="sd">        For a detailed documentation of the arguments see the</span>
</span><span id="1-3682"><span class="sd">        method :meth:`.Session.get`.</span>
</span><span id="1-3683">
</span><span id="1-3684"><span class="sd">        .. versionadded:: 2.0.22</span>
</span><span id="1-3685">
</span><span id="1-3686"><span class="sd">        :return: The object instance, or ``None``.</span>
</span><span id="1-3687">
</span><span id="1-3688"><span class="sd">        .. seealso::</span>
</span><span id="1-3689">
</span><span id="1-3690"><span class="sd">            :meth:`.Session.get` - equivalent method that instead</span>
</span><span id="1-3691"><span class="sd">              returns ``None`` if no row was found with the provided primary</span>
</span><span id="1-3692"><span class="sd">              key</span>
</span><span id="1-3693">
</span><span id="1-3694"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3695">
</span><span id="1-3696">        <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-3697">            <span class="n">entity</span><span class="p">,</span>
</span><span id="1-3698">            <span class="n">ident</span><span class="p">,</span>
</span><span id="1-3699">            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-3700">            <span class="n">populate_existing</span><span class="o">=</span><span class="n">populate_existing</span><span class="p">,</span>
</span><span id="1-3701">            <span class="n">with_for_update</span><span class="o">=</span><span class="n">with_for_update</span><span class="p">,</span>
</span><span id="1-3702">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-3703">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-3704">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-3705">        <span class="p">)</span>
</span><span id="1-3706">
</span><span id="1-3707">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3708">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">NoResultFound</span><span class="p">(</span>
</span><span id="1-3709">                <span class="s2">&quot;No row was found when one was required&quot;</span>
</span><span id="1-3710">            <span class="p">)</span>
</span><span id="1-3711">
</span><span id="1-3712">        <span class="k">return</span> <span class="n">instance</span>
</span><span id="1-3713">
</span><span id="1-3714">    <span class="k">def</span> <span class="nf">_get_impl</span><span class="p">(</span>
</span><span id="1-3715">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3716">        <span class="n">entity</span><span class="p">:</span> <span class="n">_EntityBindKey</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-3717">        <span class="n">primary_key_identity</span><span class="p">:</span> <span class="n">_PKIdentityArgument</span><span class="p">,</span>
</span><span id="1-3718">        <span class="n">db_load_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_O</span><span class="p">],</span>
</span><span id="1-3719">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-3720">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ExecutableOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3721">        <span class="n">populate_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-3722">        <span class="n">with_for_update</span><span class="p">:</span> <span class="n">ForUpdateParameter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3723">        <span class="n">identity_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3724">        <span class="n">execution_options</span><span class="p">:</span> <span class="n">OrmExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">,</span>
</span><span id="1-3725">        <span class="n">bind_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_BindArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3726">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-3727">        <span class="c1"># convert composite types to individual args</span>
</span><span id="1-3728">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-3729">            <span class="n">is_composite_class</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span id="1-3730">            <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span id="1-3731">            <span class="ow">in</span> <span class="n">descriptor_props</span><span class="o">.</span><span class="n">_composite_getters</span>
</span><span id="1-3732">        <span class="p">):</span>
</span><span id="1-3733">            <span class="n">getter</span> <span class="o">=</span> <span class="n">descriptor_props</span><span class="o">.</span><span class="n">_composite_getters</span><span class="p">[</span>
</span><span id="1-3734">                <span class="nb">type</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span id="1-3735">            <span class="p">]</span>
</span><span id="1-3736">            <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span id="1-3737">
</span><span id="1-3738">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
</span><span id="1-3739">
</span><span id="1-3740">        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">is_mapper</span><span class="p">:</span>
</span><span id="1-3741">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-3742">                <span class="s2">&quot;Expected mapped class or mapper, got: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">entity</span>
</span><span id="1-3743">            <span class="p">)</span>
</span><span id="1-3744">
</span><span id="1-3745">        <span class="n">is_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="1-3746">        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_dict</span><span class="p">:</span>
</span><span id="1-3747">            <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span>
</span><span id="1-3748">                <span class="n">primary_key_identity</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
</span><span id="1-3749">            <span class="p">)</span>
</span><span id="1-3750">
</span><span id="1-3751">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapper</span><span class="o">.</span><span class="n">primary_key</span><span class="p">):</span>
</span><span id="1-3752">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3753">                <span class="s2">&quot;Incorrect number of values in identifier to formulate &quot;</span>
</span><span id="1-3754">                <span class="s2">&quot;primary key for session.get(); primary key columns &quot;</span>
</span><span id="1-3755">                <span class="s2">&quot;are </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
</span><span id="1-3756">            <span class="p">)</span>
</span><span id="1-3757">
</span><span id="1-3758">        <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
</span><span id="1-3759">            <span class="n">pk_synonyms</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_pk_synonyms</span>
</span><span id="1-3760">
</span><span id="1-3761">            <span class="k">if</span> <span class="n">pk_synonyms</span><span class="p">:</span>
</span><span id="1-3762">                <span class="n">correct_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pk_synonyms</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
</span><span id="1-3763">                    <span class="n">primary_key_identity</span>
</span><span id="1-3764">                <span class="p">)</span>
</span><span id="1-3765">
</span><span id="1-3766">                <span class="k">if</span> <span class="n">correct_keys</span><span class="p">:</span>
</span><span id="1-3767">                    <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">primary_key_identity</span><span class="p">)</span>
</span><span id="1-3768">                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">correct_keys</span><span class="p">:</span>
</span><span id="1-3769">                        <span class="n">primary_key_identity</span><span class="p">[</span>
</span><span id="1-3770">                            <span class="n">pk_synonyms</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="1-3771">                        <span class="p">]</span> <span class="o">=</span> <span class="n">primary_key_identity</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="1-3772">
</span><span id="1-3773">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-3774">                <span class="n">primary_key_identity</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="1-3775">                    <span class="n">primary_key_identity</span><span class="p">[</span><span class="n">prop</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-3776">                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_props</span>
</span><span id="1-3777">                <span class="p">)</span>
</span><span id="1-3778">
</span><span id="1-3779">            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-3780">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3781">                    <span class="s2">&quot;Incorrect names of values in identifier to formulate &quot;</span>
</span><span id="1-3782">                    <span class="s2">&quot;primary key for session.get(); primary key attribute &quot;</span>
</span><span id="1-3783">                    <span class="s2">&quot;names are </span><span class="si">%s</span><span class="s2"> (synonym names are also accepted)&quot;</span>
</span><span id="1-3784">                    <span class="o">%</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="1-3785">                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">prop</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-3786">                        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_props</span>
</span><span id="1-3787">                    <span class="p">)</span>
</span><span id="1-3788">                <span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-3789">
</span><span id="1-3790">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-3791">            <span class="ow">not</span> <span class="n">populate_existing</span>
</span><span id="1-3792">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper</span><span class="o">.</span><span class="n">always_refresh</span>
</span><span id="1-3793">            <span class="ow">and</span> <span class="n">with_for_update</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-3794">        <span class="p">):</span>
</span><span id="1-3795">            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identity_lookup</span><span class="p">(</span>
</span><span id="1-3796">                <span class="n">mapper</span><span class="p">,</span>
</span><span id="1-3797">                <span class="n">primary_key_identity</span><span class="p">,</span>
</span><span id="1-3798">                <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-3799">                <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-3800">                <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-3801">            <span class="p">)</span>
</span><span id="1-3802">
</span><span id="1-3803">            <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3804">                <span class="c1"># reject calls for id in identity map but class</span>
</span><span id="1-3805">                <span class="c1"># mismatch.</span>
</span><span id="1-3806">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">):</span>
</span><span id="1-3807">                    <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-3808">                <span class="k">return</span> <span class="n">instance</span>
</span><span id="1-3809">
</span><span id="1-3810">            <span class="c1"># TODO: this was being tested before, but this is not possible</span>
</span><span id="1-3811">            <span class="k">assert</span> <span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_CLASS_MISMATCH</span>
</span><span id="1-3812">
</span><span id="1-3813">        <span class="c1"># set_label_style() not strictly necessary, however this will ensure</span>
</span><span id="1-3814">        <span class="c1"># that tablename_colname style is used which at the moment is</span>
</span><span id="1-3815">        <span class="c1"># asserted in a lot of unit tests :)</span>
</span><span id="1-3816">
</span><span id="1-3817">        <span class="n">load_options</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">QueryContext</span><span class="o">.</span><span class="n">default_load_options</span>
</span><span id="1-3818">
</span><span id="1-3819">        <span class="k">if</span> <span class="n">populate_existing</span><span class="p">:</span>
</span><span id="1-3820">            <span class="n">load_options</span> <span class="o">+=</span> <span class="p">{</span><span class="s2">&quot;_populate_existing&quot;</span><span class="p">:</span> <span class="n">populate_existing</span><span class="p">}</span>
</span><span id="1-3821">        <span class="n">statement</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span><span class="o">.</span><span class="n">set_label_style</span><span class="p">(</span>
</span><span id="1-3822">            <span class="n">LABEL_STYLE_TABLENAME_PLUS_COL</span>
</span><span id="1-3823">        <span class="p">)</span>
</span><span id="1-3824">        <span class="k">if</span> <span class="n">with_for_update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3825">            <span class="n">statement</span><span class="o">.</span><span class="n">_for_update_arg</span> <span class="o">=</span> <span class="n">ForUpdateArg</span><span class="o">.</span><span class="n">_from_argument</span><span class="p">(</span>
</span><span id="1-3826">                <span class="n">with_for_update</span>
</span><span id="1-3827">            <span class="p">)</span>
</span><span id="1-3828">
</span><span id="1-3829">        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
</span><span id="1-3830">            <span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-3831">        <span class="k">return</span> <span class="n">db_load_fn</span><span class="p">(</span>
</span><span id="1-3832">            <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3833">            <span class="n">statement</span><span class="p">,</span>
</span><span id="1-3834">            <span class="n">primary_key_identity</span><span class="p">,</span>
</span><span id="1-3835">            <span class="n">load_options</span><span class="o">=</span><span class="n">load_options</span><span class="p">,</span>
</span><span id="1-3836">            <span class="n">identity_token</span><span class="o">=</span><span class="n">identity_token</span><span class="p">,</span>
</span><span id="1-3837">            <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span><span class="p">,</span>
</span><span id="1-3838">            <span class="n">bind_arguments</span><span class="o">=</span><span class="n">bind_arguments</span><span class="p">,</span>
</span><span id="1-3839">        <span class="p">)</span>
</span><span id="1-3840">
</span><span id="1-3841">    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span>
</span><span id="1-3842">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3843">        <span class="n">instance</span><span class="p">:</span> <span class="n">_O</span><span class="p">,</span>
</span><span id="1-3844">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-3845">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-3846">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3847">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span id="1-3848"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy the state of a given instance into a corresponding instance</span>
</span><span id="1-3849"><span class="sd">        within this :class:`.Session`.</span>
</span><span id="1-3850">
</span><span id="1-3851"><span class="sd">        :meth:`.Session.merge` examines the primary key attributes of the</span>
</span><span id="1-3852"><span class="sd">        source instance, and attempts to reconcile it with an instance of the</span>
</span><span id="1-3853"><span class="sd">        same primary key in the session.   If not found locally, it attempts</span>
</span><span id="1-3854"><span class="sd">        to load the object from the database based on primary key, and if</span>
</span><span id="1-3855"><span class="sd">        none can be located, creates a new instance.  The state of each</span>
</span><span id="1-3856"><span class="sd">        attribute on the source instance is then copied to the target</span>
</span><span id="1-3857"><span class="sd">        instance.  The resulting target instance is then returned by the</span>
</span><span id="1-3858"><span class="sd">        method; the original source instance is left unmodified, and</span>
</span><span id="1-3859"><span class="sd">        un-associated with the :class:`.Session` if not already.</span>
</span><span id="1-3860">
</span><span id="1-3861"><span class="sd">        This operation cascades to associated instances if the association is</span>
</span><span id="1-3862"><span class="sd">        mapped with ``cascade=&quot;merge&quot;``.</span>
</span><span id="1-3863">
</span><span id="1-3864"><span class="sd">        See :ref:`unitofwork_merging` for a detailed discussion of merging.</span>
</span><span id="1-3865">
</span><span id="1-3866"><span class="sd">        :param instance: Instance to be merged.</span>
</span><span id="1-3867"><span class="sd">        :param load: Boolean, when False, :meth:`.merge` switches into</span>
</span><span id="1-3868"><span class="sd">         a &quot;high performance&quot; mode which causes it to forego emitting history</span>
</span><span id="1-3869"><span class="sd">         events as well as all database access.  This flag is used for</span>
</span><span id="1-3870"><span class="sd">         cases such as transferring graphs of objects into a :class:`.Session`</span>
</span><span id="1-3871"><span class="sd">         from a second level cache, or to transfer just-loaded objects</span>
</span><span id="1-3872"><span class="sd">         into the :class:`.Session` owned by a worker thread or process</span>
</span><span id="1-3873"><span class="sd">         without re-querying the database.</span>
</span><span id="1-3874">
</span><span id="1-3875"><span class="sd">         The ``load=False`` use case adds the caveat that the given</span>
</span><span id="1-3876"><span class="sd">         object has to be in a &quot;clean&quot; state, that is, has no pending changes</span>
</span><span id="1-3877"><span class="sd">         to be flushed - even if the incoming object is detached from any</span>
</span><span id="1-3878"><span class="sd">         :class:`.Session`.   This is so that when</span>
</span><span id="1-3879"><span class="sd">         the merge operation populates local attributes and</span>
</span><span id="1-3880"><span class="sd">         cascades to related objects and</span>
</span><span id="1-3881"><span class="sd">         collections, the values can be &quot;stamped&quot; onto the</span>
</span><span id="1-3882"><span class="sd">         target object as is, without generating any history or attribute</span>
</span><span id="1-3883"><span class="sd">         events, and without the need to reconcile the incoming data with</span>
</span><span id="1-3884"><span class="sd">         any existing related objects or collections that might not</span>
</span><span id="1-3885"><span class="sd">         be loaded.  The resulting objects from ``load=False`` are always</span>
</span><span id="1-3886"><span class="sd">         produced as &quot;clean&quot;, so it is only appropriate that the given objects</span>
</span><span id="1-3887"><span class="sd">         should be &quot;clean&quot; as well, else this suggests a mis-use of the</span>
</span><span id="1-3888"><span class="sd">         method.</span>
</span><span id="1-3889"><span class="sd">        :param options: optional sequence of loader options which will be</span>
</span><span id="1-3890"><span class="sd">         applied to the :meth:`_orm.Session.get` method when the merge</span>
</span><span id="1-3891"><span class="sd">         operation loads the existing version of the object from the database.</span>
</span><span id="1-3892">
</span><span id="1-3893"><span class="sd">         .. versionadded:: 1.4.24</span>
</span><span id="1-3894">
</span><span id="1-3895">
</span><span id="1-3896"><span class="sd">        .. seealso::</span>
</span><span id="1-3897">
</span><span id="1-3898"><span class="sd">            :func:`.make_transient_to_detached` - provides for an alternative</span>
</span><span id="1-3899"><span class="sd">            means of &quot;merging&quot; a single object into the :class:`.Session`</span>
</span><span id="1-3900">
</span><span id="1-3901"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-3902">
</span><span id="1-3903">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span><span class="p">:</span>
</span><span id="1-3904">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_warning</span><span class="p">(</span><span class="s2">&quot;Session.merge()&quot;</span><span class="p">)</span>
</span><span id="1-3905">
</span><span id="1-3906">        <span class="n">_recursive</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-3907">        <span class="n">_resolve_conflict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-3908">
</span><span id="1-3909">        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
</span><span id="1-3910">            <span class="c1"># flush current contents if we expect to load data</span>
</span><span id="1-3911">            <span class="bp">self</span><span class="o">.</span><span class="n">_autoflush</span><span class="p">()</span>
</span><span id="1-3912">
</span><span id="1-3913">        <span class="n">object_mapper</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>  <span class="c1"># verify mapped</span>
</span><span id="1-3914">        <span class="n">autoflush</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span>
</span><span id="1-3915">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-3916">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-3917">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span>
</span><span id="1-3918">                <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span>
</span><span id="1-3919">                <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">instance</span><span class="p">),</span>
</span><span id="1-3920">                <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span>
</span><span id="1-3921">                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-3922">                <span class="n">_recursive</span><span class="o">=</span><span class="n">_recursive</span><span class="p">,</span>
</span><span id="1-3923">                <span class="n">_resolve_conflict_map</span><span class="o">=</span><span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span id="1-3924">            <span class="p">)</span>
</span><span id="1-3925">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-3926">            <span class="bp">self</span><span class="o">.</span><span class="n">autoflush</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span id="1-3927">
</span><span id="1-3928">    <span class="k">def</span> <span class="nf">_merge</span><span class="p">(</span>
</span><span id="1-3929">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-3930">        <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-3931">        <span class="n">state_dict</span><span class="p">:</span> <span class="n">_InstanceDict</span><span class="p">,</span>
</span><span id="1-3932">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-3933">        <span class="n">options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ORMOption</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-3934">        <span class="n">load</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-3935">        <span class="n">_recursive</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
</span><span id="1-3936">        <span class="n">_resolve_conflict_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">_IdentityKeyType</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">object</span><span class="p">],</span>
</span><span id="1-3937">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span>
</span><span id="1-3938">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3939">        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">_recursive</span><span class="p">:</span>
</span><span id="1-3940">            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">_O</span><span class="p">,</span> <span class="n">_recursive</span><span class="p">[</span><span class="n">state</span><span class="p">])</span>
</span><span id="1-3941">
</span><span id="1-3942">        <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-3943">        <span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-3944">
</span><span id="1-3945">        <span class="n">merged</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span id="1-3946">
</span><span id="1-3947">        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3948">            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-3949">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-3950">                    <span class="s2">&quot;Instance </span><span class="si">%s</span><span class="s2"> is already pending in this Session yet is &quot;</span>
</span><span id="1-3951">                    <span class="s2">&quot;being merged again; this is probably not what you want &quot;</span>
</span><span id="1-3952">                    <span class="s2">&quot;to do&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3953">                <span class="p">)</span>
</span><span id="1-3954">
</span><span id="1-3955">            <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span id="1-3956">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3957">                    <span class="s2">&quot;merge() with load=False option does not support &quot;</span>
</span><span id="1-3958">                    <span class="s2">&quot;objects transient (i.e. unpersisted) objects.  flush() &quot;</span>
</span><span id="1-3959">                    <span class="s2">&quot;all changes on mapped instances before merging with &quot;</span>
</span><span id="1-3960">                    <span class="s2">&quot;load=False.&quot;</span>
</span><span id="1-3961">                <span class="p">)</span>
</span><span id="1-3962">            <span class="n">key</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-3963">            <span class="n">key_is_persistent</span> <span class="o">=</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">NEVER_SET</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">[</span>
</span><span id="1-3964">                <span class="mi">1</span>
</span><span id="1-3965">            <span class="p">]</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-3966">                <span class="ow">not</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="1-3967">                <span class="ow">or</span> <span class="p">(</span>
</span><span id="1-3968">                    <span class="n">mapper</span><span class="o">.</span><span class="n">allow_partial_pks</span>
</span><span id="1-3969">                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">_none_set</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="1-3970">                <span class="p">)</span>
</span><span id="1-3971">            <span class="p">)</span>
</span><span id="1-3972">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-3973">            <span class="n">key_is_persistent</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-3974">
</span><span id="1-3975">        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">:</span>
</span><span id="1-3976">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-3977">                <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-3978">            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="1-3979">                <span class="c1"># object was GC&#39;ed right as we checked for it</span>
</span><span id="1-3980">                <span class="n">merged</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-3981">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-3982">            <span class="n">merged</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-3983">
</span><span id="1-3984">        <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-3985">            <span class="k">if</span> <span class="n">key_is_persistent</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_resolve_conflict_map</span><span class="p">:</span>
</span><span id="1-3986">                <span class="n">merged</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">_O</span><span class="p">,</span> <span class="n">_resolve_conflict_map</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="1-3987">
</span><span id="1-3988">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span id="1-3989">                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
</span><span id="1-3990">                    <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-3991">                        <span class="s2">&quot;merge() with load=False option does not support &quot;</span>
</span><span id="1-3992">                        <span class="s2">&quot;objects marked as &#39;dirty&#39;.  flush() all changes on &quot;</span>
</span><span id="1-3993">                        <span class="s2">&quot;mapped instances before merging with load=False.&quot;</span>
</span><span id="1-3994">                    <span class="p">)</span>
</span><span id="1-3995">                <span class="n">merged</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
</span><span id="1-3996">                <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="1-3997">                <span class="n">merged_state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="1-3998">                <span class="bp">self</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">merged_state</span><span class="p">)</span>
</span><span id="1-3999">                <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4000">
</span><span id="1-4001">            <span class="k">elif</span> <span class="n">key_is_persistent</span><span class="p">:</span>
</span><span id="1-4002">                <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-4003">                    <span class="n">mapper</span><span class="o">.</span><span class="n">class_</span><span class="p">,</span>
</span><span id="1-4004">                    <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="1-4005">                    <span class="n">identity_token</span><span class="o">=</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="1-4006">                    <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-4007">                <span class="p">)</span>
</span><span id="1-4008">
</span><span id="1-4009">        <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4010">            <span class="n">merged</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">class_manager</span><span class="o">.</span><span class="n">new_instance</span><span class="p">()</span>
</span><span id="1-4011">            <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="1-4012">            <span class="n">merged_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="1-4013">            <span class="n">new_instance</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4014">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_or_update_state</span><span class="p">(</span><span class="n">merged_state</span><span class="p">)</span>
</span><span id="1-4015">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4016">            <span class="n">merged_state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="1-4017">            <span class="n">merged_dict</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_dict</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
</span><span id="1-4018">
</span><span id="1-4019">        <span class="n">_recursive</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
</span><span id="1-4020">        <span class="n">_resolve_conflict_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>
</span><span id="1-4021">
</span><span id="1-4022">        <span class="c1"># check that we didn&#39;t just pull the exact same</span>
</span><span id="1-4023">        <span class="c1"># state out.</span>
</span><span id="1-4024">        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">merged_state</span><span class="p">:</span>
</span><span id="1-4025">            <span class="c1"># version check if applicable</span>
</span><span id="1-4026">            <span class="k">if</span> <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4027">                <span class="n">existing_version</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_get_state_attr_by_column</span><span class="p">(</span>
</span><span id="1-4028">                    <span class="n">state</span><span class="p">,</span>
</span><span id="1-4029">                    <span class="n">state_dict</span><span class="p">,</span>
</span><span id="1-4030">                    <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">,</span>
</span><span id="1-4031">                    <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span id="1-4032">                <span class="p">)</span>
</span><span id="1-4033">
</span><span id="1-4034">                <span class="n">merged_version</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">_get_state_attr_by_column</span><span class="p">(</span>
</span><span id="1-4035">                    <span class="n">merged_state</span><span class="p">,</span>
</span><span id="1-4036">                    <span class="n">merged_dict</span><span class="p">,</span>
</span><span id="1-4037">                    <span class="n">mapper</span><span class="o">.</span><span class="n">version_id_col</span><span class="p">,</span>
</span><span id="1-4038">                    <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">PASSIVE_NO_INITIALIZE</span><span class="p">,</span>
</span><span id="1-4039">                <span class="p">)</span>
</span><span id="1-4040">
</span><span id="1-4041">                <span class="k">if</span> <span class="p">(</span>
</span><span id="1-4042">                    <span class="n">existing_version</span>
</span><span id="1-4043">                    <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-4044">                    <span class="ow">and</span> <span class="n">merged_version</span>
</span><span id="1-4045">                    <span class="ow">is</span> <span class="ow">not</span> <span class="n">LoaderCallableStatus</span><span class="o">.</span><span class="n">PASSIVE_NO_RESULT</span>
</span><span id="1-4046">                    <span class="ow">and</span> <span class="n">existing_version</span> <span class="o">!=</span> <span class="n">merged_version</span>
</span><span id="1-4047">                <span class="p">):</span>
</span><span id="1-4048">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">StaleDataError</span><span class="p">(</span>
</span><span id="1-4049">                        <span class="s2">&quot;Version id &#39;</span><span class="si">%s</span><span class="s2">&#39; on merged state </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span id="1-4050">                        <span class="s2">&quot;does not match existing version &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span>
</span><span id="1-4051">                        <span class="s2">&quot;Leave the version attribute unset when &quot;</span>
</span><span id="1-4052">                        <span class="s2">&quot;merging to update the most recent version.&quot;</span>
</span><span id="1-4053">                        <span class="o">%</span> <span class="p">(</span>
</span><span id="1-4054">                            <span class="n">existing_version</span><span class="p">,</span>
</span><span id="1-4055">                            <span class="n">state_str</span><span class="p">(</span><span class="n">merged_state</span><span class="p">),</span>
</span><span id="1-4056">                            <span class="n">merged_version</span><span class="p">,</span>
</span><span id="1-4057">                        <span class="p">)</span>
</span><span id="1-4058">                    <span class="p">)</span>
</span><span id="1-4059">
</span><span id="1-4060">            <span class="n">merged_state</span><span class="o">.</span><span class="n">load_path</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">load_path</span>
</span><span id="1-4061">            <span class="n">merged_state</span><span class="o">.</span><span class="n">load_options</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">load_options</span>
</span><span id="1-4062">
</span><span id="1-4063">            <span class="c1"># since we are copying load_options, we need to copy</span>
</span><span id="1-4064">            <span class="c1"># the callables_ that would have been generated by those</span>
</span><span id="1-4065">            <span class="c1"># load_options.</span>
</span><span id="1-4066">            <span class="c1"># assumes that the callables we put in state.callables_</span>
</span><span id="1-4067">            <span class="c1"># are not instance-specific (which they should not be)</span>
</span><span id="1-4068">            <span class="n">merged_state</span><span class="o">.</span><span class="n">_copy_callables</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4069">
</span><span id="1-4070">            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">iterate_properties</span><span class="p">:</span>
</span><span id="1-4071">                <span class="n">prop</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
</span><span id="1-4072">                    <span class="bp">self</span><span class="p">,</span>
</span><span id="1-4073">                    <span class="n">state</span><span class="p">,</span>
</span><span id="1-4074">                    <span class="n">state_dict</span><span class="p">,</span>
</span><span id="1-4075">                    <span class="n">merged_state</span><span class="p">,</span>
</span><span id="1-4076">                    <span class="n">merged_dict</span><span class="p">,</span>
</span><span id="1-4077">                    <span class="n">load</span><span class="p">,</span>
</span><span id="1-4078">                    <span class="n">_recursive</span><span class="p">,</span>
</span><span id="1-4079">                    <span class="n">_resolve_conflict_map</span><span class="p">,</span>
</span><span id="1-4080">                <span class="p">)</span>
</span><span id="1-4081">
</span><span id="1-4082">        <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
</span><span id="1-4083">            <span class="c1"># remove any history</span>
</span><span id="1-4084">            <span class="n">merged_state</span><span class="o">.</span><span class="n">_commit_all</span><span class="p">(</span><span class="n">merged_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">)</span>
</span><span id="1-4085">            <span class="n">merged_state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_sa_event_merge_wo_load</span><span class="p">(</span>
</span><span id="1-4086">                <span class="n">merged_state</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="1-4087">            <span class="p">)</span>
</span><span id="1-4088">
</span><span id="1-4089">        <span class="k">if</span> <span class="n">new_instance</span><span class="p">:</span>
</span><span id="1-4090">            <span class="n">merged_state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">merged_state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-4091">
</span><span id="1-4092">        <span class="k">return</span> <span class="n">merged</span>
</span><span id="1-4093">
</span><span id="1-4094">    <span class="k">def</span> <span class="nf">_validate_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4095">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span><span id="1-4096">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-4097">                <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persistent within this Session&quot;</span>
</span><span id="1-4098">                <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4099">            <span class="p">)</span>
</span><span id="1-4100">
</span><span id="1-4101">    <span class="k">def</span> <span class="nf">_save_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4102">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4103">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-4104">                <span class="s2">&quot;Object &#39;</span><span class="si">%s</span><span class="s2">&#39; already has an identity - &quot;</span>
</span><span id="1-4105">                <span class="s2">&quot;it can&#39;t be registered as pending&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4106">            <span class="p">)</span>
</span><span id="1-4107">
</span><span id="1-4108">        <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span id="1-4109">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4110">        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-4111">            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-4112">            <span class="n">state</span><span class="o">.</span><span class="n">insert_order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span id="1-4113">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span id="1-4114">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4115">
</span><span id="1-4116">    <span class="k">def</span> <span class="nf">_update_impl</span><span class="p">(</span>
</span><span id="1-4117">        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">revert_deletion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-4118">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4119">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4120">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-4121">                <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; is not persisted&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4122">            <span class="p">)</span>
</span><span id="1-4123">
</span><span id="1-4124">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span id="1-4125">            <span class="k">if</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span id="1-4126">                <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">_attached</span><span class="p">:</span>
</span><span id="1-4127">                    <span class="k">return</span>
</span><span id="1-4128">                <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-4129">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-4130">                <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-4131">                    <span class="s2">&quot;Instance &#39;</span><span class="si">%s</span><span class="s2">&#39; has been deleted.  &quot;</span>
</span><span id="1-4132">                    <span class="s2">&quot;Use the make_transient() &quot;</span>
</span><span id="1-4133">                    <span class="s2">&quot;function to send this object back &quot;</span>
</span><span id="1-4134">                    <span class="s2">&quot;to the transient state.&quot;</span> <span class="o">%</span> <span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4135">                <span class="p">)</span>
</span><span id="1-4136">
</span><span id="1-4137">        <span class="n">obj</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span id="1-4138">
</span><span id="1-4139">        <span class="c1"># check for late gc</span>
</span><span id="1-4140">        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4141">            <span class="k">return</span>
</span><span id="1-4142">
</span><span id="1-4143">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4144">
</span><span id="1-4145">        <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-4146">        <span class="k">if</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span id="1-4147">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4148">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4149">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4150">
</span><span id="1-4151">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span id="1-4152">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4153">        <span class="k">elif</span> <span class="n">revert_deletion</span><span class="p">:</span>
</span><span id="1-4154">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">deleted_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-4155">
</span><span id="1-4156">    <span class="k">def</span> <span class="nf">_save_or_update_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4157">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4158">            <span class="bp">self</span><span class="o">.</span><span class="n">_save_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4159">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4160">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_impl</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4161">
</span><span id="1-4162">    <span class="k">def</span> <span class="nf">enable_relationship_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4163"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Associate an object with this :class:`.Session` for related</span>
</span><span id="1-4164"><span class="sd">        object loading.</span>
</span><span id="1-4165">
</span><span id="1-4166"><span class="sd">        .. warning::</span>
</span><span id="1-4167">
</span><span id="1-4168"><span class="sd">            :meth:`.enable_relationship_loading` exists to serve special</span>
</span><span id="1-4169"><span class="sd">            use cases and is not recommended for general use.</span>
</span><span id="1-4170">
</span><span id="1-4171"><span class="sd">        Accesses of attributes mapped with :func:`_orm.relationship`</span>
</span><span id="1-4172"><span class="sd">        will attempt to load a value from the database using this</span>
</span><span id="1-4173"><span class="sd">        :class:`.Session` as the source of connectivity.  The values</span>
</span><span id="1-4174"><span class="sd">        will be loaded based on foreign key and primary key values</span>
</span><span id="1-4175"><span class="sd">        present on this object - if not present, then those relationships</span>
</span><span id="1-4176"><span class="sd">        will be unavailable.</span>
</span><span id="1-4177">
</span><span id="1-4178"><span class="sd">        The object will be attached to this session, but will</span>
</span><span id="1-4179"><span class="sd">        **not** participate in any persistence operations; its state</span>
</span><span id="1-4180"><span class="sd">        for almost all purposes will remain either &quot;transient&quot; or</span>
</span><span id="1-4181"><span class="sd">        &quot;detached&quot;, except for the case of relationship loading.</span>
</span><span id="1-4182">
</span><span id="1-4183"><span class="sd">        Also note that backrefs will often not work as expected.</span>
</span><span id="1-4184"><span class="sd">        Altering a relationship-bound attribute on the target object</span>
</span><span id="1-4185"><span class="sd">        may not fire off a backref event, if the effective value</span>
</span><span id="1-4186"><span class="sd">        is what was already loaded from a foreign-key-holding value.</span>
</span><span id="1-4187">
</span><span id="1-4188"><span class="sd">        The :meth:`.Session.enable_relationship_loading` method is</span>
</span><span id="1-4189"><span class="sd">        similar to the ``load_on_pending`` flag on :func:`_orm.relationship`.</span>
</span><span id="1-4190"><span class="sd">        Unlike that flag, :meth:`.Session.enable_relationship_loading` allows</span>
</span><span id="1-4191"><span class="sd">        an object to remain transient while still being able to load</span>
</span><span id="1-4192"><span class="sd">        related items.</span>
</span><span id="1-4193">
</span><span id="1-4194"><span class="sd">        To make a transient object associated with a :class:`.Session`</span>
</span><span id="1-4195"><span class="sd">        via :meth:`.Session.enable_relationship_loading` pending, add</span>
</span><span id="1-4196"><span class="sd">        it to the :class:`.Session` using :meth:`.Session.add` normally.</span>
</span><span id="1-4197"><span class="sd">        If the object instead represents an existing identity in the database,</span>
</span><span id="1-4198"><span class="sd">        it should be merged using :meth:`.Session.merge`.</span>
</span><span id="1-4199">
</span><span id="1-4200"><span class="sd">        :meth:`.Session.enable_relationship_loading` does not improve</span>
</span><span id="1-4201"><span class="sd">        behavior when the ORM is used normally - object references should be</span>
</span><span id="1-4202"><span class="sd">        constructed at the object level, not at the foreign key level, so</span>
</span><span id="1-4203"><span class="sd">        that they are present in an ordinary way before flush()</span>
</span><span id="1-4204"><span class="sd">        proceeds.  This method is not intended for general use.</span>
</span><span id="1-4205">
</span><span id="1-4206"><span class="sd">        .. seealso::</span>
</span><span id="1-4207">
</span><span id="1-4208"><span class="sd">            :paramref:`_orm.relationship.load_on_pending` - this flag</span>
</span><span id="1-4209"><span class="sd">            allows per-relationship loading of many-to-ones on items that</span>
</span><span id="1-4210"><span class="sd">            are pending.</span>
</span><span id="1-4211">
</span><span id="1-4212"><span class="sd">            :func:`.make_transient_to_detached` - allows for an object to</span>
</span><span id="1-4213"><span class="sd">            be added to a :class:`.Session` without SQL emitted, which then</span>
</span><span id="1-4214"><span class="sd">            will unexpire attributes on access.</span>
</span><span id="1-4215">
</span><span id="1-4216"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4217">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-4218">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="1-4219">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-4220">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-4221">
</span><span id="1-4222">        <span class="n">to_attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4223">        <span class="n">state</span><span class="o">.</span><span class="n">_load_pending</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4224">        <span class="k">if</span> <span class="n">to_attach</span><span class="p">:</span>
</span><span id="1-4225">            <span class="bp">self</span><span class="o">.</span><span class="n">_after_attach</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-4226">
</span><span id="1-4227">    <span class="k">def</span> <span class="nf">_before_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4228">        <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span>
</span><span id="1-4229">
</span><span id="1-4230">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">:</span>
</span><span id="1-4231">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-4232">
</span><span id="1-4233">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">in</span> <span class="n">_sessions</span><span class="p">:</span>
</span><span id="1-4234">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-4235">                <span class="s2">&quot;Object &#39;</span><span class="si">%s</span><span class="s2">&#39; is already attached to session &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
</span><span id="1-4236">                <span class="s2">&quot;(this is &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span>
</span><span id="1-4237">                <span class="o">%</span> <span class="p">(</span><span class="n">state_str</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span><span class="p">)</span>
</span><span id="1-4238">            <span class="p">)</span>
</span><span id="1-4239">
</span><span id="1-4240">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-4241">
</span><span id="1-4242">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-4243">
</span><span id="1-4244">    <span class="k">def</span> <span class="nf">_after_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4245">        <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_key</span>
</span><span id="1-4246">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">_strong_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4247">            <span class="n">state</span><span class="o">.</span><span class="n">_strong_obj</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-4248">        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-4249">
</span><span id="1-4250">        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-4251">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">detached_to_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-4252">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4253">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">transient_to_pending</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="1-4254">
</span><span id="1-4255">    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4256"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the instance is associated with this session.</span>
</span><span id="1-4257">
</span><span id="1-4258"><span class="sd">        The instance may be pending or persistent within the Session for a</span>
</span><span id="1-4259"><span class="sd">        result of True.</span>
</span><span id="1-4260">
</span><span id="1-4261"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4262">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-4263">            <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-4264">        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-4265">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-4266">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4267">
</span><span id="1-4268">    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
</span><span id="1-4269"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over all pending or persistent instances within this</span>
</span><span id="1-4270"><span class="sd">        Session.</span>
</span><span id="1-4271">
</span><span id="1-4272"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4273">        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
</span><span id="1-4274">            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="1-4275">        <span class="p">)</span>
</span><span id="1-4276">
</span><span id="1-4277">    <span class="k">def</span> <span class="nf">_contains_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4278">        <span class="k">return</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">contains_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4279">
</span><span id="1-4280">    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4281"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush all the object changes to the database.</span>
</span><span id="1-4282">
</span><span id="1-4283"><span class="sd">        Writes out all pending object creations, deletions and modifications</span>
</span><span id="1-4284"><span class="sd">        to the database as INSERTs, DELETEs, UPDATEs, etc.  Operations are</span>
</span><span id="1-4285"><span class="sd">        automatically ordered by the Session&#39;s unit of work dependency</span>
</span><span id="1-4286"><span class="sd">        solver.</span>
</span><span id="1-4287">
</span><span id="1-4288"><span class="sd">        Database operations will be issued in the current transactional</span>
</span><span id="1-4289"><span class="sd">        context and do not affect the state of the transaction, unless an</span>
</span><span id="1-4290"><span class="sd">        error occurs, in which case the entire transaction is rolled back.</span>
</span><span id="1-4291"><span class="sd">        You may flush() as often as you like within a transaction to move</span>
</span><span id="1-4292"><span class="sd">        changes from Python to the database&#39;s transaction buffer.</span>
</span><span id="1-4293">
</span><span id="1-4294"><span class="sd">        :param objects: Optional; restricts the flush operation to operate</span>
</span><span id="1-4295"><span class="sd">          only on elements that are in the given collection.</span>
</span><span id="1-4296">
</span><span id="1-4297"><span class="sd">          This feature is for an extremely narrow set of use cases where</span>
</span><span id="1-4298"><span class="sd">          particular objects may need to be operated upon before the</span>
</span><span id="1-4299"><span class="sd">          full flush() occurs.  It is not intended for general use.</span>
</span><span id="1-4300">
</span><span id="1-4301"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4302">
</span><span id="1-4303">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span><span class="p">:</span>
</span><span id="1-4304">            <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Session is already flushing&quot;</span><span class="p">)</span>
</span><span id="1-4305">
</span><span id="1-4306">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_clean</span><span class="p">():</span>
</span><span id="1-4307">            <span class="k">return</span>
</span><span id="1-4308">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-4309">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4310">            <span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
</span><span id="1-4311">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-4312">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-4313">
</span><span id="1-4314">    <span class="k">def</span> <span class="nf">_flush_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4315">        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-4316">            <span class="s2">&quot;Usage of the &#39;</span><span class="si">%s</span><span class="s2">&#39; operation is not currently supported &quot;</span>
</span><span id="1-4317">            <span class="s2">&quot;within the execution stage of the flush process. &quot;</span>
</span><span id="1-4318">            <span class="s2">&quot;Results may not be consistent.  Consider using alternative &quot;</span>
</span><span id="1-4319">            <span class="s2">&quot;event listeners or connection-level operations instead.&quot;</span> <span class="o">%</span> <span class="n">method</span>
</span><span id="1-4320">        <span class="p">)</span>
</span><span id="1-4321">
</span><span id="1-4322">    <span class="k">def</span> <span class="nf">_is_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4323">        <span class="k">return</span> <span class="p">(</span>
</span><span id="1-4324">            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">check_modified</span><span class="p">()</span>
</span><span id="1-4325">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-4326">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span>
</span><span id="1-4327">        <span class="p">)</span>
</span><span id="1-4328">
</span><span id="1-4329">    <span class="k">def</span> <span class="nf">_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4330">        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span id="1-4331">        <span class="k">if</span> <span class="ow">not</span> <span class="n">dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">:</span>
</span><span id="1-4332">            <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="1-4333">            <span class="k">return</span>
</span><span id="1-4334">
</span><span id="1-4335">        <span class="n">flush_context</span> <span class="o">=</span> <span class="n">UOWTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-4336">
</span><span id="1-4337">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_flush</span><span class="p">:</span>
</span><span id="1-4338">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>
</span><span id="1-4339">            <span class="c1"># re-establish &quot;dirty states&quot; in case the listeners</span>
</span><span id="1-4340">            <span class="c1"># added</span>
</span><span id="1-4341">            <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span id="1-4342">
</span><span id="1-4343">        <span class="n">deleted</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="p">)</span>
</span><span id="1-4344">        <span class="n">new</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">)</span>
</span><span id="1-4345">
</span><span id="1-4346">        <span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span id="1-4347">
</span><span id="1-4348">        <span class="c1"># create the set of all objects we want to operate upon</span>
</span><span id="1-4349">        <span class="k">if</span> <span class="n">objects</span><span class="p">:</span>
</span><span id="1-4350">            <span class="c1"># specific list passed in</span>
</span><span id="1-4351">            <span class="n">objset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-4352">            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
</span><span id="1-4353">                <span class="k">try</span><span class="p">:</span>
</span><span id="1-4354">                    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="1-4355">
</span><span id="1-4356">                <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-4357">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-4358">                <span class="n">objset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4359">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4360">            <span class="n">objset</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-4361">
</span><span id="1-4362">        <span class="c1"># store objects whose fate has been decided</span>
</span><span id="1-4363">        <span class="n">processed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-4364">
</span><span id="1-4365">        <span class="c1"># put all saves/updates into the flush context.  detect top-level</span>
</span><span id="1-4366">        <span class="c1"># orphans and throw them into deleted.</span>
</span><span id="1-4367">        <span class="k">if</span> <span class="n">objset</span><span class="p">:</span>
</span><span id="1-4368">            <span class="n">proc</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">objset</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span id="1-4369">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4370">            <span class="n">proc</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dirty</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</span><span id="1-4371">
</span><span id="1-4372">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">:</span>
</span><span id="1-4373">            <span class="n">is_orphan</span> <span class="o">=</span> <span class="n">_state_mapper</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">_is_orphan</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4374">
</span><span id="1-4375">            <span class="n">is_persistent_orphan</span> <span class="o">=</span> <span class="n">is_orphan</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">has_identity</span>
</span><span id="1-4376">
</span><span id="1-4377">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-4378">                <span class="n">is_orphan</span>
</span><span id="1-4379">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_persistent_orphan</span>
</span><span id="1-4380">                <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">_orphaned_outside_of_session</span>
</span><span id="1-4381">            <span class="p">):</span>
</span><span id="1-4382">                <span class="bp">self</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">])</span>
</span><span id="1-4383">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-4384">                <span class="n">_reg</span> <span class="o">=</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">register_object</span><span class="p">(</span>
</span><span id="1-4385">                    <span class="n">state</span><span class="p">,</span> <span class="n">isdelete</span><span class="o">=</span><span class="n">is_persistent_orphan</span>
</span><span id="1-4386">                <span class="p">)</span>
</span><span id="1-4387">                <span class="k">assert</span> <span class="n">_reg</span><span class="p">,</span> <span class="s2">&quot;Failed to add object to the flush context!&quot;</span>
</span><span id="1-4388">                <span class="n">processed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-4389">
</span><span id="1-4390">        <span class="c1"># put all remaining deletes into the flush context.</span>
</span><span id="1-4391">        <span class="k">if</span> <span class="n">objset</span><span class="p">:</span>
</span><span id="1-4392">            <span class="n">proc</span> <span class="o">=</span> <span class="n">deleted</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">objset</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</span><span id="1-4393">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4394">            <span class="n">proc</span> <span class="o">=</span> <span class="n">deleted</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
</span><span id="1-4395">        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">:</span>
</span><span id="1-4396">            <span class="n">_reg</span> <span class="o">=</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">register_object</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">isdelete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-4397">            <span class="k">assert</span> <span class="n">_reg</span><span class="p">,</span> <span class="s2">&quot;Failed to add object to the flush context!&quot;</span>
</span><span id="1-4398">
</span><span id="1-4399">        <span class="k">if</span> <span class="ow">not</span> <span class="n">flush_context</span><span class="o">.</span><span class="n">has_work</span><span class="p">:</span>
</span><span id="1-4400">            <span class="k">return</span>
</span><span id="1-4401">
</span><span id="1-4402">        <span class="n">flush_context</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
</span><span id="1-4403">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-4404">            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4405">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-4406">                <span class="n">flush_context</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="1-4407">            <span class="k">finally</span><span class="p">:</span>
</span><span id="1-4408">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_on_events</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-4409">
</span><span id="1-4410">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">)</span>
</span><span id="1-4411">
</span><span id="1-4412">            <span class="n">flush_context</span><span class="o">.</span><span class="n">finalize_flush_changes</span><span class="p">()</span>
</span><span id="1-4413">
</span><span id="1-4414">            <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">:</span>
</span><span id="1-4415">                <span class="n">len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span><span class="p">)</span>
</span><span id="1-4416">
</span><span id="1-4417">                <span class="n">statelib</span><span class="o">.</span><span class="n">InstanceState</span><span class="o">.</span><span class="n">_commit_all_states</span><span class="p">(</span>
</span><span id="1-4418">                    <span class="p">[</span>
</span><span id="1-4419">                        <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span id="1-4420">                        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_modified</span>
</span><span id="1-4421">                    <span class="p">],</span>
</span><span id="1-4422">                    <span class="n">instance_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="p">,</span>
</span><span id="1-4423">                <span class="p">)</span>
</span><span id="1-4424">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-4425">                    <span class="s2">&quot;Attribute history events accumulated on </span><span class="si">%d</span><span class="s2"> &quot;</span>
</span><span id="1-4426">                    <span class="s2">&quot;previously clean instances &quot;</span>
</span><span id="1-4427">                    <span class="s2">&quot;within inner-flush event handlers have been &quot;</span>
</span><span id="1-4428">                    <span class="s2">&quot;reset, and will not result in database updates. &quot;</span>
</span><span id="1-4429">                    <span class="s2">&quot;Consider using set_committed_value() within &quot;</span>
</span><span id="1-4430">                    <span class="s2">&quot;inner-flush event handlers to avoid this warning.&quot;</span> <span class="o">%</span> <span class="n">len_</span>
</span><span id="1-4431">                <span class="p">)</span>
</span><span id="1-4432">
</span><span id="1-4433">            <span class="c1"># useful assertions:</span>
</span><span id="1-4434">            <span class="c1"># if not objects:</span>
</span><span id="1-4435">            <span class="c1">#    assert not self.identity_map._modified</span>
</span><span id="1-4436">            <span class="c1"># else:</span>
</span><span id="1-4437">            <span class="c1">#    assert self.identity_map._modified == \</span>
</span><span id="1-4438">            <span class="c1">#            self.identity_map._modified.difference(objects)</span>
</span><span id="1-4439">
</span><span id="1-4440">            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_flush_postexec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush_context</span><span class="p">)</span>
</span><span id="1-4441">
</span><span id="1-4442">            <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="1-4443">
</span><span id="1-4444">        <span class="k">except</span><span class="p">:</span>
</span><span id="1-4445">            <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span id="1-4446">                <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_capture_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-4447">
</span><span id="1-4448">    <span class="k">def</span> <span class="nf">bulk_save_objects</span><span class="p">(</span>
</span><span id="1-4449">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-4450">        <span class="n">objects</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span>
</span><span id="1-4451">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4452">        <span class="n">update_changed_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-4453">        <span class="n">preserve_order</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-4454">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4455"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk save of the given list of objects.</span>
</span><span id="1-4456">
</span><span id="1-4457"><span class="sd">        .. legacy::</span>
</span><span id="1-4458">
</span><span id="1-4459"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span id="1-4460"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span id="1-4461"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span id="1-4462"><span class="sd">            :ref:`orm_queryguide_bulk_update`.</span>
</span><span id="1-4463">
</span><span id="1-4464"><span class="sd">            For general INSERT and UPDATE of existing ORM mapped objects,</span>
</span><span id="1-4465"><span class="sd">            prefer standard :term:`unit of work` data management patterns,</span>
</span><span id="1-4466"><span class="sd">            introduced in the :ref:`unified_tutorial` at</span>
</span><span id="1-4467"><span class="sd">            :ref:`tutorial_orm_data_manipulation`.  SQLAlchemy 2.0</span>
</span><span id="1-4468"><span class="sd">            now uses :ref:`engine_insertmanyvalues` with modern dialects</span>
</span><span id="1-4469"><span class="sd">            which solves previous issues of bulk INSERT slowness.</span>
</span><span id="1-4470">
</span><span id="1-4471"><span class="sd">        :param objects: a sequence of mapped object instances.  The mapped</span>
</span><span id="1-4472"><span class="sd">         objects are persisted as is, and are **not** associated with the</span>
</span><span id="1-4473"><span class="sd">         :class:`.Session` afterwards.</span>
</span><span id="1-4474">
</span><span id="1-4475"><span class="sd">         For each object, whether the object is sent as an INSERT or an</span>
</span><span id="1-4476"><span class="sd">         UPDATE is dependent on the same rules used by the :class:`.Session`</span>
</span><span id="1-4477"><span class="sd">         in traditional operation; if the object has the</span>
</span><span id="1-4478"><span class="sd">         :attr:`.InstanceState.key`</span>
</span><span id="1-4479"><span class="sd">         attribute set, then the object is assumed to be &quot;detached&quot; and</span>
</span><span id="1-4480"><span class="sd">         will result in an UPDATE.  Otherwise, an INSERT is used.</span>
</span><span id="1-4481">
</span><span id="1-4482"><span class="sd">         In the case of an UPDATE, statements are grouped based on which</span>
</span><span id="1-4483"><span class="sd">         attributes have changed, and are thus to be the subject of each</span>
</span><span id="1-4484"><span class="sd">         SET clause.  If ``update_changed_only`` is False, then all</span>
</span><span id="1-4485"><span class="sd">         attributes present within each object are applied to the UPDATE</span>
</span><span id="1-4486"><span class="sd">         statement, which may help in allowing the statements to be grouped</span>
</span><span id="1-4487"><span class="sd">         together into a larger executemany(), and will also reduce the</span>
</span><span id="1-4488"><span class="sd">         overhead of checking history on attributes.</span>
</span><span id="1-4489">
</span><span id="1-4490"><span class="sd">        :param return_defaults: when True, rows that are missing values which</span>
</span><span id="1-4491"><span class="sd">         generate defaults, namely integer primary key defaults and sequences,</span>
</span><span id="1-4492"><span class="sd">         will be inserted **one at a time**, so that the primary key value</span>
</span><span id="1-4493"><span class="sd">         is available.  In particular this will allow joined-inheritance</span>
</span><span id="1-4494"><span class="sd">         and other multi-table mappings to insert correctly without the need</span>
</span><span id="1-4495"><span class="sd">         to provide primary key values ahead of time; however,</span>
</span><span id="1-4496"><span class="sd">         :paramref:`.Session.bulk_save_objects.return_defaults` **greatly</span>
</span><span id="1-4497"><span class="sd">         reduces the performance gains** of the method overall.  It is strongly</span>
</span><span id="1-4498"><span class="sd">         advised to please use the standard :meth:`_orm.Session.add_all`</span>
</span><span id="1-4499"><span class="sd">         approach.</span>
</span><span id="1-4500">
</span><span id="1-4501"><span class="sd">        :param update_changed_only: when True, UPDATE statements are rendered</span>
</span><span id="1-4502"><span class="sd">         based on those attributes in each state that have logged changes.</span>
</span><span id="1-4503"><span class="sd">         When False, all attributes present are rendered into the SET clause</span>
</span><span id="1-4504"><span class="sd">         with the exception of primary key attributes.</span>
</span><span id="1-4505">
</span><span id="1-4506"><span class="sd">        :param preserve_order: when True, the order of inserts and updates</span>
</span><span id="1-4507"><span class="sd">         matches exactly the order in which the objects are given.   When</span>
</span><span id="1-4508"><span class="sd">         False, common types of objects are grouped into inserts</span>
</span><span id="1-4509"><span class="sd">         and updates, to allow for more batching opportunities.</span>
</span><span id="1-4510">
</span><span id="1-4511"><span class="sd">        .. seealso::</span>
</span><span id="1-4512">
</span><span id="1-4513"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span id="1-4514">
</span><span id="1-4515"><span class="sd">            :meth:`.Session.bulk_insert_mappings`</span>
</span><span id="1-4516">
</span><span id="1-4517"><span class="sd">            :meth:`.Session.bulk_update_mappings`</span>
</span><span id="1-4518">
</span><span id="1-4519"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4520">
</span><span id="1-4521">        <span class="n">obj_states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-4522">
</span><span id="1-4523">        <span class="n">obj_states</span> <span class="o">=</span> <span class="p">(</span><span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">)</span>
</span><span id="1-4524">
</span><span id="1-4525">        <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_order</span><span class="p">:</span>
</span><span id="1-4526">            <span class="c1"># the purpose of this sort is just so that common mappers</span>
</span><span id="1-4527">            <span class="c1"># and persistence states are grouped together, so that groupby</span>
</span><span id="1-4528">            <span class="c1"># will return a single group for a particular type of mapper.</span>
</span><span id="1-4529">            <span class="c1"># it&#39;s not trying to be deterministic beyond that.</span>
</span><span id="1-4530">            <span class="n">obj_states</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="1-4531">                <span class="n">obj_states</span><span class="p">,</span>
</span><span id="1-4532">                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
</span><span id="1-4533">            <span class="p">)</span>
</span><span id="1-4534">
</span><span id="1-4535">        <span class="k">def</span> <span class="nf">grouping_key</span><span class="p">(</span>
</span><span id="1-4536">            <span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-4537">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span id="1-4538">            <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-4539">
</span><span id="1-4540">        <span class="k">for</span> <span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">isupdate</span><span class="p">),</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
</span><span id="1-4541">            <span class="n">obj_states</span><span class="p">,</span> <span class="n">grouping_key</span>
</span><span id="1-4542">        <span class="p">):</span>
</span><span id="1-4543">            <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span id="1-4544">                <span class="n">mapper</span><span class="p">,</span>
</span><span id="1-4545">                <span class="n">states</span><span class="p">,</span>
</span><span id="1-4546">                <span class="n">isupdate</span><span class="p">,</span>
</span><span id="1-4547">                <span class="kc">True</span><span class="p">,</span>
</span><span id="1-4548">                <span class="n">return_defaults</span><span class="p">,</span>
</span><span id="1-4549">                <span class="n">update_changed_only</span><span class="p">,</span>
</span><span id="1-4550">                <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4551">            <span class="p">)</span>
</span><span id="1-4552">
</span><span id="1-4553">    <span class="k">def</span> <span class="nf">bulk_insert_mappings</span><span class="p">(</span>
</span><span id="1-4554">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-4555">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-4556">        <span class="n">mappings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
</span><span id="1-4557">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4558">        <span class="n">render_nulls</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4559">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4560"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk insert of the given list of mapping dictionaries.</span>
</span><span id="1-4561">
</span><span id="1-4562"><span class="sd">        .. legacy::</span>
</span><span id="1-4563">
</span><span id="1-4564"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span id="1-4565"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span id="1-4566"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span id="1-4567"><span class="sd">            :ref:`orm_queryguide_bulk_update`.  The 2.0 API shares</span>
</span><span id="1-4568"><span class="sd">            implementation details with this method and adds new features</span>
</span><span id="1-4569"><span class="sd">            as well.</span>
</span><span id="1-4570">
</span><span id="1-4571"><span class="sd">        :param mapper: a mapped class, or the actual :class:`_orm.Mapper`</span>
</span><span id="1-4572"><span class="sd">         object,</span>
</span><span id="1-4573"><span class="sd">         representing the single kind of object represented within the mapping</span>
</span><span id="1-4574"><span class="sd">         list.</span>
</span><span id="1-4575">
</span><span id="1-4576"><span class="sd">        :param mappings: a sequence of dictionaries, each one containing the</span>
</span><span id="1-4577"><span class="sd">         state of the mapped row to be inserted, in terms of the attribute</span>
</span><span id="1-4578"><span class="sd">         names on the mapped class.   If the mapping refers to multiple tables,</span>
</span><span id="1-4579"><span class="sd">         such as a joined-inheritance mapping, each dictionary must contain all</span>
</span><span id="1-4580"><span class="sd">         keys to be populated into all tables.</span>
</span><span id="1-4581">
</span><span id="1-4582"><span class="sd">        :param return_defaults: when True, the INSERT process will be altered</span>
</span><span id="1-4583"><span class="sd">         to ensure that newly generated primary key values will be fetched.</span>
</span><span id="1-4584"><span class="sd">         The rationale for this parameter is typically to enable</span>
</span><span id="1-4585"><span class="sd">         :ref:`Joined Table Inheritance &lt;joined_inheritance&gt;` mappings to</span>
</span><span id="1-4586"><span class="sd">         be bulk inserted.</span>
</span><span id="1-4587">
</span><span id="1-4588"><span class="sd">         .. note:: for backends that don&#39;t support RETURNING, the</span>
</span><span id="1-4589"><span class="sd">            :paramref:`_orm.Session.bulk_insert_mappings.return_defaults`</span>
</span><span id="1-4590"><span class="sd">            parameter can significantly decrease performance as INSERT</span>
</span><span id="1-4591"><span class="sd">            statements can no longer be batched.   See</span>
</span><span id="1-4592"><span class="sd">            :ref:`engine_insertmanyvalues`</span>
</span><span id="1-4593"><span class="sd">            for background on which backends are affected.</span>
</span><span id="1-4594">
</span><span id="1-4595"><span class="sd">        :param render_nulls: When True, a value of ``None`` will result</span>
</span><span id="1-4596"><span class="sd">         in a NULL value being included in the INSERT statement, rather</span>
</span><span id="1-4597"><span class="sd">         than the column being omitted from the INSERT.   This allows all</span>
</span><span id="1-4598"><span class="sd">         the rows being INSERTed to have the identical set of columns which</span>
</span><span id="1-4599"><span class="sd">         allows the full set of rows to be batched to the DBAPI.  Normally,</span>
</span><span id="1-4600"><span class="sd">         each column-set that contains a different combination of NULL values</span>
</span><span id="1-4601"><span class="sd">         than the previous row must omit a different series of columns from</span>
</span><span id="1-4602"><span class="sd">         the rendered INSERT statement, which means it must be emitted as a</span>
</span><span id="1-4603"><span class="sd">         separate statement.   By passing this flag, the full set of rows</span>
</span><span id="1-4604"><span class="sd">         are guaranteed to be batchable into one batch; the cost however is</span>
</span><span id="1-4605"><span class="sd">         that server-side defaults which are invoked by an omitted column will</span>
</span><span id="1-4606"><span class="sd">         be skipped, so care must be taken to ensure that these are not</span>
</span><span id="1-4607"><span class="sd">         necessary.</span>
</span><span id="1-4608">
</span><span id="1-4609"><span class="sd">         .. warning::</span>
</span><span id="1-4610">
</span><span id="1-4611"><span class="sd">            When this flag is set, **server side default SQL values will</span>
</span><span id="1-4612"><span class="sd">            not be invoked** for those columns that are inserted as NULL;</span>
</span><span id="1-4613"><span class="sd">            the NULL value will be sent explicitly.   Care must be taken</span>
</span><span id="1-4614"><span class="sd">            to ensure that no server-side default functions need to be</span>
</span><span id="1-4615"><span class="sd">            invoked for the operation as a whole.</span>
</span><span id="1-4616">
</span><span id="1-4617"><span class="sd">        .. seealso::</span>
</span><span id="1-4618">
</span><span id="1-4619"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span id="1-4620">
</span><span id="1-4621"><span class="sd">            :meth:`.Session.bulk_save_objects`</span>
</span><span id="1-4622">
</span><span id="1-4623"><span class="sd">            :meth:`.Session.bulk_update_mappings`</span>
</span><span id="1-4624">
</span><span id="1-4625"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4626">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span id="1-4627">            <span class="n">mapper</span><span class="p">,</span>
</span><span id="1-4628">            <span class="n">mappings</span><span class="p">,</span>
</span><span id="1-4629">            <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4630">            <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4631">            <span class="n">return_defaults</span><span class="p">,</span>
</span><span id="1-4632">            <span class="kc">False</span><span class="p">,</span>
</span><span id="1-4633">            <span class="n">render_nulls</span><span class="p">,</span>
</span><span id="1-4634">        <span class="p">)</span>
</span><span id="1-4635">
</span><span id="1-4636">    <span class="k">def</span> <span class="nf">bulk_update_mappings</span><span class="p">(</span>
</span><span id="1-4637">        <span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">mappings</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</span><span id="1-4638">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4639"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a bulk update of the given list of mapping dictionaries.</span>
</span><span id="1-4640">
</span><span id="1-4641"><span class="sd">        .. legacy::</span>
</span><span id="1-4642">
</span><span id="1-4643"><span class="sd">            This method is a legacy feature as of the 2.0 series of</span>
</span><span id="1-4644"><span class="sd">            SQLAlchemy.   For modern bulk INSERT and UPDATE, see</span>
</span><span id="1-4645"><span class="sd">            the sections :ref:`orm_queryguide_bulk_insert` and</span>
</span><span id="1-4646"><span class="sd">            :ref:`orm_queryguide_bulk_update`.  The 2.0 API shares</span>
</span><span id="1-4647"><span class="sd">            implementation details with this method and adds new features</span>
</span><span id="1-4648"><span class="sd">            as well.</span>
</span><span id="1-4649">
</span><span id="1-4650"><span class="sd">        :param mapper: a mapped class, or the actual :class:`_orm.Mapper`</span>
</span><span id="1-4651"><span class="sd">         object,</span>
</span><span id="1-4652"><span class="sd">         representing the single kind of object represented within the mapping</span>
</span><span id="1-4653"><span class="sd">         list.</span>
</span><span id="1-4654">
</span><span id="1-4655"><span class="sd">        :param mappings: a sequence of dictionaries, each one containing the</span>
</span><span id="1-4656"><span class="sd">         state of the mapped row to be updated, in terms of the attribute names</span>
</span><span id="1-4657"><span class="sd">         on the mapped class.   If the mapping refers to multiple tables, such</span>
</span><span id="1-4658"><span class="sd">         as a joined-inheritance mapping, each dictionary may contain keys</span>
</span><span id="1-4659"><span class="sd">         corresponding to all tables.   All those keys which are present and</span>
</span><span id="1-4660"><span class="sd">         are not part of the primary key are applied to the SET clause of the</span>
</span><span id="1-4661"><span class="sd">         UPDATE statement; the primary key values, which are required, are</span>
</span><span id="1-4662"><span class="sd">         applied to the WHERE clause.</span>
</span><span id="1-4663">
</span><span id="1-4664">
</span><span id="1-4665"><span class="sd">        .. seealso::</span>
</span><span id="1-4666">
</span><span id="1-4667"><span class="sd">            :doc:`queryguide/dml`</span>
</span><span id="1-4668">
</span><span id="1-4669"><span class="sd">            :meth:`.Session.bulk_insert_mappings`</span>
</span><span id="1-4670">
</span><span id="1-4671"><span class="sd">            :meth:`.Session.bulk_save_objects`</span>
</span><span id="1-4672">
</span><span id="1-4673"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4674">        <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_save_mappings</span><span class="p">(</span>
</span><span id="1-4675">            <span class="n">mapper</span><span class="p">,</span> <span class="n">mappings</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="1-4676">        <span class="p">)</span>
</span><span id="1-4677">
</span><span id="1-4678">    <span class="k">def</span> <span class="nf">_bulk_save_mappings</span><span class="p">(</span>
</span><span id="1-4679">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-4680">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-4681">        <span class="n">mappings</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
</span><span id="1-4682">        <span class="n">isupdate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-4683">        <span class="n">isstates</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-4684">        <span class="n">return_defaults</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-4685">        <span class="n">update_changed_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-4686">        <span class="n">render_nulls</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-4687">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-4688">        <span class="n">mapper</span> <span class="o">=</span> <span class="n">_class_to_mapper</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
</span><span id="1-4689">        <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4690">
</span><span id="1-4691">        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin_t</span><span class="p">()</span><span class="o">.</span><span class="n">_begin</span><span class="p">()</span>
</span><span id="1-4692">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-4693">            <span class="k">if</span> <span class="n">isupdate</span><span class="p">:</span>
</span><span id="1-4694">                <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">_bulk_update</span><span class="p">(</span>
</span><span id="1-4695">                    <span class="n">mapper</span><span class="p">,</span>
</span><span id="1-4696">                    <span class="n">mappings</span><span class="p">,</span>
</span><span id="1-4697">                    <span class="n">transaction</span><span class="p">,</span>
</span><span id="1-4698">                    <span class="n">isstates</span><span class="p">,</span>
</span><span id="1-4699">                    <span class="n">update_changed_only</span><span class="p">,</span>
</span><span id="1-4700">                <span class="p">)</span>
</span><span id="1-4701">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-4702">                <span class="n">bulk_persistence</span><span class="o">.</span><span class="n">_bulk_insert</span><span class="p">(</span>
</span><span id="1-4703">                    <span class="n">mapper</span><span class="p">,</span>
</span><span id="1-4704">                    <span class="n">mappings</span><span class="p">,</span>
</span><span id="1-4705">                    <span class="n">transaction</span><span class="p">,</span>
</span><span id="1-4706">                    <span class="n">isstates</span><span class="p">,</span>
</span><span id="1-4707">                    <span class="n">return_defaults</span><span class="p">,</span>
</span><span id="1-4708">                    <span class="n">render_nulls</span><span class="p">,</span>
</span><span id="1-4709">                <span class="p">)</span>
</span><span id="1-4710">            <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="1-4711">
</span><span id="1-4712">        <span class="k">except</span><span class="p">:</span>
</span><span id="1-4713">            <span class="k">with</span> <span class="n">util</span><span class="o">.</span><span class="n">safe_reraise</span><span class="p">():</span>
</span><span id="1-4714">                <span class="n">transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="n">_capture_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-4715">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-4716">            <span class="bp">self</span><span class="o">.</span><span class="n">_flushing</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-4717">
</span><span id="1-4718">    <span class="k">def</span> <span class="nf">is_modified</span><span class="p">(</span>
</span><span id="1-4719">        <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">include_collections</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-4720">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4721"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return ``True`` if the given instance has locally</span>
</span><span id="1-4722"><span class="sd">        modified attributes.</span>
</span><span id="1-4723">
</span><span id="1-4724"><span class="sd">        This method retrieves the history for each instrumented</span>
</span><span id="1-4725"><span class="sd">        attribute on the instance and performs a comparison of the current</span>
</span><span id="1-4726"><span class="sd">        value to its previously committed value, if any.</span>
</span><span id="1-4727">
</span><span id="1-4728"><span class="sd">        It is in effect a more expensive and accurate</span>
</span><span id="1-4729"><span class="sd">        version of checking for the given instance in the</span>
</span><span id="1-4730"><span class="sd">        :attr:`.Session.dirty` collection; a full test for</span>
</span><span id="1-4731"><span class="sd">        each attribute&#39;s net &quot;dirty&quot; status is performed.</span>
</span><span id="1-4732">
</span><span id="1-4733"><span class="sd">        E.g.::</span>
</span><span id="1-4734">
</span><span id="1-4735"><span class="sd">            return session.is_modified(someobject)</span>
</span><span id="1-4736">
</span><span id="1-4737"><span class="sd">        A few caveats to this method apply:</span>
</span><span id="1-4738">
</span><span id="1-4739"><span class="sd">        * Instances present in the :attr:`.Session.dirty` collection may</span>
</span><span id="1-4740"><span class="sd">          report ``False`` when tested with this method.  This is because</span>
</span><span id="1-4741"><span class="sd">          the object may have received change events via attribute mutation,</span>
</span><span id="1-4742"><span class="sd">          thus placing it in :attr:`.Session.dirty`, but ultimately the state</span>
</span><span id="1-4743"><span class="sd">          is the same as that loaded from the database, resulting in no net</span>
</span><span id="1-4744"><span class="sd">          change here.</span>
</span><span id="1-4745"><span class="sd">        * Scalar attributes may not have recorded the previously set</span>
</span><span id="1-4746"><span class="sd">          value when a new value was applied, if the attribute was not loaded,</span>
</span><span id="1-4747"><span class="sd">          or was expired, at the time the new value was received - in these</span>
</span><span id="1-4748"><span class="sd">          cases, the attribute is assumed to have a change, even if there is</span>
</span><span id="1-4749"><span class="sd">          ultimately no net change against its database value. SQLAlchemy in</span>
</span><span id="1-4750"><span class="sd">          most cases does not need the &quot;old&quot; value when a set event occurs, so</span>
</span><span id="1-4751"><span class="sd">          it skips the expense of a SQL call if the old value isn&#39;t present,</span>
</span><span id="1-4752"><span class="sd">          based on the assumption that an UPDATE of the scalar value is</span>
</span><span id="1-4753"><span class="sd">          usually needed, and in those few cases where it isn&#39;t, is less</span>
</span><span id="1-4754"><span class="sd">          expensive on average than issuing a defensive SELECT.</span>
</span><span id="1-4755">
</span><span id="1-4756"><span class="sd">          The &quot;old&quot; value is fetched unconditionally upon set only if the</span>
</span><span id="1-4757"><span class="sd">          attribute container has the ``active_history`` flag set to ``True``.</span>
</span><span id="1-4758"><span class="sd">          This flag is set typically for primary key attributes and scalar</span>
</span><span id="1-4759"><span class="sd">          object references that are not a simple many-to-one.  To set this</span>
</span><span id="1-4760"><span class="sd">          flag for any arbitrary mapped column, use the ``active_history``</span>
</span><span id="1-4761"><span class="sd">          argument with :func:`.column_property`.</span>
</span><span id="1-4762">
</span><span id="1-4763"><span class="sd">        :param instance: mapped instance to be tested for pending changes.</span>
</span><span id="1-4764"><span class="sd">        :param include_collections: Indicates if multivalued collections</span>
</span><span id="1-4765"><span class="sd">         should be included in the operation.  Setting this to ``False`` is a</span>
</span><span id="1-4766"><span class="sd">         way to detect only local-column based properties (i.e. scalar columns</span>
</span><span id="1-4767"><span class="sd">         or many-to-one foreign keys) that would result in an UPDATE for this</span>
</span><span id="1-4768"><span class="sd">         instance upon flush.</span>
</span><span id="1-4769">
</span><span id="1-4770"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4771">        <span class="n">state</span> <span class="o">=</span> <span class="n">object_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-4772">
</span><span id="1-4773">        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
</span><span id="1-4774">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-4775">
</span><span id="1-4776">        <span class="n">dict_</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dict</span>
</span><span id="1-4777">
</span><span id="1-4778">        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
</span><span id="1-4779">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-4780">                <span class="ow">not</span> <span class="n">include_collections</span>
</span><span id="1-4781">                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="s2">&quot;get_collection&quot;</span><span class="p">)</span>
</span><span id="1-4782">            <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="p">,</span> <span class="s2">&quot;get_history&quot;</span><span class="p">):</span>
</span><span id="1-4783">                <span class="k">continue</span>
</span><span id="1-4784">
</span><span id="1-4785">            <span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="n">unchanged</span><span class="p">,</span> <span class="n">deleted</span><span class="p">)</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">get_history</span><span class="p">(</span>
</span><span id="1-4786">                <span class="n">state</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">passive</span><span class="o">=</span><span class="n">PassiveFlag</span><span class="o">.</span><span class="n">NO_CHANGE</span>
</span><span id="1-4787">            <span class="p">)</span>
</span><span id="1-4788">
</span><span id="1-4789">            <span class="k">if</span> <span class="n">added</span> <span class="ow">or</span> <span class="n">deleted</span><span class="p">:</span>
</span><span id="1-4790">                <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-4791">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-4792">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-4793">
</span><span id="1-4794">    <span class="nd">@property</span>
</span><span id="1-4795">    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-4796"><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if this :class:`.Session` not in &quot;partial rollback&quot; state.</span>
</span><span id="1-4797">
</span><span id="1-4798"><span class="sd">        .. versionchanged:: 1.4 The :class:`_orm.Session` no longer begins</span>
</span><span id="1-4799"><span class="sd">           a new transaction immediately, so this attribute will be False</span>
</span><span id="1-4800"><span class="sd">           when the :class:`_orm.Session` is first instantiated.</span>
</span><span id="1-4801">
</span><span id="1-4802"><span class="sd">        &quot;partial rollback&quot; state typically indicates that the flush process</span>
</span><span id="1-4803"><span class="sd">        of the :class:`_orm.Session` has failed, and that the</span>
</span><span id="1-4804"><span class="sd">        :meth:`_orm.Session.rollback` method must be emitted in order to</span>
</span><span id="1-4805"><span class="sd">        fully roll back the transaction.</span>
</span><span id="1-4806">
</span><span id="1-4807"><span class="sd">        If this :class:`_orm.Session` is not in a transaction at all, the</span>
</span><span id="1-4808"><span class="sd">        :class:`_orm.Session` will autobegin when it is first used, so in this</span>
</span><span id="1-4809"><span class="sd">        case :attr:`_orm.Session.is_active` will return True.</span>
</span><span id="1-4810">
</span><span id="1-4811"><span class="sd">        Otherwise, if this :class:`_orm.Session` is within a transaction,</span>
</span><span id="1-4812"><span class="sd">        and that transaction has not been rolled back internally, the</span>
</span><span id="1-4813"><span class="sd">        :attr:`_orm.Session.is_active` will also return True.</span>
</span><span id="1-4814">
</span><span id="1-4815"><span class="sd">        .. seealso::</span>
</span><span id="1-4816">
</span><span id="1-4817"><span class="sd">            :ref:`faq_session_rollback`</span>
</span><span id="1-4818">
</span><span id="1-4819"><span class="sd">            :meth:`_orm.Session.in_transaction`</span>
</span><span id="1-4820">
</span><span id="1-4821"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4822">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span>
</span><span id="1-4823">
</span><span id="1-4824">    <span class="nd">@property</span>
</span><span id="1-4825">    <span class="k">def</span> <span class="nf">_dirty_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-4826"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of all persistent states considered dirty.</span>
</span><span id="1-4827">
</span><span id="1-4828"><span class="sd">        This method returns all states that were modified including</span>
</span><span id="1-4829"><span class="sd">        those that were possibly deleted.</span>
</span><span id="1-4830">
</span><span id="1-4831"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4832">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_map</span><span class="o">.</span><span class="n">_dirty_states</span><span class="p">()</span>
</span><span id="1-4833">
</span><span id="1-4834">    <span class="nd">@property</span>
</span><span id="1-4835">    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span id="1-4836"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The set of all persistent instances considered dirty.</span>
</span><span id="1-4837">
</span><span id="1-4838"><span class="sd">        E.g.::</span>
</span><span id="1-4839">
</span><span id="1-4840"><span class="sd">            some_mapped_object in session.dirty</span>
</span><span id="1-4841">
</span><span id="1-4842"><span class="sd">        Instances are considered dirty when they were modified but not</span>
</span><span id="1-4843"><span class="sd">        deleted.</span>
</span><span id="1-4844">
</span><span id="1-4845"><span class="sd">        Note that this &#39;dirty&#39; calculation is &#39;optimistic&#39;; most</span>
</span><span id="1-4846"><span class="sd">        attribute-setting or collection modification operations will</span>
</span><span id="1-4847"><span class="sd">        mark an instance as &#39;dirty&#39; and place it in this set, even if</span>
</span><span id="1-4848"><span class="sd">        there is no net change to the attribute&#39;s value.  At flush</span>
</span><span id="1-4849"><span class="sd">        time, the value of each attribute is compared to its</span>
</span><span id="1-4850"><span class="sd">        previously saved value, and if there&#39;s no net change, no SQL</span>
</span><span id="1-4851"><span class="sd">        operation will occur (this is a more expensive operation so</span>
</span><span id="1-4852"><span class="sd">        it&#39;s only done at flush time).</span>
</span><span id="1-4853">
</span><span id="1-4854"><span class="sd">        To check if an instance has actionable net changes to its</span>
</span><span id="1-4855"><span class="sd">        attributes, use the :meth:`.Session.is_modified` method.</span>
</span><span id="1-4856">
</span><span id="1-4857"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-4858">        <span class="k">return</span> <span class="n">IdentitySet</span><span class="p">(</span>
</span><span id="1-4859">            <span class="p">[</span>
</span><span id="1-4860">                <span class="n">state</span><span class="o">.</span><span class="n">obj</span><span class="p">()</span>
</span><span id="1-4861">                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_states</span>
</span><span id="1-4862">                <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-4863">            <span class="p">]</span>
</span><span id="1-4864">        <span class="p">)</span>
</span><span id="1-4865">
</span><span id="1-4866">    <span class="nd">@property</span>
</span><span id="1-4867">    <span class="k">def</span> <span class="nf">deleted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span id="1-4868">        <span class="s2">&quot;The set of all instances marked as &#39;deleted&#39; within this ``Session``&quot;</span>
</span><span id="1-4869">
</span><span id="1-4870">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">IdentitySet</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deleted</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="1-4871">
</span><span id="1-4872">    <span class="nd">@property</span>
</span><span id="1-4873">    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IdentitySet</span><span class="p">:</span>
</span><span id="1-4874">        <span class="s2">&quot;The set of all instances marked as &#39;new&#39; within this ``Session``.&quot;</span>
</span><span id="1-4875">
</span><span id="1-4876">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">IdentitySet</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
</span><span id="1-4877">
</span><span id="1-4878">
</span><span id="1-4879"><span class="n">_S</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_S&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Session&quot;</span><span class="p">)</span>
</span><span id="1-4880">
</span><span id="1-4881">
</span><span id="1-4882"><span class="k">class</span> <span class="nc">sessionmaker</span><span class="p">(</span><span class="n">_SessionClassMethods</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">_S</span><span class="p">]):</span>
</span><span id="1-4883"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A configurable :class:`.Session` factory.</span>
</span><span id="1-4884">
</span><span id="1-4885"><span class="sd">    The :class:`.sessionmaker` factory generates new</span>
</span><span id="1-4886"><span class="sd">    :class:`.Session` objects when called, creating them given</span>
</span><span id="1-4887"><span class="sd">    the configurational arguments established here.</span>
</span><span id="1-4888">
</span><span id="1-4889"><span class="sd">    e.g.::</span>
</span><span id="1-4890">
</span><span id="1-4891"><span class="sd">        from sqlalchemy import create_engine</span>
</span><span id="1-4892"><span class="sd">        from sqlalchemy.orm import sessionmaker</span>
</span><span id="1-4893">
</span><span id="1-4894"><span class="sd">        # an Engine, which the Session will use for connection</span>
</span><span id="1-4895"><span class="sd">        # resources</span>
</span><span id="1-4896"><span class="sd">        engine = create_engine(&#39;postgresql+psycopg2://scott:tiger@localhost/&#39;)</span>
</span><span id="1-4897">
</span><span id="1-4898"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span id="1-4899">
</span><span id="1-4900"><span class="sd">        with Session() as session:</span>
</span><span id="1-4901"><span class="sd">            session.add(some_object)</span>
</span><span id="1-4902"><span class="sd">            session.add(some_other_object)</span>
</span><span id="1-4903"><span class="sd">            session.commit()</span>
</span><span id="1-4904">
</span><span id="1-4905"><span class="sd">    Context manager use is optional; otherwise, the returned</span>
</span><span id="1-4906"><span class="sd">    :class:`_orm.Session` object may be closed explicitly via the</span>
</span><span id="1-4907"><span class="sd">    :meth:`_orm.Session.close` method.   Using a</span>
</span><span id="1-4908"><span class="sd">    ``try:/finally:`` block is optional, however will ensure that the close</span>
</span><span id="1-4909"><span class="sd">    takes place even if there are database errors::</span>
</span><span id="1-4910">
</span><span id="1-4911"><span class="sd">        session = Session()</span>
</span><span id="1-4912"><span class="sd">        try:</span>
</span><span id="1-4913"><span class="sd">            session.add(some_object)</span>
</span><span id="1-4914"><span class="sd">            session.add(some_other_object)</span>
</span><span id="1-4915"><span class="sd">            session.commit()</span>
</span><span id="1-4916"><span class="sd">        finally:</span>
</span><span id="1-4917"><span class="sd">            session.close()</span>
</span><span id="1-4918">
</span><span id="1-4919"><span class="sd">    :class:`.sessionmaker` acts as a factory for :class:`_orm.Session`</span>
</span><span id="1-4920"><span class="sd">    objects in the same way as an :class:`_engine.Engine` acts as a factory</span>
</span><span id="1-4921"><span class="sd">    for :class:`_engine.Connection` objects.  In this way it also includes</span>
</span><span id="1-4922"><span class="sd">    a :meth:`_orm.sessionmaker.begin` method, that provides a context</span>
</span><span id="1-4923"><span class="sd">    manager which both begins and commits a transaction, as well as closes</span>
</span><span id="1-4924"><span class="sd">    out the :class:`_orm.Session` when complete, rolling back the transaction</span>
</span><span id="1-4925"><span class="sd">    if any errors occur::</span>
</span><span id="1-4926">
</span><span id="1-4927"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span id="1-4928">
</span><span id="1-4929"><span class="sd">        with Session.begin() as session:</span>
</span><span id="1-4930"><span class="sd">            session.add(some_object)</span>
</span><span id="1-4931"><span class="sd">            session.add(some_other_object)</span>
</span><span id="1-4932"><span class="sd">        # commits transaction, closes session</span>
</span><span id="1-4933">
</span><span id="1-4934"><span class="sd">    .. versionadded:: 1.4</span>
</span><span id="1-4935">
</span><span id="1-4936"><span class="sd">    When calling upon :class:`_orm.sessionmaker` to construct a</span>
</span><span id="1-4937"><span class="sd">    :class:`_orm.Session`, keyword arguments may also be passed to the</span>
</span><span id="1-4938"><span class="sd">    method; these arguments will override that of the globally configured</span>
</span><span id="1-4939"><span class="sd">    parameters.  Below we use a :class:`_orm.sessionmaker` bound to a certain</span>
</span><span id="1-4940"><span class="sd">    :class:`_engine.Engine` to produce a :class:`_orm.Session` that is instead</span>
</span><span id="1-4941"><span class="sd">    bound to a specific :class:`_engine.Connection` procured from that engine::</span>
</span><span id="1-4942">
</span><span id="1-4943"><span class="sd">        Session = sessionmaker(engine)</span>
</span><span id="1-4944">
</span><span id="1-4945"><span class="sd">        # bind an individual session to a connection</span>
</span><span id="1-4946">
</span><span id="1-4947"><span class="sd">        with engine.connect() as connection:</span>
</span><span id="1-4948"><span class="sd">            with Session(bind=connection) as session:</span>
</span><span id="1-4949"><span class="sd">                # work with session</span>
</span><span id="1-4950">
</span><span id="1-4951"><span class="sd">    The class also includes a method :meth:`_orm.sessionmaker.configure`, which</span>
</span><span id="1-4952"><span class="sd">    can be used to specify additional keyword arguments to the factory, which</span>
</span><span id="1-4953"><span class="sd">    will take effect for subsequent :class:`.Session` objects generated. This</span>
</span><span id="1-4954"><span class="sd">    is usually used to associate one or more :class:`_engine.Engine` objects</span>
</span><span id="1-4955"><span class="sd">    with an existing</span>
</span><span id="1-4956"><span class="sd">    :class:`.sessionmaker` factory before it is first used::</span>
</span><span id="1-4957">
</span><span id="1-4958"><span class="sd">        # application starts, sessionmaker does not have</span>
</span><span id="1-4959"><span class="sd">        # an engine bound yet</span>
</span><span id="1-4960"><span class="sd">        Session = sessionmaker()</span>
</span><span id="1-4961">
</span><span id="1-4962"><span class="sd">        # ... later, when an engine URL is read from a configuration</span>
</span><span id="1-4963"><span class="sd">        # file or other events allow the engine to be created</span>
</span><span id="1-4964"><span class="sd">        engine = create_engine(&#39;sqlite:///foo.db&#39;)</span>
</span><span id="1-4965"><span class="sd">        Session.configure(bind=engine)</span>
</span><span id="1-4966">
</span><span id="1-4967"><span class="sd">        sess = Session()</span>
</span><span id="1-4968"><span class="sd">        # work with session</span>
</span><span id="1-4969">
</span><span id="1-4970"><span class="sd">    .. seealso::</span>
</span><span id="1-4971">
</span><span id="1-4972"><span class="sd">        :ref:`session_getting` - introductory text on creating</span>
</span><span id="1-4973"><span class="sd">        sessions using :class:`.sessionmaker`.</span>
</span><span id="1-4974">
</span><span id="1-4975"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-4976">
</span><span id="1-4977">    <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">]</span>
</span><span id="1-4978">
</span><span id="1-4979">    <span class="nd">@overload</span>
</span><span id="1-4980">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-4981">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-4982">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4983">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-4984">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">],</span>
</span><span id="1-4985">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4986">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4987">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4988">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-4989">    <span class="p">):</span>
</span><span id="1-4990">        <span class="o">...</span>
</span><span id="1-4991">
</span><span id="1-4992">    <span class="nd">@overload</span>
</span><span id="1-4993">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-4994">        <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;sessionmaker[Session]&quot;</span><span class="p">,</span>
</span><span id="1-4995">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4996">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-4997">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4998">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-4999">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-5000">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-5001">    <span class="p">):</span>
</span><span id="1-5002">        <span class="o">...</span>
</span><span id="1-5003">
</span><span id="1-5004">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-5005">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-5006">        <span class="n">bind</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_SessionBind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-5007">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-5008">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_S</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
</span><span id="1-5009">        <span class="n">autoflush</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-5010">        <span class="n">expire_on_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-5011">        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_InfoType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-5012">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-5013">    <span class="p">):</span>
</span><span id="1-5014"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`.sessionmaker`.</span>
</span><span id="1-5015">
</span><span id="1-5016"><span class="sd">        All arguments here except for ``class_`` correspond to arguments</span>
</span><span id="1-5017"><span class="sd">        accepted by :class:`.Session` directly.  See the</span>
</span><span id="1-5018"><span class="sd">        :meth:`.Session.__init__` docstring for more details on parameters.</span>
</span><span id="1-5019">
</span><span id="1-5020"><span class="sd">        :param bind: a :class:`_engine.Engine` or other :class:`.Connectable`</span>
</span><span id="1-5021"><span class="sd">         with</span>
</span><span id="1-5022"><span class="sd">         which newly created :class:`.Session` objects will be associated.</span>
</span><span id="1-5023"><span class="sd">        :param class\_: class to use in order to create new :class:`.Session`</span>
</span><span id="1-5024"><span class="sd">         objects.  Defaults to :class:`.Session`.</span>
</span><span id="1-5025"><span class="sd">        :param autoflush: The autoflush setting to use with newly created</span>
</span><span id="1-5026"><span class="sd">         :class:`.Session` objects.</span>
</span><span id="1-5027">
</span><span id="1-5028"><span class="sd">         .. seealso::</span>
</span><span id="1-5029">
</span><span id="1-5030"><span class="sd">            :ref:`session_flushing` - additional background on autoflush</span>
</span><span id="1-5031">
</span><span id="1-5032"><span class="sd">        :param expire_on_commit=True: the</span>
</span><span id="1-5033"><span class="sd">         :paramref:`_orm.Session.expire_on_commit` setting to use</span>
</span><span id="1-5034"><span class="sd">         with newly created :class:`.Session` objects.</span>
</span><span id="1-5035">
</span><span id="1-5036"><span class="sd">        :param info: optional dictionary of information that will be available</span>
</span><span id="1-5037"><span class="sd">         via :attr:`.Session.info`.  Note this dictionary is *updated*, not</span>
</span><span id="1-5038"><span class="sd">         replaced, when the ``info`` parameter is specified to the specific</span>
</span><span id="1-5039"><span class="sd">         :class:`.Session` construction operation.</span>
</span><span id="1-5040">
</span><span id="1-5041"><span class="sd">        :param \**kw: all other keyword arguments are passed to the</span>
</span><span id="1-5042"><span class="sd">         constructor of newly created :class:`.Session` objects.</span>
</span><span id="1-5043">
</span><span id="1-5044"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-5045">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;bind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
</span><span id="1-5046">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;autoflush&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoflush</span>
</span><span id="1-5047">        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;expire_on_commit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire_on_commit</span>
</span><span id="1-5048">        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-5049">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
</span><span id="1-5050">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
</span><span id="1-5051">        <span class="c1"># make our own subclass of the given class, so that</span>
</span><span id="1-5052">        <span class="c1"># events can be associated with it specifically.</span>
</span><span id="1-5053">        <span class="bp">self</span><span class="o">.</span><span class="n">class_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">class_</span><span class="p">,),</span> <span class="p">{})</span>
</span><span id="1-5054">
</span><span id="1-5055">    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">AbstractContextManager</span><span class="p">[</span><span class="n">_S</span><span class="p">]:</span>
</span><span id="1-5056"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a context manager that both provides a new</span>
</span><span id="1-5057"><span class="sd">        :class:`_orm.Session` as well as a transaction that commits.</span>
</span><span id="1-5058">
</span><span id="1-5059">
</span><span id="1-5060"><span class="sd">        e.g.::</span>
</span><span id="1-5061">
</span><span id="1-5062"><span class="sd">            Session = sessionmaker(some_engine)</span>
</span><span id="1-5063">
</span><span id="1-5064"><span class="sd">            with Session.begin() as session:</span>
</span><span id="1-5065"><span class="sd">                session.add(some_object)</span>
</span><span id="1-5066">
</span><span id="1-5067"><span class="sd">            # commits transaction, closes session</span>
</span><span id="1-5068">
</span><span id="1-5069"><span class="sd">        .. versionadded:: 1.4</span>
</span><span id="1-5070">
</span><span id="1-5071">
</span><span id="1-5072"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-5073">
</span><span id="1-5074">        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="p">()</span>
</span><span id="1-5075">        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">_maker_context_manager</span><span class="p">()</span>
</span><span id="1-5076">
</span><span id="1-5077">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">local_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_S</span><span class="p">:</span>
</span><span id="1-5078"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a new :class:`.Session` object using the configuration</span>
</span><span id="1-5079"><span class="sd">        established in this :class:`.sessionmaker`.</span>
</span><span id="1-5080">
</span><span id="1-5081"><span class="sd">        In Python, the ``__call__`` method is invoked on an object when</span>
</span><span id="1-5082"><span class="sd">        it is &quot;called&quot; in the same way as a function::</span>
</span><span id="1-5083">
</span><span id="1-5084"><span class="sd">            Session = sessionmaker(some_engine)</span>
</span><span id="1-5085"><span class="sd">            session = Session()  # invokes sessionmaker.__call__()</span>
</span><span id="1-5086">
</span><span id="1-5087"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-5088">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-5089">            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span> <span class="ow">and</span> <span class="s2">&quot;info&quot;</span> <span class="ow">in</span> <span class="n">local_kw</span><span class="p">:</span>
</span><span id="1-5090">                <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="1-5091">                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">])</span>
</span><span id="1-5092">                <span class="n">local_kw</span><span class="p">[</span><span class="s2">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
</span><span id="1-5093">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-5094">                <span class="n">local_kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="1-5095">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="n">local_kw</span><span class="p">)</span>
</span><span id="1-5096">
</span><span id="1-5097">    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">new_kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-5098"><span class="w">        </span><span class="sd">&quot;&quot;&quot;(Re)configure the arguments for this sessionmaker.</span>
</span><span id="1-5099">
</span><span id="1-5100"><span class="sd">        e.g.::</span>
</span><span id="1-5101">
</span><span id="1-5102"><span class="sd">            Session = sessionmaker()</span>
</span><span id="1-5103">
</span><span id="1-5104"><span class="sd">            Session.configure(bind=create_engine(&#39;sqlite://&#39;))</span>
</span><span id="1-5105"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-5106">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_kw</span><span class="p">)</span>
</span><span id="1-5107">
</span><span id="1-5108">    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="1-5109">        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(class_=</span><span class="si">%r</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="1-5110">            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-5111">            <span class="bp">self</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="1-5112">            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
</span><span id="1-5113">        <span class="p">)</span>
</span><span id="1-5114">
</span><span id="1-5115">
</span><span id="1-5116"><span class="k">def</span> <span class="nf">close_all_sessions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-5117"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Close all sessions in memory.</span>
</span><span id="1-5118">
</span><span id="1-5119"><span class="sd">    This function consults a global registry of all :class:`.Session` objects</span>
</span><span id="1-5120"><span class="sd">    and calls :meth:`.Session.close` on them, which resets them to a clean</span>
</span><span id="1-5121"><span class="sd">    state.</span>
</span><span id="1-5122">
</span><span id="1-5123"><span class="sd">    This function is not for general use but may be useful for test suites</span>
</span><span id="1-5124"><span class="sd">    within the teardown scheme.</span>
</span><span id="1-5125">
</span><span id="1-5126"><span class="sd">    .. versionadded:: 1.3</span>
</span><span id="1-5127">
</span><span id="1-5128"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-5129">
</span><span id="1-5130">    <span class="k">for</span> <span class="n">sess</span> <span class="ow">in</span> <span class="n">_sessions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="1-5131">        <span class="n">sess</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-5132">
</span><span id="1-5133">
</span><span id="1-5134"><span class="k">def</span> <span class="nf">make_transient</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-5135"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Alter the state of the given instance so that it is :term:`transient`.</span>
</span><span id="1-5136">
</span><span id="1-5137"><span class="sd">    .. note::</span>
</span><span id="1-5138">
</span><span id="1-5139"><span class="sd">        :func:`.make_transient` is a special-case function for</span>
</span><span id="1-5140"><span class="sd">        advanced use cases only.</span>
</span><span id="1-5141">
</span><span id="1-5142"><span class="sd">    The given mapped instance is assumed to be in the :term:`persistent` or</span>
</span><span id="1-5143"><span class="sd">    :term:`detached` state.   The function will remove its association with any</span>
</span><span id="1-5144"><span class="sd">    :class:`.Session` as well as its :attr:`.InstanceState.identity`. The</span>
</span><span id="1-5145"><span class="sd">    effect is that the object will behave as though it were newly constructed,</span>
</span><span id="1-5146"><span class="sd">    except retaining any attribute / collection values that were loaded at the</span>
</span><span id="1-5147"><span class="sd">    time of the call.   The :attr:`.InstanceState.deleted` flag is also reset</span>
</span><span id="1-5148"><span class="sd">    if this object had been deleted as a result of using</span>
</span><span id="1-5149"><span class="sd">    :meth:`.Session.delete`.</span>
</span><span id="1-5150">
</span><span id="1-5151"><span class="sd">    .. warning::</span>
</span><span id="1-5152">
</span><span id="1-5153"><span class="sd">        :func:`.make_transient` does **not** &quot;unexpire&quot; or otherwise eagerly</span>
</span><span id="1-5154"><span class="sd">        load ORM-mapped attributes that are not currently loaded at the time</span>
</span><span id="1-5155"><span class="sd">        the function is called.   This includes attributes which:</span>
</span><span id="1-5156">
</span><span id="1-5157"><span class="sd">        * were expired via :meth:`.Session.expire`</span>
</span><span id="1-5158">
</span><span id="1-5159"><span class="sd">        * were expired as the natural effect of committing a session</span>
</span><span id="1-5160"><span class="sd">          transaction, e.g. :meth:`.Session.commit`</span>
</span><span id="1-5161">
</span><span id="1-5162"><span class="sd">        * are normally :term:`lazy loaded` but are not currently loaded</span>
</span><span id="1-5163">
</span><span id="1-5164"><span class="sd">        * are &quot;deferred&quot; (see :ref:`orm_queryguide_column_deferral`) and are</span>
</span><span id="1-5165"><span class="sd">          not yet loaded</span>
</span><span id="1-5166">
</span><span id="1-5167"><span class="sd">        * were not present in the query which loaded this object, such as that</span>
</span><span id="1-5168"><span class="sd">          which is common in joined table inheritance and other scenarios.</span>
</span><span id="1-5169">
</span><span id="1-5170"><span class="sd">        After :func:`.make_transient` is called, unloaded attributes such</span>
</span><span id="1-5171"><span class="sd">        as those above will normally resolve to the value ``None`` when</span>
</span><span id="1-5172"><span class="sd">        accessed, or an empty collection for a collection-oriented attribute.</span>
</span><span id="1-5173"><span class="sd">        As the object is transient and un-associated with any database</span>
</span><span id="1-5174"><span class="sd">        identity, it will no longer retrieve these values.</span>
</span><span id="1-5175">
</span><span id="1-5176"><span class="sd">    .. seealso::</span>
</span><span id="1-5177">
</span><span id="1-5178"><span class="sd">        :func:`.make_transient_to_detached`</span>
</span><span id="1-5179">
</span><span id="1-5180"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-5181">    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-5182">    <span class="n">s</span> <span class="o">=</span> <span class="n">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-5183">    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
</span><span id="1-5184">        <span class="n">s</span><span class="o">.</span><span class="n">_expunge_states</span><span class="p">([</span><span class="n">state</span><span class="p">])</span>
</span><span id="1-5185">
</span><span id="1-5186">    <span class="c1"># remove expired state</span>
</span><span id="1-5187">    <span class="n">state</span><span class="o">.</span><span class="n">expired_attributes</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="1-5188">
</span><span id="1-5189">    <span class="c1"># remove deferred callables</span>
</span><span id="1-5190">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span><span class="p">:</span>
</span><span id="1-5191">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">callables</span>
</span><span id="1-5192">
</span><span id="1-5193">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-5194">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-5195">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span id="1-5196">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-5197">
</span><span id="1-5198">
</span><span id="1-5199"><span class="k">def</span> <span class="nf">make_transient_to_detached</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-5200"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the given transient instance :term:`detached`.</span>
</span><span id="1-5201">
</span><span id="1-5202"><span class="sd">    .. note::</span>
</span><span id="1-5203">
</span><span id="1-5204"><span class="sd">        :func:`.make_transient_to_detached` is a special-case function for</span>
</span><span id="1-5205"><span class="sd">        advanced use cases only.</span>
</span><span id="1-5206">
</span><span id="1-5207"><span class="sd">    All attribute history on the given instance</span>
</span><span id="1-5208"><span class="sd">    will be reset as though the instance were freshly loaded</span>
</span><span id="1-5209"><span class="sd">    from a query.  Missing attributes will be marked as expired.</span>
</span><span id="1-5210"><span class="sd">    The primary key attributes of the object, which are required, will be made</span>
</span><span id="1-5211"><span class="sd">    into the &quot;key&quot; of the instance.</span>
</span><span id="1-5212">
</span><span id="1-5213"><span class="sd">    The object can then be added to a session, or merged</span>
</span><span id="1-5214"><span class="sd">    possibly with the load=False flag, at which point it will look</span>
</span><span id="1-5215"><span class="sd">    as if it were loaded that way, without emitting SQL.</span>
</span><span id="1-5216">
</span><span id="1-5217"><span class="sd">    This is a special use case function that differs from a normal</span>
</span><span id="1-5218"><span class="sd">    call to :meth:`.Session.merge` in that a given persistent state</span>
</span><span id="1-5219"><span class="sd">    can be manufactured without any SQL calls.</span>
</span><span id="1-5220">
</span><span id="1-5221"><span class="sd">    .. seealso::</span>
</span><span id="1-5222">
</span><span id="1-5223"><span class="sd">        :func:`.make_transient`</span>
</span><span id="1-5224">
</span><span id="1-5225"><span class="sd">        :meth:`.Session.enable_relationship_loading`</span>
</span><span id="1-5226">
</span><span id="1-5227"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-5228">    <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-5229">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">session_id</span> <span class="ow">or</span> <span class="n">state</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-5230">        <span class="k">raise</span> <span class="n">sa_exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;Given object must be transient&quot;</span><span class="p">)</span>
</span><span id="1-5231">    <span class="n">state</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_identity_key_from_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-5232">    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span><span class="p">:</span>
</span><span id="1-5233">        <span class="k">del</span> <span class="n">state</span><span class="o">.</span><span class="n">_deleted</span>
</span><span id="1-5234">    <span class="n">state</span><span class="o">.</span><span class="n">_commit_all</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">)</span>
</span><span id="1-5235">    <span class="n">state</span><span class="o">.</span><span class="n">_expire_attributes</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">dict</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">unloaded</span><span class="p">)</span>
</span><span id="1-5236">
</span><span id="1-5237">
</span><span id="1-5238"><span class="k">def</span> <span class="nf">object_session</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]:</span>
</span><span id="1-5239"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the :class:`.Session` to which the given instance belongs.</span>
</span><span id="1-5240">
</span><span id="1-5241"><span class="sd">    This is essentially the same as the :attr:`.InstanceState.session`</span>
</span><span id="1-5242"><span class="sd">    accessor.  See that attribute for details.</span>
</span><span id="1-5243">
</span><span id="1-5244"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-5245">
</span><span id="1-5246">    <span class="k">try</span><span class="p">:</span>
</span><span id="1-5247">        <span class="n">state</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">instance_state</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="1-5248">    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NO_STATE</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="1-5249">        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnmappedInstanceError</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="1-5250">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-5251">        <span class="k">return</span> <span class="n">_state_session</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="1-5252">
</span><span id="1-5253">
</span><span id="1-5254"><span class="n">_new_sessionid</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">counter</span><span class="p">()</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Jolt Org</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e43216b9"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=36754332"></script>
      <script src="../../../_static/shibuya.js?v=3e5c8598"></script>
    
</body>
</html>